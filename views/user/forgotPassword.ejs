<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reset Password | BagHub</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <script src="https://kit.fontawesome.com/a2e0da32f7.js" crossorigin="anonymous"></script>

    <style>
      :root {
        --primary: #1a56db;
        --primary-dark: #1e429f;
        --secondary: #047857;
        --accent: #f59e0b;
        --light: #f8fafc;
        --dark: #1e293b;
      }

      .gradient-bg {
        background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      }

      .btn-primary {
        background-color: var(--primary);
        transition: all 0.3s ease;
      }

      .btn-primary:hover {
        background-color: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      }

      .card-hover {
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      }

      .card-hover:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      }

      .input-focus:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(26, 86, 219, 0.1);
      }

      .error-shake {
        animation: shake 0.5s ease-in-out;
      }

      @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
      }

      .success-border {
        border-color: #10b981;
      }
    </style>
  </head>

  <body class="bg-gray-50 min-h-screen flex flex-col">
    <!-- Header -->
    <header class="sticky top-0 z-50 bg-white shadow-sm">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center py-4">
          <!-- Logo -->
          <div class="flex items-center">
            <a href="/" class="flex items-center space-x-2">
              <div class="w-10 h-10 rounded-full bg-gradient-to-r from-blue-600 to-emerald-600 flex items-center justify-center">
                <span class="text-white font-bold text-lg">BH</span>
              </div>
              <span class="text-xl font-bold text-gray-900">BagHub</span>
            </a>
          </div>
          
          <!-- Back to Home -->
          <a href="/" class="text-gray-700 hover:text-blue-600 font-medium transition-colors flex items-center">
            <i class="fas fa-arrow-left mr-2"></i>
            Back to Home
          </a>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
      <div class="max-w-md w-full space-y-8">
        <!-- Header Section -->
        <div class="text-center">
          <div class="mx-auto w-16 h-16 bg-gradient-to-r from-blue-500 to-emerald-500 rounded-full flex items-center justify-center mb-4">
            <i class="fas fa-lock text-white text-2xl"></i>
          </div>
          <h1 class="text-3xl font-bold text-gray-900 mb-2">Reset Your Password</h1>
          <p class="text-gray-600">Enter your email to receive a password reset link</p>
        </div>

        <!-- Forgot Password Card -->
        <div class="card-hover bg-white rounded-2xl shadow-xl p-8">
          <!-- Error Message -->
          <% if (typeof error !== "undefined" && error) { %>
            <div class="bg-red-50 border border-red-200 text-red-700 p-4 rounded-lg text-sm mb-6" role="alert">
              <div class="flex items-center">
                <i class="fas fa-exclamation-circle mr-2"></i>
                <span><%= error %></span>
              </div>
            </div>
          <% } %>

          <!-- Success Message -->
          <% if (typeof success !== "undefined" && success) { %>
            <div class="bg-green-50 border border-green-200 text-green-700 p-4 rounded-lg text-sm mb-6" role="alert">
              <div class="flex items-center">
                <i class="fas fa-check-circle mr-2"></i>
                <span><%= success %></span>
              </div>
            </div>
          <% } %>

          <!-- Info Message -->
          <div class="bg-blue-50 border border-blue-200 text-blue-700 p-4 rounded-lg text-sm mb-6">
            <div class="flex items-center">
              <i class="fas fa-info-circle mr-2"></i>
              <span>We'll send a 6-digit OTP to your registered email address</span>
            </div>
          </div>

          <!-- Forgot Password Form -->
          <form id="forgotForm" action="/user/forgotPassword" method="POST" class="space-y-6" novalidate>
            <!-- Email Field -->
            <div>
              <label for="email" class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
              <div class="relative">
                <input
                  id="email"
                  name="email"
                  type="email"
                  inputmode="email"
                  autocomplete="email"
                  placeholder="Enter your registered email"
                  required
                  aria-required="true"
                  aria-invalid="false"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg input-focus focus:outline-none transition duration-200 pr-10"
                />
                <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                  <i class="fas fa-envelope text-gray-400"></i>
                </div>
              </div>
              <p id="emailError" class="text-red-600 text-sm mt-2 hidden flex items-center" role="status">
                <i class="fas fa-exclamation-circle mr-1 text-xs"></i>
                <span id="emailErrorText">Please enter a valid email address.</span>
              </p>
              
              <!-- Email Validation Tips -->
              <div id="emailTips" class="mt-2 space-y-1 hidden">
                <p class="text-xs text-gray-600 flex items-center">
                  <i class="fas fa-check text-green-500 mr-1 text-xs"></i>
                  <span>Valid email format</span>
                </p>
                <p class="text-xs text-gray-600 flex items-center">
                  <i class="fas fa-check text-green-500 mr-1 text-xs"></i>
                  <span>Email domain is valid</span>
                </p>
              </div>
            </div>

            <!-- Submit Button -->
            <button
              type="submit"
              id="submitBtn"
              class="w-full btn-primary text-white py-3 px-4 rounded-lg font-semibold shadow-lg transition duration-200 flex items-center justify-center"
            >
              <i class="fas fa-paper-plane mr-2"></i>
              Send Reset OTP
            </button>
          </form>

          <!-- Back to Login -->
          <div class="mt-6 text-center">
            <p class="text-gray-600">
              Remember your password?
              <a href="/user/login" class="text-blue-600 hover:text-blue-500 font-medium transition">
                Back to Login
              </a>
            </p>
          </div>
        </div>

        <!-- Security Notice -->
        <div class="text-center text-sm text-gray-500 mt-6">
          <p class="flex items-center justify-center">
            <i class="fas fa-shield-alt mr-2 text-green-500"></i>
            Your email is secure and will only be used for password reset
          </p>
        </div>
      </div>
    </main>

       <!-- FOOTER -->
      <%- include('../partials/footer') %>

    <!-- Enhanced Validation Script -->
    <script>
      (function () {
        // DOM Elements
        const form = document.getElementById('forgotForm');
        const email = document.getElementById('email');
        const emailError = document.getElementById('emailError');
        const emailErrorText = document.getElementById('emailErrorText');
        const emailTips = document.getElementById('emailTips');
        const submitBtn = document.getElementById('submitBtn');
        const errorMessage = document.getElementById('errorMessage');

        // Email Validation Patterns
        const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        const commonDomains = ['gmail.com', 'yahoo.com', 'hotmail.com', 'outlook.com', 'icloud.com'];
        
        // Track field state
        let touched = { email: false };

        // Utility Functions
        function setFieldValid(el) {
          el.classList.remove('border-red-500', 'border-red-300', 'error-shake');
          el.classList.add('success-border');
          el.setAttribute('aria-invalid', 'false');
        }
        
        function setFieldInvalid(el) {
          el.classList.remove('success-border', 'border-gray-300');
          el.classList.add('border-red-500', 'error-shake');
          el.setAttribute('aria-invalid', 'true');
          
          setTimeout(() => {
            el.classList.remove('error-shake');
          }, 500);
        }
        
        function clearFieldState(el) {
          el.classList.remove('success-border', 'border-red-500', 'border-red-300', 'error-shake');
          el.classList.add('border-gray-300');
          el.setAttribute('aria-invalid', 'false');
        }

        // Enhanced Email Validation
        function validateEmail(value) {
          const email = value.trim().toLowerCase();
          
          if (!email) {
            return { valid: false, message: 'Email address is required.' };
          }
          
          if (!emailPattern.test(email)) {
            return { valid: false, message: 'Please enter a valid email address.' };
          }
          
          // Check domain validity
          const domain = email.split('@')[1];
          if (!domain || domain.length < 3) {
            return { valid: false, message: 'Please enter a valid email domain.' };
          }
          
          // Check for common typos
          const commonTypos = {
            'gmial.com': 'gmail.com',
            'gmai.com': 'gmail.com',
            'gmal.com': 'gmail.com',
            'yaho.com': 'yahoo.com',
            'yahooo.com': 'yahoo.com',
            'hotmal.com': 'hotmail.com',
            'hotmial.com': 'hotmail.com',
            'outlook.cm': 'outlook.com'
          };
          
          if (commonTypos[domain]) {
            return { 
              valid: false, 
              message: `Did you mean ${email.split('@')[0]}@${commonTypos[domain]}?` 
            };
          }
          
          return { valid: true, message: '' };
        }

        // Show/Hide Error Functions
        function showEmailError(message) {
          emailErrorText.textContent = message;
          emailError.classList.remove('hidden');
          emailTips.classList.add('hidden');
          setFieldInvalid(email);
        }

        function hideEmailError() {
          emailError.classList.add('hidden');
          emailTips.classList.remove('hidden');
          setFieldValid(email);
        }

        // Real-time Email Validation
        email.addEventListener('input', () => {
          const result = validateEmail(email.value);
          
          if (result.valid) {
            hideEmailError();
          } else {
            if (touched.email || email.value.trim().length > 0) {
              showEmailError(result.message);
            } else {
              clearFieldState(email);
              emailError.classList.add('hidden');
              emailTips.classList.add('hidden');
            }
          }
        });

        // Blur Validation
        email.addEventListener('blur', () => {
          touched.email = true;
          const result = validateEmail(email.value);
          
          if (!result.valid) {
            showEmailError(result.message);
          } else {
            hideEmailError();
          }
        });

        // Focus next field validation (if there were multiple fields)
        email.addEventListener('focus', () => {
          // Clear any global error messages when user starts typing
          if (errorMessage) {
            errorMessage.classList.add('hidden');
          }
        });

        // Form Submission Handler
        form.addEventListener('submit', function (e) {
          e.preventDefault();

          // Show loading state
          submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Sending OTP...';
          submitBtn.disabled = true;

          // Mark field as touched
          touched.email = true;

          // Validate email
          const emailResult = validateEmail(email.value);

          if (!emailResult.valid) {
            showEmailError(emailResult.message);
            
            // Reset button state
            submitBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i> Send Reset OTP';
            submitBtn.disabled = false;
            
            // Focus the invalid field
            email.focus();
            return;
          }

          // All validations passed - submit form
          hideEmailError();
          
          // Add a small delay for better UX
          setTimeout(() => {
            form.submit();
          }, 1500);
        });

        // Rate Limiting Protection (Client-side)
        let submitAttempts = 0;
        const maxAttempts = 5;
        const resetTime = 5 * 60 * 1000; // 5 minutes

        form.addEventListener('submit', function(e) {
          submitAttempts++;
          
          if (submitAttempts >= maxAttempts) {
            e.preventDefault();
            showEmailError('Too many attempts. Please try again in 5 minutes.');
            submitBtn.disabled = true;
            
            // Re-enable after reset time
            setTimeout(() => {
              submitAttempts = 0;
              submitBtn.disabled = false;
              submitBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i> Send Reset OTP';
            }, resetTime);
            
            return;
          }
        });

        // Initialize field states
        clearFieldState(email);

        // Auto-focus email field on page load
        setTimeout(() => {
          email.focus();
        }, 500);

      })();
    </script>

    <script>
      // Prevent back navigation
      if (window.history && window.history.replaceState) {
        window.history.pushState(null, null, window.location.href);
        window.onpopstate = function () {
          window.history.go(1);
        };
      }
    </script>
  </body>
</html>