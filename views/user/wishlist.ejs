<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Wishlist - BagHub</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --primary:#1a56db; --primary-dark:#1e429f; }

        .card-hover { transition:0.3s; box-shadow:0 4px 6px rgba(0,0,0,.1); }
        .card-hover:hover { transform:translateY(-2px); }

        .wishlist-item { transition:0.3s; }
        .wishlist-item:hover { transform:translateY(-5px); }

        .empty-state { animation:fadeIn .5s; }

        @keyframes fadeIn {
            from { opacity:0; transform:translateY(20px); }
            to { opacity:1; transform:translateY(0); }
        }

        .notification { animation:slideIn .5s; }
        @keyframes slideIn {
            from { transform:translateX(100%); opacity:0; }
            to { transform:translateX(0); opacity:1; }
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">

<!-- HEADER -->
<%- include('../partials/landingheader') %>

<div class="container mx-auto px-4 py-8">
    <div class="flex flex-col lg:flex-row gap-8">

        <!-- SIDEBAR -->
        <%- include('../partials/userProfileSiderbar', {
            activePage: 'wishlist',
            user,
            wishlistCount,
            ordersCount,
            unreadNotifications
        }) %>

        <!-- MAIN -->
        <div class="lg:w-3/4">

            <!-- PAGE HEADER -->
            <div class="bg-gradient-to-r from-pink-500 to-red-500 rounded-2xl shadow-lg p-6 mb-6 text-white">
                <div class="flex items-center gap-4">
                    <div class="w-16 h-16 rounded-full bg-white/20 flex items-center justify-center">
                        <i class="far fa-heart text-2xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold">My Wishlist</h1>
                        <p class="text-pink-100">Your favorite items saved for later</p>
                    </div>
                </div>
            </div>

            <!-- WISHLIST BOX -->
            <div class="bg-white rounded-2xl shadow-sm p-6">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-xl font-bold text-gray-900">Saved Items</h2>
                        <p class="text-gray-600">Products you added to wishlist</p>
                    </div>
                </div>

                <!-- WISHLIST LIST -->
                <div id="wishlistItems" class="space-y-4">

                    <% if (wishlistItems.length === 0) { %>
                        <script>
                            document.addEventListener("DOMContentLoaded", () => {
                                document.getElementById("wishlistItems").classList.add("hidden");
                                document.getElementById("emptyWishlist").classList.remove("hidden");
                            });
                        </script>
                    <% } %>

                    <% wishlistItems.forEach(product => { %>

                 <% const variantIndex = 0; %>
<% const variant = product.variants?.[variantIndex]; %>
<% const unavailable = product.isDeleted || !product.isActive; %>


<div class="wishlist-item bg-white border border-gray-200 rounded-xl p-4 flex flex-col md:flex-row gap-4 
    <%= unavailable ? 'opacity-50 pointer-events-none' : '' %>">

    <!-- IMAGE -->
    <div class="flex-shrink-0">
        <img 
            src="<%= product.images?.[0]?.url || variant?.images?.[0]?.url || '/images/no-image.jpg' %>"
            class="w-24 h-24 md:w-32 md:h-32 object-cover rounded-lg"
        />
    </div>

    <!-- CONTENT -->
    <div class="flex-grow">
        
        <!-- NAME + CATEGORY -->
        <div class="flex flex-col md:flex-row md:justify-between">

            <div>
                <h3 class="font-bold text-gray-900 text-lg"><%= product.name %></h3>

                <p class="text-gray-600 text-sm mt-1">
                    <%= product.description || "No description available" %>
                </p>

                <p class="text-gray-500 text-sm mt-2">
                    Category: <%= product.category?.name || "Uncategorized" %>
                </p>
            </div>

            <!-- PRICE -->
            <div class="mt-4 md:mt-0 md:text-right">
                <% if (unavailable) { %>
                    <p class="text-red-600 font-bold">Unavailable</p>
                <% } else { %>
                    <p class="text-2xl font-bold text-gray-900">
                        â‚¹<%= variant?.price || product.price || 0 %>
                    </p>
                <% } %>
            </div>
        </div>

      <!-- VARIANT SELECTOR -->
<% if (product.variants && product.variants.length > 1) { %>
    <div class="mt-3">
        <label class="text-sm text-gray-600">Choose Color:</label>
        <select 
            id="variantSelect-<%= product._id %>" 
            class="border border-gray-300 rounded-lg px-2 py-1"
        >
            <% product.variants.forEach((v, idx) => { %>
                <option value="<%= idx %>">
                    <%= v.color %> - â‚¹<%= v.price %>
                    (<%= v.stock > 0 ? v.stock + ' left' : 'Out of stock' %>)
                </option>
            <% }) %>
        </select>
    </div>
<% } %>


        <!-- STOCK + BUTTONS -->
        <div class="flex flex-col md:flex-row md:items-center justify-between mt-4">

            <!-- STOCK -->
            <div class="flex items-center gap-2 text-sm">
                <% if (unavailable) { %>
                    <i class="fas fa-ban text-red-600"></i>
                    <span class="text-red-600">Currently Unavailable</span>
                <% } else if ((variant?.stock || 0) > 0) { %>
                    <i class="fas fa-box text-green-600"></i>
                    <span>In Stock</span>
                <% } else { %>
                    <i class="fas fa-box text-red-600"></i>
                    <span>Out of Stock</span>
                <% } %>
            </div>

            <!-- BUTTONS -->
            <div class="flex gap-2 mt-3 md:mt-0">

                <!-- Add to Cart -->

                <button 
    onclick="addToCartFromWishlist('<%= product._id %>')"
    class="px-4 py-2 rounded-lg flex items-center gap-2 bg-gray-100 text-gray-700 hover:bg-gray-200"
>
    <i class="fas fa-shopping-cart"></i>
    Add to Cart
</button>

        <!-- <button 
    onclick="<%= (!unavailable && variant?.stock > 0) 
                ? `addToCart('${product._id}', ${variantIndex})` 
                : '' %>"
    class="px-4 py-2 rounded-lg flex items-center gap-2 
        <%= (!unavailable && variant?.stock > 0) 
            ? 'bg-gray-100 text-gray-700 hover:bg-gray-200' 
            : 'bg-gray-300 text-gray-400 cursor-not-allowed' 
        %>"
>
    <i class="fas fa-shopping-cart"></i>
    Add to Cart
</button> -->




                <!-- Remove -->
                <button 
                    onclick="removeFromWishlist('<%= product._id %>')"
                    class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 flex items-center gap-2"
                >
                    <i class="fas fa-trash"></i> Remove
                </button>

            </div>

        </div>

    </div>

</div>
   
                    <% }) %>

                </div>

                <!-- EMPTY STATE -->
                <div id="emptyWishlist" class="hidden text-center py-12">
                    <div class="w-24 h-24 mx-auto bg-gray-100 rounded-full flex items-center justify-center mb-4">
                        <i class="far fa-heart text-gray-400 text-3xl"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-700 mb-2">Your wishlist is empty</h3>
                    <p class="text-gray-500 mb-6">Start adding items you love.</p>
                    <a href="/user/shop" class="bg-blue-600 text-white px-6 py-3 rounded-lg inline-flex items-center gap-2">
                        <i class="fas fa-shopping-bag"></i> Start Shopping
                    </a>
                </div>

            </div>
        </div>
    </div>
</div>

  <%- include('../partials/footer') %>

<!-- JS -->
<script>
function removeFromWishlist(productId) {
    fetch(`/user/wishlist/remove/${productId}`, { method: "POST" })
        .then(res => res.json())
        .then(data => { if (data.success) location.reload(); });
}

// function addToCart(productId) {
//     fetch(`/cart/add/${productId}`, { method: "POST" })
//         .then(res => res.json())
//         .then(data => {
//             if (data.success) showNotification("Item added to cart", "success");
//         });
// }
function addToCart(productId, variantIndex = 0) {

    fetch("/user/cart/add", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ productId, quantity: 1, variantIndex })
    })
    .then(res => res.json())
    .then(async data => {

        if (!data.success) {
            showNotification(data.message || "Failed to add", "error");
            return;
        }

        showNotification("Item added to cart", "success");

        // ðŸŸ¢ REMOVE ITEM FROM WISHLIST (DB)
        await fetch(`/user/wishlist/remove/${productId}`, { method: "POST" });

        // ðŸŸ¢ REMOVE FROM UI IMMEDIATELY WITHOUT REFRESH
        const card = document.querySelector(`[data-product-id="${productId}"]`);
        if (card) {
            card.style.opacity = "0";
            setTimeout(() => card.remove(), 300);
        }

        // ðŸŸ¢ Redirect to cart AFTER wishlist item is removed
        setTimeout(() => {
            window.location.href = "/user/cart";
        }, 400);

    })
    .catch(err => {
        console.error(err);
        showNotification("Error adding item", "error");
    });
}


function addToCartFromWishlist(productId) {

    // Get selected variant index
    const selectEl = document.getElementById(`variantSelect-${productId}`);
    let variantIndex = 0;

    if (selectEl) {
        variantIndex = parseInt(selectEl.value);
    }

    // Add to cart
    fetch("/user/cart/add", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ 
            productId, 
            quantity: 1, 
            variantIndex 
        })
    })
    .then(res => res.json())
    .then(async data => {

        if (!data.success) {
            showNotification(data.message || "Failed to add", "error");
            return;
        }

        showNotification("Item added to cart", "success");

        // remove from wishlist
        await fetch(`/user/wishlist/remove/${productId}`, { method: "POST" });

        setTimeout(() => window.location.href = "/user/cart", 500);
    });
}


function showNotification(message, type) {
    const n = document.createElement("div");
    n.className = `notification p-4 rounded-lg shadow-lg text-white ${type === 'success' ? 'bg-green-600' : 'bg-red-600'}`;
    n.innerHTML = `<div class="flex items-center gap-3"><i class="fas fa-${type === 'success' ? 'check' : 'exclamation'}"></i> ${message}</div>`;
    
    document.body.appendChild(n);
    setTimeout(() => { n.style.opacity = '0'; setTimeout(() => n.remove(), 300); }, 3000);
}
</script>

</body>
</html>
