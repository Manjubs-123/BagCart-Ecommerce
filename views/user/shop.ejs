<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Our Collection - BagHub | Premium Backpacks</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .btn-primary { background-color: #1a56db; transition: all 0.3s ease; }
        .btn-primary:hover { background-color: #1e429f; transform: translateY(-2px); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-5px); }
        .filter-dropdown { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .filter-dropdown.active { max-height: 500px; }
        .color-swatch { width: 20px; height: 20px; border-radius: 50%; border: 2px solid #e5e7eb; }
        .featured-badge { background: linear-gradient(135deg, #f59e0b, #d97706); }
    </style>
</head>
<body class="bg-gray-50">
    <%- include('../partials/landingheader', { user: user }) %>

    <div class="container mx-auto px-4 py-8">
        <!-- Page Header -->
        <div class="text-center mb-12">
            <h1 class="text-4xl font-bold text-gray-900 mb-4">Premium Collection</h1>
            <p class="text-lg text-gray-600 max-w-2xl mx-auto">
                Discover our carefully curated selection of premium backpacks.
            </p>
        </div>

        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Sidebar Filters -->
            <aside class="lg:w-80 w-full">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 sticky top-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-bold text-gray-900">Filters</h2>
                        <button onclick="clearAllFilters()" class="text-sm text-blue-600 hover:text-blue-800">
                            Clear All
                        </button>
                    </div>

                    <!-- Search Filter -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Search Products</label>
                        <div class="relative">
                            <input type="text" id="searchInput" placeholder="Search for products..."
                                value="<%= currentQuery.search || '' %>"
                                class="w-full px-4 py-3 border rounded-lg pl-11 pr-10">
                            <div class="absolute inset-y-0 left-0 flex items-center pl-3">
                                <i class="fas fa-search text-gray-400"></i>
                            </div>
                            <button id="clearSearchBtn" onclick="clearSearch()"
                                class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 hover:text-gray-600"
                                style="display: <%= currentQuery.search ? 'flex' : 'none' %>">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Categories Filter -->
                    <div class="mb-6">
                        <button onclick="toggleFilter('category')" class="flex items-center justify-between w-full text-left font-semibold text-gray-900 mb-3">
                            <span>Categories</span><i class="fas fa-chevron-down transition-transform"></i>
                        </button>
                        <div id="category-filter" class="filter-dropdown active">
                            <% categories.forEach(cat => { %>
                                <label class="flex items-center gap-3 cursor-pointer hover:bg-gray-50 p-2 rounded-lg">
                                    <input type="checkbox" name="category" value="<%= cat._id %>"
                                        <%= currentQuery.category.includes(String(cat._id)) ? "checked" : "" %>
                                        class="filter-checkbox h-4 w-4 text-blue-600 rounded">
                                    <span class="text-sm text-gray-700"><%= cat.name %></span>
                                </label>
                            <% }) %>
                        </div>
                    </div>

                    <!-- Price Range -->
                    <div class="mb-6">
                        <h3 class="font-semibold text-gray-900 mb-3">Price Range</h3>
                        <div class="flex items-center gap-3">
                            <input type="number" id="minPrice" placeholder="Min" value="<%= currentQuery.minPrice || '' %>"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" min="0">
                            <span class="text-gray-500">to</span>
                            <input type="number" id="maxPrice" placeholder="Max" value="<%= currentQuery.maxPrice || '' %>"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" min="0">
                        </div>
                    </div>

                    <!-- Colors Filter -->
                    <div class="mb-6">
                        <button onclick="toggleFilter('color')" class="flex items-center justify-between w-full text-left font-semibold text-gray-900 mb-3">
                            <span>Colors</span><i class="fas fa-chevron-down transition-transform"></i>
                        </button>
                        <div id="color-filter" class="filter-dropdown active">
                            <% colors.forEach(color => { %>
                                <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-2 rounded-lg">
                                    <input type="checkbox" name="color" value="<%= color %>"
                                        <%= currentQuery.color.includes(color) ? "checked" : "" %>
                                        class="filter-checkbox h-4 w-4 text-blue-600 rounded">
                                    <span class="color-swatch" style="background-color:<%= color.toLowerCase() %>"></span>
                                    <span class="text-sm text-gray-700 capitalize"><%= color %></span>
                                </label>
                            <% }) %>
                        </div>
                    </div>

                    <!-- Brand Filter -->
                    <div class="mb-6">
                        <button onclick="toggleFilter('brand')" class="flex items-center justify-between w-full text-left font-semibold text-gray-900 mb-3">
                            <span>Brands</span><i class="fas fa-chevron-down transition-transform"></i>
                        </button>
                        <div id="brand-filter" class="filter-dropdown active">
                            <% brands.forEach(brand => { %>
                                <label class="flex items-center gap-3 cursor-pointer hover:bg-gray-50 p-2 rounded-lg">
                                    <input type="checkbox" name="brand" value="<%= brand %>"
                                        <%= currentQuery.brand.includes(brand) ? "checked" : "" %>
                                        class="filter-checkbox h-4 w-4 text-blue-600 rounded">
                                    <span class="text-sm text-gray-700"><%= brand %></span>
                                </label>
                            <% }) %>
                        </div>
                    </div>

                    <button onclick="applyFilters()" class="w-full btn-primary text-white py-3 rounded-lg font-semibold">
                        <i class="fas fa-filter mr-2"></i>Apply Filters
                    </button>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="flex-1">
                <!-- Results Header -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900">Our Collection</h2>
                            <p class="text-gray-600 mt-1">
                                Showing <span class="font-semibold">
                                    <%= pagination.totalCount === 0 ? 0 : Math.min((pagination.page - 1) * pagination.perPage + 1, pagination.totalCount) %> - <%= Math.min(pagination.page * pagination.perPage, pagination.totalCount) %>
                                </span> of <span class="font-semibold"><%= pagination.totalCount %></span> products
                            </p>
                        </div>
                        <div class="relative">
                            <select id="sortSelect" onchange="applyFilters()"
                                class="appearance-none bg-white border border-gray-300 rounded-lg px-4 py-2 pr-8 focus:outline-none cursor-pointer">
                                <option value="">Sort by</option>
                                <option value="price-low" <%= currentQuery.sort === 'price-low' ? 'selected' : '' %>>Price: Low to High</option>
                                <option value="price-high" <%= currentQuery.sort === 'price-high' ? 'selected' : '' %>>Price: High to Low</option>
                                <option value="name-asc" <%= currentQuery.sort === 'name-asc' ? 'selected' : '' %>>Name: A to Z</option>
                                <option value="name-desc" <%= currentQuery.sort === 'name-desc' ? 'selected' : '' %>>Name: Z to A</option>
                                <option value="new" <%= currentQuery.sort === 'new' ? 'selected' : '' %>>New Arrivals</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Products Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <% if (products.length > 0) { %>
                        <% products.forEach(product => { %>
                            <div class="product-card bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden card-hover">
                                <a href="/user/product/<%= product._id %>" class="block">
                                    <div class="relative">
                                        <img src="<%= product.mainImage || '/images/placeholder.jpg' %>" alt="<%= product.name %>" 
                                            class="w-full h-64 object-cover" loading="lazy" onerror="this.src='/images/placeholder.jpg'">
                                        
                                        <% if (product.isFeatured) { %>
                                            <div class="absolute top-3 left-3">
                                                <span class="featured-badge text-white text-xs font-semibold px-2 py-1 rounded-full">
                                                    <i class="fas fa-star mr-1"></i>Featured
                                                </span>
                                            </div>
                                        <% } %>
                                        
                                        <button onclick="toggleWishlist(event, '<%= product._id %>', this)"
                                            class="wishlist-btn absolute top-3 right-3 bg-white rounded-full p-2 shadow-md">
                                            <i class="<%= userWishlistIds.includes(product._id.toString()) ? 'fas fa-heart text-red-500' : 'far fa-heart text-gray-400' %> text-lg"></i>
                                        </button>
                                    </div>
                                    <div class="p-4">
                                        <h3 class="font-semibold text-gray-900 text-lg mb-2"><%= product.name %></h3>
                                        <p class="text-sm text-gray-500 mb-2"><%= product.brand %></p>
                                        
                                        <!-- PRICE SECTION -->
<div class="mb-3">

    <!-- Original price (crossed) -->
    <% if ((product.regularPrice || product.variantMRP) > (product.finalPrice || product.variantPrice)) { %>
        <div class="flex items-center gap-2 mb-1">
            <span class="text-gray-500 text-sm line-through">
                ₹<%= product.regularPrice || product.variantMRP %>
            </span>
            <span class="text-green-600 font-semibold text-sm">
                <%= product.discountPercent || 0 %>% off
            </span>
        </div>
    <% } %>

    <!-- Final price -->
    <div class="text-lg font-bold text-gray-900">
        ₹<%= product.finalPrice || product.variantPrice %>
    </div>

    <!-- Savings -->
    <% if ((product.regularPrice || product.variantMRP) > (product.finalPrice || product.variantPrice)) { %>
        <div class="text-xs text-green-600">
            Save ₹<%= ((product.regularPrice || product.variantMRP) - (product.finalPrice || product.variantPrice)).toFixed(0) %>
        </div>
    <% } %>

    <!-- Offer badge -->
    <% if (product.appliedOffer) { %>
        <div class="mt-1">
            <span class="inline-block bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-1 rounded">
                <i class="fas fa-tag mr-1"></i>Offer Applied
            </span>
        </div>
    <% } %>

</div>

                                        
                                        <% if (product.variants && product.variants.length > 0) { %>
                                            <div class="flex gap-1 mb-3">
                                                <% product.variants.forEach(v => { %>
                                                    <span class="color-swatch" style="background-color:<%= v.color.toLowerCase() %>" title="<%= v.color %>"></span>
                                                <% }) %>
                                            </div>
                                        <% } %>
                                        
                                        <div class="flex items-center justify-between pt-3 border-t border-gray-100">
                                            <span class="text-sm text-gray-500"><i class="fas fa-shipping-fast mr-1"></i>Free Shipping</span>
                                            <span class="text-blue-600 text-sm font-medium">View Details <i class="fas fa-arrow-right ml-1"></i></span>
                                        </div>
                                    </div>
                                </a>
                            </div>
                        <% }) %>
                    <% } else { %>
                        <div class="col-span-3 text-center py-16">
                            <i class="fas fa-inbox text-6xl text-gray-300 mb-4"></i>
                            <h3 class="text-xl font-semibold text-gray-600 mb-2">No Products Found</h3>
                            <p class="text-gray-500 mb-6">Try adjusting your filters or search terms</p>
                            <button onclick="clearAllFilters()" class="btn-primary text-white px-6 py-3 rounded-lg font-semibold">
                                Clear All Filters
                            </button>
                        </div>
                    <% } %>
                </div>

                <!-- Pagination -->
                <% if (pagination.totalPages > 1) { %>
                    <div class="flex justify-center items-center gap-2 mt-10">
                        <% if (pagination.page > 1) { %>
                            <a href="?<%= buildPaginationUrl(pagination.page - 1) %>" class="px-4 py-2 border rounded-lg bg-white hover:bg-gray-100">
                                <i class="fas fa-chevron-left mr-2"></i>Prev
                            </a>
                        <% } %>
                        <% for (let i = 1; i <= pagination.totalPages; i++) { %>
                            <% if (i === 1 || i === pagination.totalPages || (i >= pagination.page - 2 && i <= pagination.page + 2)) { %>
                                <a href="?<%= buildPaginationUrl(i) %>" class="px-4 py-2 border rounded-lg <%= i === pagination.page ? 'bg-blue-600 text-white' : 'bg-white hover:bg-gray-100' %>">
                                    <%= i %>
                                </a>
                            <% } else if (i === pagination.page - 3 || i === pagination.page + 3) { %>
                                <span class="px-2 text-gray-500">...</span>
                            <% } %>
                        <% } %>
                        <% if (pagination.page < pagination.totalPages) { %>
                            <a href="?<%= buildPaginationUrl(pagination.page + 1) %>" class="px-4 py-2 border rounded-lg bg-white hover:bg-gray-100">
                                Next<i class="fas fa-chevron-right ml-2"></i>
                            </a>
                        <% } %>
                    </div>
                <% } %>
            </main>
        </div>
    </div>

    <%- include('../partials/footer') %>

    <script>
        // Toggle filter sections
        function toggleFilter(type) {
            const filter = document.getElementById(`${type}-filter`);
            const icon = filter.previousElementSibling.querySelector('i');
            filter.classList.toggle('active');
            icon.classList.toggle('rotate-180');
        }

        // Clear all filters
        function clearAllFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('clearSearchBtn').style.display = 'none';
            document.getElementById('minPrice').value = '';
            document.getElementById('maxPrice').value = '';
            document.querySelectorAll('.filter-checkbox').forEach(checkbox => checkbox.checked = false);
            document.getElementById('sortSelect').value = '';
            applyFilters();
        }

        // Apply filters - ALL PROCESSING ON BACKEND
        function applyFilters() {
            const params = new URLSearchParams();
            params.set('page', 1); // Reset to page 1

            // Collect filter values (processed on backend)
            const search = document.getElementById('searchInput').value.trim();
            if (search) params.set('search', search);

            const minPrice = document.getElementById('minPrice').value.trim();
            const maxPrice = document.getElementById('maxPrice').value.trim();
            if (minPrice) params.set('minPrice', minPrice);
            if (maxPrice) params.set('maxPrice', maxPrice);

            const sortValue = document.getElementById('sortSelect').value;
            if (sortValue) params.set('sort', sortValue);

            // Array filters
            const selectedCategories = Array.from(document.querySelectorAll('input[name="category"]:checked')).map(cb => cb.value);
            selectedCategories.forEach(c => params.append('category', c));

            const selectedColors = Array.from(document.querySelectorAll('input[name="color"]:checked')).map(cb => cb.value);
            selectedColors.forEach(c => params.append('color', c));

            const selectedBrands = Array.from(document.querySelectorAll('input[name="brand"]:checked')).map(cb => cb.value);
            selectedBrands.forEach(b => params.append('brand', b));

            // Redirect to backend with filters
            window.location.href = window.location.pathname + '?' + params.toString();
        }

        // Clear search
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('clearSearchBtn').style.display = 'none';
            applyFilters();
        }

        // Toggle wishlist
        async function toggleWishlist(event, productId, btn) {
            event.preventDefault();
            event.stopPropagation();
            const icon = btn.querySelector("i");
            const isAdded = icon.classList.contains("fas");

            try {
                if (!isAdded) {
                    const response = await fetch(`/user/wishlist/add/${productId}`, { method: "POST" });
                    if (response.ok) {
                        icon.classList.replace("far", "fas");
                        icon.classList.add("text-red-500");
                    }
                } else {
                    const response = await fetch(`/user/wishlist/remove/${productId}`, { method: "POST" });
                    if (response.ok) {
                        icon.classList.replace("fas", "far");
                        icon.classList.remove("text-red-500");
                    }
                }
            } catch (error) {
                console.error('Wishlist error:', error);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            const clearBtn = document.getElementById('clearSearchBtn');
            
            searchInput.addEventListener('input', function() {
                clearBtn.style.display = this.value.length > 0 ? "flex" : "none";
            });

            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    applyFilters();
                }
            });
        });
    </script>
</body>
</html>