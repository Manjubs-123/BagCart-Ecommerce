<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Orders - BagHub</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    .status-pending     { background:#FEF3C7; color:#D97706; }
    .status-processing  { background:#DBEAFE; color:#2563EB; }
    .status-shipped     { background:#EDE9FE; color:#7C3AED; }
    .status-delivered   { background:#D1FAE5; color:#059669; }
    .status-cancelled   { background:#FEE2E2; color:#DC2626; }
    .status-returned    { background:#E5E7EB; color:#6B7280; }

    .order-card {
      box-shadow: 0 4px 10px rgba(0,0,0,0.06);
      transition: .25s ease;
    }
    .order-card:hover { transform: translateY(-4px); }
  </style>
</head>

<body class="bg-gray-50">

<%- include('../partials/landingheader') %>

<main class="container mx-auto px-4 py-8">

  <div class="flex flex-col lg:flex-row gap-8">

    <%- include('../partials/userProfileSiderbar', { 
        activePage : 'orders',
        user,
        ordersCount : orders.length,
        wishlistCount,
        unreadNotifications
    }) %>

    <div class="lg:w-3/4">

      <h1 class="text-3xl font-bold mb-6">My Orders</h1>

      <% if (orders.length === 0) { %>

        <div class="text-center py-16">
          <i class="fas fa-box-open text-6xl text-gray-400"></i>
          <p class="mt-4 text-xl text-gray-600">You haven't placed any orders yet.</p>
          <a href="/" class="mt-6 inline-block bg-blue-600 text-white px-6 py-3 rounded-lg">
            Start Shopping
          </a>
        </div>

      <% } else { %>

        <% orders.forEach(order => { %>

          <!-- ORDER HEADER -->
          <div class="bg-gradient-to-r from-indigo-500 to-purple-600
                      text-white p-5 rounded-xl mb-6">

            <h2 class="text-xl font-bold">
              Order #<%= order.orderId || order._id %>
            </h2>

            <p class="text-blue-100 text-sm mt-1">
              Placed on <%= new Date(order.createdAt).toLocaleDateString() %> •
              <%= order.items.length %> items •
              ₹<%= order.totalAmount.toFixed(2) %>
            </p>
          </div>

          <!-- ORDER ITEMS -->
          <% order.items.forEach(item => { %>

            <div class="order-card bg-white rounded-xl overflow-hidden mb-6">

              <!-- HEADER -->
              <div class="border-b px-6 py-4 flex items-center justify-between">
                <div>
                  <p class="text-lg font-semibold">
                    <%= item.product ? item.product.name : "Product Removed" %>
                  </p>

                  <span class="px-3 py-1 text-sm rounded-full
                               status-<%= item.status %>">
                    <%= item.status.charAt(0).toUpperCase() + item.status.slice(1) %>
                  </span>
                </div>

                <div class="text-right">
                  <p class="text-xl font-bold">₹<%= item.price.toFixed(2) %></p>
                  <p class="text-gray-600 text-sm">Qty: <%= item.quantity %></p>
                </div>
              </div>

              <!-- BODY -->
              <div class="p-6 flex gap-6">

                <img
                  src="<%= item.image || '/images/no-image.jpg' %>"
                  class="w-32 h-32 object-cover rounded-lg">

                <div class="flex-1">

                  <div class="grid grid-cols-2 gap-3 text-sm text-gray-600 mb-4">
                    <p><span class="font-medium">Color:</span> <%= item.color %></p>
                    <p><span class="font-medium">Size:</span> <%= item.size || '-' %></p>
                    <p><span class="font-medium">Total:</span> ₹<%= (item.price * item.quantity).toFixed(2) %></p>
                  </div>

                  <!-- Status box -->
                  <% if (item.status === 'shipped') { %>

                    <div class="bg-green-50 border border-green-200 p-4 rounded-lg">
                      <p class="font-semibold text-gray-800">Item Shipped</p>
                      <p class="text-gray-600 text-sm">
                        Tracking: <%= item.shippedDetails?.trackingId || '—' %>
                      </p>
                    </div>

                  <% } else if (item.status === 'delivered') { %>

                    <div class="bg-green-50 border border-green-200 p-4 rounded-lg">
                      <p class="font-semibold text-gray-800">Delivered</p>
                      <p class="text-gray-600 text-sm">
                        Delivered on <%= item.deliveredDate ? new Date(item.deliveredDate).toLocaleDateString() : '—' %>
                      </p>
                    </div>

                  <% } else if (item.status === 'cancelled') { %>

                    <div class="bg-red-50 border border-red-200 p-4 rounded-lg">
                      <p class="font-semibold text-gray-800">Cancelled</p>
                    </div>

                  <% } else if (item.status === 'returned') { %>

                    <div class="bg-gray-100 border border-gray-300 p-4 rounded-lg">
                      <p class="font-semibold text-gray-800">Returned</p>
                    </div>

                  <% } else { %>

                    <div class="bg-gray-50 border p-4 rounded-lg">
                      <p class="font-semibold text-gray-800">Order Confirmed</p>
                    </div>

                  <% } %>

                </div>
              </div>

              <!-- ACTIONS -->
              <div class="px-6 py-4 border-t flex flex-wrap gap-3">

                <a href="/user/order/<%= order._id %>/item/<%= item._id %>"
                   class="px-4 py-2 rounded-lg bg-blue-600 text-white">
                  <i class="fas fa-eye"></i> View Details
                </a>

                <button onclick="downloadInvoice('<%= order._id %>', '<%= item._id %>')"
                        class="px-4 py-2 rounded-lg border">
                  <i class="fas fa-file-invoice"></i> Invoice
                </button>

                <% if (item.status === 'delivered') { %>

                  <button onclick="initiateReturn('<%= order._id %>', '<%= item._id %>')"
                          class="px-4 py-2 rounded-lg bg-green-600 text-white">
                    <i class="fas fa-undo-alt"></i> Return
                  </button>

                <% } else if (['pending','processing'].includes(item.status)) { %>

                  <button onclick="cancelOrderItem('<%= order._id %>', '<%= item._id %>')"
                          class="px-4 py-2 rounded-lg bg-red-600 text-white">
                    <i class="fas fa-times"></i> Cancel
                  </button>

                <% } %>

              </div>

            </div>

          <% }) %>

        <% }) %>

      <% } %>

    </div>

  </div>

</main>

<script>
function cancelOrderItem(orderId, itemId) {
  if (!confirm('Cancel this item?')) return;
  fetch(`/user/order/${orderId}/item/${itemId}/cancel`, {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({})
  }).then(res => res.json()).then(x => {
    alert(x.message);
    location.reload();
  });
}

function initiateReturn(orderId, itemId) {
  const reason = prompt("Reason for return:");
  if (!reason) return;
  fetch(`/user/order/${orderId}/item/${itemId}/return`, {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ reason })
  }).then(res => res.json()).then(x => {
    alert(x.message);
    location.reload();
  });
}

function downloadInvoice(orderId, itemId) {
  window.open(`/user/order/${orderId}/item/${itemId}/invoice`, "_blank");
}
</script>

</body>
</html>
