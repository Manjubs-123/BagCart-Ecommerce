<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Orders - BagHub</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body class="bg-gray-100">

  <%- include('../partials/landingheader') %>

  <div class="container mx-auto px-4 py-10">

    <h1 class="text-3xl font-bold mb-8 text-gray-800">My Orders</h1>

    <% if (orders.length === 0) { %>
      <div class="bg-white shadow rounded-xl p-10 text-center">
        <p class="text-xl text-gray-700">No orders placed yet.</p>
        <a href="/" class="mt-4 inline-block bg-blue-600 text-white px-6 py-3 rounded-lg">Shop Now</a>
      </div>
    <% } %>

    <% orders.forEach(order => { %>
      <div class="bg-white shadow-lg rounded-xl p-6 mb-10">

        <!-- ORDER HEADER -->
        <div class="flex justify-between items-center border-b pb-4 mb-4">
          <div>
            <p class="text-gray-600">Order ID</p>
            <p class="text-xl font-semibold text-blue-600"><%= order.orderId %></p>
          </div>

          <div class="text-right">
            <p class="text-gray-600 text-sm">Placed On</p>
            <p class="font-semibold">
              <%= new Date(order.createdAt).toLocaleDateString() %>
            </p>
          </div>
        </div>

        <!-- ALL ITEMS -->
        <% order.items.forEach(item => { %>
          <div class="flex gap-6 border-b pb-6 mb-6">

            <!-- Image -->
            <img src="<%= item.image %>" class="w-28 h-28 rounded-lg object-cover">

            <div class="flex-1">
              <h2 class="text-lg font-semibold"><%= item.product.name %></h2>

              <p class="text-gray-700 mt-1">Color: <%= item.color %></p>
              <p class="text-gray-700">Qty: <%= item.quantity %></p>
              <p class="text-gray-700 font-semibold">â‚¹<%= item.price * item.quantity %></p>

              <span class="inline-block mt-2 px-4 py-1 rounded-full bg-blue-100 text-blue-700 font-semibold">
                <%= item.status %>
              </span>

              <!-- ACTION BUTTONS -->
              <div class="mt-4 flex flex-wrap gap-3">

                <!-- Invoice -->
                <button 
                  onclick="downloadInvoice('<%= order._id %>', '<%= item._id %>')"
                  class="bg-green-600 text-white px-4 py-2 rounded-lg"
                >
                  <i class="fas fa-file-invoice"></i> Invoice
                </button>

                <!-- Cancel -->
                <% if (item.status !== "delivered" && item.status !== "cancelled") { %>
                  <button 
                    onclick="openCancelModal('<%= order._id %>', '<%= item._id %>')"
                    class="bg-red-500 text-white px-4 py-2 rounded-lg"
                  >
                    Cancel
                  </button>
                <% } %>

                <!-- Return -->
                <% if (item.status === "delivered") { %>
                  <button 
                    onclick="openReturnModal('<%= order._id %>', '<%= item._id %>')"
                    class="bg-yellow-500 text-white px-4 py-2 rounded-lg"
                  >
                    Return
                  </button>
                <% } %>

              </div>
            </div>

          </div>
        <% }) %>

      </div>
    <% }) %>

  </div>

  <!-- CANCEL MODAL -->
  <div id="cancelModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg w-96">
      <h2 class="text-xl font-bold mb-4">Cancel Item</h2>
      <textarea id="cancelReason"
        class="w-full border p-2 rounded mb-4"
        placeholder="Reason for cancellation..."
      ></textarea>

      <button onclick="submitCancel()" class="bg-red-500 text-white px-4 py-2 rounded-lg">Submit</button>
      <button onclick="closeCancelModal()" class="ml-2 bg-gray-300 px-4 py-2 rounded-lg">Close</button>
    </div>
  </div>

  <!-- RETURN MODAL -->
  <div id="returnModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg w-96">
      <h2 class="text-xl font-bold mb-4">Return Item</h2>
      <textarea id="returnReason"
        class="w-full border p-2 rounded mb-4"
        placeholder="Reason for returning..."
      ></textarea>

      <button onclick="submitReturn()" class="bg-yellow-500 text-white px-4 py-2 rounded-lg">Submit</button>
      <button onclick="closeReturnModal()" class="ml-2 bg-gray-300 px-4 py-2 rounded-lg">Close</button>
    </div>
  </div>

<script>
let currentOrderId = null;
let currentItemId = null;

// Invoice Download
function downloadInvoice(orderId, itemId) {
  const url = `/order/${orderId}/item/${itemId}/invoice`;
  window.open(url, "_blank");
}

// Cancel Modal
function openCancelModal(orderId, itemId) {
  currentOrderId = orderId;
  currentItemId = itemId;
  document.getElementById("cancelModal").classList.remove("hidden");
}

function closeCancelModal() {
  document.getElementById("cancelModal").classList.add("hidden");
}

function submitCancel() {
  const reason = document.getElementById("cancelReason").value.trim();
  if (!reason) return alert("Enter a reason.");

  fetch(`/order/${currentOrderId}/item/${currentItemId}/cancel`, {
    method: "PATCH",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ reason })
  })
  .then(res => res.json())
  .then(data => {
    alert(data.message);
    location.reload();
  });
}

// Return Modal
function openReturnModal(orderId, itemId) {
  currentOrderId = orderId;
  currentItemId = itemId;
  document.getElementById("returnModal").classList.remove("hidden");
}

function closeReturnModal() {
  document.getElementById("returnModal").classList.add("hidden");
}

function submitReturn() {
  const reason = document.getElementById("returnReason").value.trim();
  if (!reason) return alert("Enter a reason.");

  fetch(`/order/${currentOrderId}/item/${currentItemId}/return`, {
    method: "PATCH",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ reason })
  })
  .then(res => res.json())
  .then(data => {
    alert(data.message);
    location.reload();
  });
}

</script>

</body>
</html>
