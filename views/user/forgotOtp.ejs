<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Verify OTP | BagHub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://kit.fontawesome.com/a2e0da32f7.js" crossorigin="anonymous"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <style>
      :root {
        --primary: #1a56db;
        --primary-dark: #1e429f;
        --secondary: #047857;
        --accent: #f59e0b;
      }

      .gradient-bg {
        background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      }

      .btn-primary {
        background-color: var(--primary);
        transition: all 0.3s ease;
      }

      .btn-primary:hover {
        background-color: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      }

      .card-hover {
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      }

      .input-focus:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(26, 86, 219, 0.1);
      }

      .otp-input {
        transition: all 0.2s ease;
      }

      .otp-input:focus {
        transform: scale(1.05);
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .success-border {
        border-color: #10b981;
      }

      .error-shake {
        animation: shake 0.5s ease-in-out;
      }

      @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
      }

      .countdown-pulse {
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
      }

      .progress-bar {
        height: 4px;
        background: linear-gradient(90deg, #ef4444, #f59e0b, #10b981);
        transition: width 1s linear;
      }
    </style>
  </head>

  <body class="bg-gray-50 min-h-screen flex flex-col">
    <!-- Header -->
    <header class="sticky top-0 z-50 bg-white shadow-sm">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center py-4">
          <!-- Logo -->
          <div class="flex items-center">
            <a href="/" class="flex items-center space-x-2">
              <div class="w-10 h-10 rounded-full bg-gradient-to-r from-blue-600 to-emerald-600 flex items-center justify-center">
                <span class="text-white font-bold text-lg">BH</span>
              </div>
              <span class="text-xl font-bold text-gray-900">BagHub</span>
            </a>
          </div>
          
          <!-- Back to Home -->
          <a href="/" class="text-gray-700 hover:text-blue-600 font-medium transition-colors flex items-center">
            <i class="fas fa-arrow-left mr-2"></i>
            Back to Home
          </a>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
      <div class="max-w-md w-full space-y-8">
        <!-- Header Section -->
        <div class="text-center">
          <div class="mx-auto w-16 h-16 bg-gradient-to-r from-blue-500 to-emerald-500 rounded-full flex items-center justify-center mb-4">
            <i class="fas fa-shield-check text-white text-2xl"></i>
          </div>
          <h1 class="text-3xl font-bold text-gray-900 mb-2">Verify Your Account</h1>
          <p class="text-gray-600">We've sent a 6-digit code to your email</p>
          <p class="text-sm text-gray-500 mt-1 font-medium" id="userEmail"><%= email %></p>
        </div>

        <!-- OTP Card -->
        <div class="card-hover bg-white rounded-2xl shadow-xl p-8">
          <!-- Error Message -->
          <% if (typeof error !== "undefined" && error) { %>
            <div class="bg-red-50 border border-red-200 text-red-700 p-4 rounded-lg text-sm mb-6" role="alert">
              <div class="flex items-center">
                <i class="fas fa-exclamation-circle mr-2"></i>
                <span><%= error %></span>
              </div>
            </div>
          <% } %>

          <!-- Success Message -->
          <% if (typeof success !== "undefined" && success) { %>
            <div class="bg-green-50 border border-green-200 text-green-700 p-4 rounded-lg text-sm mb-6" role="alert">
              <div class="flex items-center">
                <i class="fas fa-check-circle mr-2"></i>
                <span><%= success %></span>
              </div>
            </div>
          <% } %>

          <!-- Progress Bar -->
          <div class="mb-6">
            <div class="flex justify-between text-sm text-gray-600 mb-2">
              <span>OTP expires in</span>
              <span id="expiryTimer" class="font-semibold">05:00</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div id="progressBar" class="progress-bar h-2 rounded-full" style="width: 100%"></div>
            </div>
          </div>

          <!-- OTP Form -->
          <form id="otpForm" action="/user/forgotOtp" method="POST" class="space-y-6" novalidate>
            <input type="hidden" name="email" id="emailField" value="<%= email %>" />

            <!-- OTP Input Boxes -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-3 text-center">Enter 6-digit verification code</label>
              <div class="flex justify-center space-x-3 mb-2">
                <% for(let i=0; i<6; i++) { %>
                  <input
                    type="text"
                    maxlength="1"
                    inputmode="numeric"
                    pattern="[0-9]*"
                    class="otp-input w-12 h-12 border-2 border-gray-300 rounded-lg text-center text-xl font-semibold focus:outline-none transition-all duration-200"
                    data-index="<%= i %>"
                    autocomplete="one-time-code"
                    aria-label="Digit <%= i + 1 %> of 6"
                  />
                <% } %>
              </div>
              <p id="otpError" class="text-red-600 text-sm mt-2 hidden flex items-center justify-center" role="status">
                <i class="fas fa-exclamation-circle mr-1 text-xs"></i>
                <span>Please enter a valid 6-digit OTP.</span>
              </p>
            </div>

            <!-- Submit Button -->
            <button
              type="submit"
              id="verifyBtn"
              class="w-full btn-primary text-white py-3 px-4 rounded-lg font-semibold shadow-lg transition duration-200 flex items-center justify-center"
              disabled
            >
              <i class="fas fa-check-circle mr-2"></i>
              Verify & Continue
            </button>
          </form>

          <!-- Resend OTP Section -->
          <div class="text-center mt-6 pt-6 border-t border-gray-200">
            <p class="text-sm text-gray-600 mb-3">Didn't receive the code?</p>
            <button
              id="resendBtn"
              class="text-sm font-medium text-blue-600 hover:text-blue-500 disabled:text-gray-400 disabled:cursor-not-allowed transition flex items-center justify-center mx-auto"
              disabled
            >
              <i class="fas fa-redo-alt mr-2"></i>
              Resend OTP in <span id="countdown" class="font-bold ml-1">60</span>s
            </button>
          </div>
        </div>

        <!-- Security Notice -->
        <div class="text-center text-sm text-gray-500 mt-6">
          <p class="flex items-center justify-center">
            <i class="fas fa-shield-alt mr-2 text-green-500"></i>
            For your security, this code will expire automatically
          </p>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
          <div>
            <h3 class="text-lg font-bold mb-4 text-white">BagHub</h3>
            <p class="text-gray-400">Your one-stop shop for premium backpacks and bags. Quality, style, and convenience.</p>
          </div>
          <div>
            <h4 class="text-lg font-semibold mb-4">Quick Links</h4>
            <ul class="space-y-2 text-gray-400">
              <li><a href="#" class="hover:text-white transition">Home</a></li>
              <li><a href="#" class="hover:text-white transition">Products</a></li>
              <li><a href="#" class="hover:text-white transition">Categories</a></li>
              <li><a href="#" class="hover:text-white transition">Deals</a></li>
            </ul>
          </div>
          <div>
            <h4 class="text-lg font-semibold mb-4">Customer Service</h4>
            <ul class="space-y-2 text-gray-400">
              <li><a href="#" class="hover:text-white transition">Contact Us</a></li>
              <li><a href="#" class="hover:text-white transition">Shipping Policy</a></li>
              <li><a href="#" class="hover:text-white transition">Returns & Refunds</a></li>
              <li><a href="#" class="hover:text-white transition">FAQ</a></li>
            </ul>
          </div>
          <div>
            <h4 class="text-lg font-semibold mb-4">Stay Connected</h4>
            <div class="flex space-x-4">
              <a href="#" class="text-gray-400 hover:text-white transition"><i class="fab fa-facebook-f"></i></a>
              <a href="#" class="text-gray-400 hover:text-white transition"><i class="fab fa-twitter"></i></a>
              <a href="#" class="text-gray-400 hover:text-white transition"><i class="fab fa-instagram"></i></a>
              <a href="#" class="text-gray-400 hover:text-white transition"><i class="fab fa-pinterest"></i></a>
            </div>
          </div>
        </div>
        <div class="border-t border-gray-700 mt-8 pt-6 text-center text-gray-400">
          <p>&copy; 2023 BagHub. All rights reserved.</p>
        </div>
      </div>
    </footer>

    <script>
      (function () {
        // DOM Elements
        const otpInputs = document.querySelectorAll('.otp-input');
        const otpError = document.getElementById('otpError');
        const form = document.getElementById('otpForm');
        const verifyBtn = document.getElementById('verifyBtn');
        const resendBtn = document.getElementById('resendBtn');
        const countdownSpan = document.getElementById('countdown');
        const expiryTimer = document.getElementById('expiryTimer');
        const progressBar = document.getElementById('progressBar');
        const emailField = document.getElementById('emailField');
        const userEmail = document.getElementById('userEmail');

        // Configuration
        const OTP_LENGTH = 6;
        const OTP_EXPIRY_SECONDS = 300; // 5 minutes
        const RESEND_COOLDOWN = 60; // 60 seconds

        // State Management
        let timeLeft = RESEND_COOLDOWN;
        let expiryTimeLeft = OTP_EXPIRY_SECONDS;
        let resendInterval;
        let expiryInterval;
        let isOtpExpired = false;

        // Utility Functions
        function getOtpValue() {
          return Array.from(otpInputs).map(input => input.value).join('');
        }

        function isOtpValid() {
          const otp = getOtpValue();
          return /^[0-9]{6}$/.test(otp);
        }

        function setOtpValid() {
          otpError.classList.add('hidden');
          otpInputs.forEach(input => {
            input.classList.remove('border-red-500', 'error-shake');
            input.classList.add('success-border');
          });
          verifyBtn.disabled = false;
        }

        function setOtpInvalid(message = 'Please enter a valid 6-digit OTP.') {
          otpError.querySelector('span').textContent = message;
          otpError.classList.remove('hidden');
          otpInputs.forEach(input => {
            input.classList.add('border-red-500', 'error-shake');
            input.classList.remove('success-border');
          });
          verifyBtn.disabled = true;

          // Remove shake animation after completion
          setTimeout(() => {
            otpInputs.forEach(input => input.classList.remove('error-shake'));
          }, 500);
        }

        function clearOtpInputs() {
          otpInputs.forEach(input => {
            input.value = '';
            input.classList.remove('border-red-500', 'success-border', 'error-shake');
          });
          verifyBtn.disabled = true;
          otpError.classList.add('hidden');
        }

        // OTP Input Handling
        otpInputs.forEach((input, index) => {
          // Handle input
          input.addEventListener('input', (e) => {
            const value = e.target.value.replace(/\D/g, ''); // Only numbers
            if (value.length > 1) {
              e.target.value = value.charAt(0); // Take only first digit
            }

            // Auto-focus next input
            if (value && index < otpInputs.length - 1) {
              otpInputs[index + 1].focus();
            }

            // Validate complete OTP
            if (getOtpValue().length === OTP_LENGTH) {
              if (isOtpValid()) {
                setOtpValid();
              } else {
                setOtpInvalid();
              }
            } else {
              otpError.classList.add('hidden');
              verifyBtn.disabled = true;
            }
          });

          // Handle backspace
          input.addEventListener('keydown', (e) => {
            if (e.key === 'Backspace' && !e.target.value && index > 0) {
              otpInputs[index - 1].focus();
            }
          });

          // Handle paste
          input.addEventListener('paste', (e) => {
            e.preventDefault();
            const pasteData = e.clipboardData.getData('text').replace(/\D/g, '').substring(0, OTP_LENGTH);
            
            if (pasteData.length === OTP_LENGTH) {
              pasteData.split('').forEach((char, idx) => {
                if (otpInputs[idx]) {
                  otpInputs[idx].value = char;
                }
              });
              setOtpValid();
              otpInputs[OTP_LENGTH - 1].focus();
            }
          });
        });

        // Countdown Timer for Resend
        function startResendCountdown() {
          resendBtn.disabled = true;
          resendBtn.classList.add('countdown-pulse');
          
          resendInterval = setInterval(() => {
            if (timeLeft > 0) {
              timeLeft--;
              countdownSpan.textContent = timeLeft;
            } else {
              clearInterval(resendInterval);
              resendBtn.disabled = false;
              resendBtn.classList.remove('countdown-pulse');
              resendBtn.innerHTML = '<i class="fas fa-redo-alt mr-2"></i> Resend OTP';
            }
          }, 1000);
        }

        // OTP Expiry Timer
        function startExpiryCountdown() {
          expiryInterval = setInterval(() => {
            if (expiryTimeLeft > 0) {
              expiryTimeLeft--;
              
              const minutes = Math.floor(expiryTimeLeft / 60);
              const seconds = expiryTimeLeft % 60;
              expiryTimer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
              
              // Update progress bar
              const progressPercentage = (expiryTimeLeft / OTP_EXPIRY_SECONDS) * 100;
              progressBar.style.width = `${progressPercentage}%`;
              
              // Change color based on time remaining
              if (expiryTimeLeft < 60) {
                progressBar.style.background = 'linear-gradient(90deg, #ef4444, #ef4444)';
              } else if (expiryTimeLeft < 180) {
                progressBar.style.background = 'linear-gradient(90deg, #f59e0b, #f59e0b)';
              }
            } else {
              clearInterval(expiryInterval);
              isOtpExpired = true;
              setOtpInvalid('This OTP has expired. Please request a new one.');
              progressBar.style.width = '0%';
            }
          }, 1000);
        }

        // Form Submission
        form.addEventListener('submit', function (e) {
          e.preventDefault();
          
          const otpValue = getOtpValue();
          
          if (!isOtpValid()) {
            setOtpInvalid();
            otpInputs[0].focus();
            return;
          }

          if (isOtpExpired) {
            setOtpInvalid('This OTP has expired. Please request a new one.');
            return;
          }

          // Show loading state
          verifyBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Verifying...';
          verifyBtn.disabled = true;

          // Submit the form
          setTimeout(() => {
            form.submit();
          }, 1000);
        });

        // Resend OTP Handler
        resendBtn.addEventListener('click', async function() {
          if (resendBtn.disabled) return;

          // Show loading state
          resendBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Sending...';
          resendBtn.disabled = true;

          try {
            const response = await axios.post('/user/resend-otp', { 
              email: emailField.value 
            });

            if (response.data.success) {
              // Reset OTP state
              clearOtpInputs();
              isOtpExpired = false;
              
              // Reset timers
              timeLeft = RESEND_COOLDOWN;
              expiryTimeLeft = OTP_EXPIRY_SECONDS;
              
              // Restart countdowns
              clearInterval(resendInterval);
              clearInterval(expiryInterval);
              startResendCountdown();
              startExpiryCountdown();
              
              // Reset progress bar
              progressBar.style.background = 'linear-gradient(90deg, #ef4444, #f59e0b, #10b981)';
              progressBar.style.width = '100%';

              // Show success message
              Swal.fire({
                icon: 'success',
                title: 'OTP Resent!',
                text: 'A new OTP has been sent to your email.',
                confirmButtonColor: '#1a56db',
                timer: 3000
              });

            } else {
              throw new Error(response.data.message || 'Failed to resend OTP');
            }

          } catch (error) {
            console.error('Resend OTP error:', error);
            
            Swal.fire({
              icon: 'error',
              title: 'Failed to Resend',
              text: 'Please try again in a moment.',
              confirmButtonColor: '#1a56db'
            });
            
            // Re-enable resend button
            resendBtn.disabled = false;
            resendBtn.innerHTML = '<i class="fas fa-redo-alt mr-2"></i> Resend OTP';
          }
        });

        // Auto-submit when OTP is complete
        otpInputs[OTP_LENGTH - 1].addEventListener('input', (e) => {
          if (getOtpValue().length === OTP_LENGTH && isOtpValid() && !isOtpExpired) {
            setTimeout(() => {
              form.requestSubmit();
            }, 500);
          }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
          startResendCountdown();
          startExpiryCountdown();
          otpInputs[0].focus(); // Focus first input
        });

        // Clean up intervals when page unloads
        window.addEventListener('beforeunload', function() {
          clearInterval(resendInterval);
          clearInterval(expiryInterval);
        });

      })();
    </script>

    <script>
      // Prevent back navigation
      if (window.history && window.history.replaceState) {
        window.history.pushState(null, null, window.location.href);
        window.onpopstate = function () {
          window.history.go(1);
        };
      }
    </script>
  </body>
</html>