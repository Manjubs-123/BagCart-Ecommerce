<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reset Password | BagHub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://kit.fontawesome.com/a2e0da32f7.js" crossorigin="anonymous"></script>

    <style>
      :root {
        --primary: #1a56db;
        --primary-dark: #1e429f;
        --secondary: #047857;
        --accent: #f59e0b;
      }

      .gradient-bg {
        background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      }

      .btn-primary {
        background-color: var(--primary);
        transition: all 0.3s ease;
      }

      .btn-primary:hover {
        background-color: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      }

      .card-hover {
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      }

      .input-focus:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(26, 86, 219, 0.1);
      }

      .success-border {
        border-color: #10b981;
      }

      .error-shake {
        animation: shake 0.5s ease-in-out;
      }

      @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
      }

      .password-strength {
        height: 4px;
        border-radius: 2px;
        transition: all 0.3s ease;
      }

      .strength-weak { background: #ef4444; width: 25%; }
      .strength-fair { background: #f59e0b; width: 50%; }
      .strength-good { background: #10b981; width: 75%; }
      .strength-strong { background: #047857; width: 100%; }
    </style>
  </head>

  <body class="bg-gray-50 min-h-screen flex flex-col">
    <!-- Header -->
    <header class="sticky top-0 z-50 bg-white shadow-sm">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center py-4">
          <!-- Logo -->
          <div class="flex items-center">
            <a href="/" class="flex items-center space-x-2">
              <div class="w-10 h-10 rounded-full bg-gradient-to-r from-blue-600 to-emerald-600 flex items-center justify-center">
                <span class="text-white font-bold text-lg">BH</span>
              </div>
              <span class="text-xl font-bold text-gray-900">BagHub</span>
            </a>
          </div>
          
          <!-- Back to Home -->
          <a href="/" class="text-gray-700 hover:text-blue-600 font-medium transition-colors flex items-center">
            <i class="fas fa-arrow-left mr-2"></i>
            Back to Home
          </a>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
      <div class="max-w-md w-full space-y-8">
        <!-- Header Section -->
        <div class="text-center">
          <div class="mx-auto w-16 h-16 bg-gradient-to-r from-blue-500 to-emerald-500 rounded-full flex items-center justify-center mb-4">
            <i class="fas fa-lock text-white text-2xl"></i>
          </div>
          <h1 class="text-3xl font-bold text-gray-900 mb-2">Reset Your Password</h1>
          <p class="text-gray-600">Create a new secure password for your account</p>
        </div>

        <!-- Reset Password Card -->
        <div class="card-hover bg-white rounded-2xl shadow-xl p-8">
          <!-- Error Message -->
          <% if (typeof error !== "undefined" && error) { %>
            <div class="bg-red-50 border border-red-200 text-red-700 p-4 rounded-lg text-sm mb-6" role="alert">
              <div class="flex items-center">
                <i class="fas fa-exclamation-circle mr-2"></i>
                <span><%= error %></span>
              </div>
            </div>
          <% } %>

          <!-- Success Message -->
          <% if (typeof success !== "undefined" && success) { %>
            <div class="bg-green-50 border border-green-200 text-green-700 p-4 rounded-lg text-sm mb-6" role="alert">
              <div class="flex items-center">
                <i class="fas fa-check-circle mr-2"></i>
                <span><%= success %></span>
              </div>
            </div>
          <% } %>

          <!-- Reset Password Form -->
          <form id="resetForm" action="/user/resetPassword" method="POST" class="space-y-6" novalidate>
            <input type="hidden" name="email" value="<%= email %>" />

            <!-- New Password -->
            <div>
              <label for="newPassword" class="block text-sm font-medium text-gray-700 mb-2">New Password</label>
              <div class="relative">
                <input
                  id="newPassword"
                  name="newPassword"
                  type="password"
                  autocomplete="new-password"
                  placeholder="Enter your new password"
                  required
                  aria-required="true"
                  aria-invalid="false"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg input-focus focus:outline-none transition duration-200 pr-10"
                />
                <button
                  type="button"
                  id="toggleNewPwd"
                  class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 hover:text-gray-600 transition"
                  aria-label="Show or hide password"
                >
                  <i class="fa-regular fa-eye"></i>
                </button>
              </div>
              
              <!-- Password Strength Meter -->
              <div class="mt-2">
                <div class="flex justify-between text-xs text-gray-600 mb-1">
                  <span>Password strength</span>
                  <span id="strengthText" class="font-medium">Weak</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-1">
                  <div id="passwordStrength" class="password-strength strength-weak"></div>
                </div>
              </div>

              <p id="passwordError" class="text-red-600 text-sm mt-2 hidden flex items-center" role="status">
                <i class="fas fa-exclamation-circle mr-1 text-xs"></i>
                <span>Password must meet all requirements above.</span>
              </p>
            </div>

            <!-- Confirm Password -->
            <div>
              <label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-2">Confirm Password</label>
              <div class="relative">
                <input
                  id="confirmPassword"
                  name="confirmPassword"
                  type="password"
                  autocomplete="new-password"
                  placeholder="Confirm your new password"
                  required
                  aria-required="true"
                  aria-invalid="false"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg input-focus focus:outline-none transition duration-200 pr-10"
                />
                <button
                  type="button"
                  id="toggleConfirmPwd"
                  class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 hover:text-gray-600 transition"
                  aria-label="Show or hide password"
                >
                  <i class="fa-regular fa-eye"></i>
                </button>
              </div>
              <p id="confirmError" class="text-red-600 text-sm mt-2 hidden flex items-center" role="status">
                <i class="fas fa-exclamation-circle mr-1 text-xs"></i>
                <span>Passwords do not match.</span>
              </p>
            </div>

            <!-- Submit Button -->
            <button
              type="submit"
              id="submitBtn"
              class="w-full btn-primary text-white py-3 px-4 rounded-lg font-semibold shadow-lg transition duration-200 flex items-center justify-center"
              disabled
            >
              <i class="fas fa-key mr-2"></i>
              Reset Password
            </button>
          </form>

          <!-- Back to Login -->
          <div class="mt-6 text-center">
            <p class="text-gray-600">
              Remember your password?
              <a href="/user/login" class="text-blue-600 hover:text-blue-500 font-medium transition">
                Back to Login
              </a>
            </p>
          </div>
        </div>

        <!-- Security Notice -->
        <div class="text-center text-sm text-gray-500 mt-6">
          <p class="flex items-center justify-center">
            <i class="fas fa-shield-alt mr-2 text-green-500"></i>
            Your new password must be strong and secure
          </p>
        </div>
      </div>
    </main>

    
       <!-- FOOTER -->
      <%- include('../partials/footer') %>

    <!-- Enhanced Validation Script -->
    <script>
      (function () {
        // DOM Elements
        const form = document.getElementById('resetForm');
        const newPassword = document.getElementById('newPassword');
        const confirmPassword = document.getElementById('confirmPassword');
        const passwordError = document.getElementById('passwordError');
        const confirmError = document.getElementById('confirmError');
        const submitBtn = document.getElementById('submitBtn');
        const toggleNewPwd = document.getElementById('toggleNewPwd');
        const toggleConfirmPwd = document.getElementById('toggleConfirmPwd');
        const passwordStrength = document.getElementById('passwordStrength');
        const strengthText = document.getElementById('strengthText');
        const passwordRequirements = document.getElementById('passwordRequirements');

        // Password requirements
        const requirements = {
          length: { regex: /.{8,}/, element: document.querySelector('[data-requirement="length"]') },
          uppercase: { regex: /[A-Z]/, element: document.querySelector('[data-requirement="uppercase"]') },
          number: { regex: /\d/, element: document.querySelector('[data-requirement="number"]') },
          special: { regex: /[!@#$%^&*(),.?":{}|<>]/, element: document.querySelector('[data-requirement="special"]') }
        };

        // Track field state
        let touched = { newPassword: false, confirmPassword: false };

        // Utility Functions
        function setFieldValid(el) {
          el.classList.remove('border-red-500', 'border-red-300', 'error-shake');
          el.classList.add('success-border');
          el.setAttribute('aria-invalid', 'false');
        }
        
        function setFieldInvalid(el) {
          el.classList.remove('success-border', 'border-gray-300');
          el.classList.add('border-red-500', 'error-shake');
          el.setAttribute('aria-invalid', 'true');
          
          setTimeout(() => {
            el.classList.remove('error-shake');
          }, 500);
        }
        
        function clearFieldState(el) {
          el.classList.remove('success-border', 'border-red-500', 'border-red-300', 'error-shake');
          el.classList.add('border-gray-300');
          el.setAttribute('aria-invalid', 'false');
        }

        // Password Strength Calculator
        function calculatePasswordStrength(password) {
          let score = 0;
          
          // Length check
          if (password.length >= 8) score++;
          if (password.length >= 12) score++;
          
          // Character variety
          if (/[A-Z]/.test(password)) score++;
          if (/\d/.test(password)) score++;
          if (/[!@#$%^&*(),.?":{}|<>]/.test(password)) score++;
          
          return score;
        }

        function updatePasswordStrength(password) {
          const score = calculatePasswordStrength(password);
          
          // Update strength meter
          passwordStrength.className = 'password-strength';
          if (score <= 2) {
            passwordStrength.classList.add('strength-weak');
            strengthText.textContent = 'Weak';
            strengthText.className = 'font-medium text-red-600';
          } else if (score <= 3) {
            passwordStrength.classList.add('strength-fair');
            strengthText.textContent = 'Fair';
            strengthText.className = 'font-medium text-yellow-600';
          } else if (score <= 4) {
            passwordStrength.classList.add('strength-good');
            strengthText.textContent = 'Good';
            strengthText.className = 'font-medium text-green-600';
          } else {
            passwordStrength.classList.add('strength-strong');
            strengthText.textContent = 'Strong';
            strengthText.className = 'font-medium text-emerald-700';
          }
          
          // Update requirement indicators
          Object.entries(requirements).forEach(([key, req]) => {
            const isValid = req.regex.test(password);
            const icon = req.element.querySelector('i');
            const text = req.element.querySelector('span');
            
            if (isValid) {
              icon.className = 'fas fa-check text-green-500 mr-1 text-xs';
              text.className = 'text-green-600';
            } else {
              icon.className = 'fas fa-times text-red-500 mr-1 text-xs';
              text.className = 'text-gray-600';
            }
          });
        }

        // Validation Functions
        function validateNewPassword(password) {
          if (!password) {
            return { valid: false, message: 'Password is required.' };
          }
          
          const unmetRequirements = Object.entries(requirements)
            .filter(([key, req]) => !req.regex.test(password))
            .map(([key]) => key);
            
          if (unmetRequirements.length > 0) {
            return { valid: false, message: 'Password must meet all requirements.' };
          }
          
          return { valid: true, message: '' };
        }

        function validateConfirmPassword(confirm, original) {
          if (!confirm) {
            return { valid: false, message: 'Please confirm your password.' };
          }
          if (confirm !== original) {
            return { valid: false, message: 'Passwords do not match.' };
          }
          return { valid: true, message: '' };
        }

        // Show/Hide Error Functions
        function showPasswordError(message) {
          passwordError.querySelector('span').textContent = message;
          passwordError.classList.remove('hidden');
          setFieldInvalid(newPassword);
        }

        function hidePasswordError() {
          passwordError.classList.add('hidden');
          setFieldValid(newPassword);
        }

        function showConfirmError(message) {
          confirmError.querySelector('span').textContent = message;
          confirmError.classList.remove('hidden');
          setFieldInvalid(confirmPassword);
        }

        function hideConfirmError() {
          confirmError.classList.add('hidden');
          setFieldValid(confirmPassword);
        }

        // Real-time Validation
        newPassword.addEventListener('input', () => {
          const password = newPassword.value;
          updatePasswordStrength(password);
          
          const result = validateNewPassword(password);
          if (result.valid) {
            hidePasswordError();
          } else {
            if (touched.newPassword || password.length > 0) {
              showPasswordError(result.message);
            } else {
              clearFieldState(newPassword);
              passwordError.classList.add('hidden');
            }
          }
          
          // Also validate confirm password when new password changes
          if (confirmPassword.value) {
            const confirmResult = validateConfirmPassword(confirmPassword.value, password);
            if (confirmResult.valid) {
              hideConfirmError();
            } else {
              showConfirmError(confirmResult.message);
            }
          }
          
          updateSubmitButton();
        });

        confirmPassword.addEventListener('input', () => {
          const result = validateConfirmPassword(confirmPassword.value, newPassword.value);
          if (result.valid) {
            hideConfirmError();
          } else {
            if (touched.confirmPassword || confirmPassword.value.length > 0) {
              showConfirmError(result.message);
            } else {
              clearFieldState(confirmPassword);
              confirmError.classList.add('hidden');
            }
          }
          updateSubmitButton();
        });

        // Blur Validation
        newPassword.addEventListener('blur', () => {
          touched.newPassword = true;
          const result = validateNewPassword(newPassword.value);
          if (!result.valid) {
            showPasswordError(result.message);
          } else {
            hidePasswordError();
          }
          updateSubmitButton();
        });

        confirmPassword.addEventListener('blur', () => {
          touched.confirmPassword = true;
          const result = validateConfirmPassword(confirmPassword.value, newPassword.value);
          if (!result.valid) {
            showConfirmError(result.message);
          } else {
            hideConfirmError();
          }
          updateSubmitButton();
        });

        // Update Submit Button State
        function updateSubmitButton() {
          const passwordValid = validateNewPassword(newPassword.value).valid;
          const confirmValid = validateConfirmPassword(confirmPassword.value, newPassword.value).valid;
          
          submitBtn.disabled = !(passwordValid && confirmValid);
        }

        // Toggle Password Visibility
        toggleNewPwd.addEventListener('click', () => {
          const isPwd = newPassword.type === 'password';
          newPassword.type = isPwd ? 'text' : 'password';
          toggleNewPwd.innerHTML = isPwd 
            ? '<i class="fa-regular fa-eye-slash"></i>' 
            : '<i class="fa-regular fa-eye"></i>';
        });

        toggleConfirmPwd.addEventListener('click', () => {
          const isPwd = confirmPassword.type === 'password';
          confirmPassword.type = isPwd ? 'text' : 'password';
          toggleConfirmPwd.innerHTML = isPwd 
            ? '<i class="fa-regular fa-eye-slash"></i>' 
            : '<i class="fa-regular fa-eye"></i>';
        });

        // Form Submission
        form.addEventListener('submit', function (e) {
          e.preventDefault();

          // Show loading state
          submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Resetting Password...';
          submitBtn.disabled = true;

          // Mark fields as touched
          touched.newPassword = true;
          touched.confirmPassword = true;

          const passwordResult = validateNewPassword(newPassword.value);
          const confirmResult = validateConfirmPassword(confirmPassword.value, newPassword.value);

          if (!passwordResult.valid) {
            showPasswordError(passwordResult.message);
          } else {
            hidePasswordError();
          }

          if (!confirmResult.valid) {
            showConfirmError(confirmResult.message);
          } else {
            hideConfirmError();
          }

          if (!passwordResult.valid || !confirmResult.valid) {
            // Reset button state
            submitBtn.innerHTML = '<i class="fas fa-key mr-2"></i> Reset Password';
            updateSubmitButton();
            
            // Focus first invalid field
            if (!passwordResult.valid) newPassword.focus();
            else if (!confirmResult.valid) confirmPassword.focus();
            return;
          }

          // All validations passed - submit form
          setTimeout(() => {
            form.submit();
          }, 1000);
        });

        // Initialize
        clearFieldState(newPassword);
        clearFieldState(confirmPassword);
        updatePasswordStrength('');

      })();
    </script>

    <script>
      // Prevent back navigation
      if (window.history && window.history.replaceState) {
        window.history.pushState(null, null, window.location.href);
        window.onpopstate = function () {
          window.history.go(1);
        };
      }
    </script>
  </body>
</html>