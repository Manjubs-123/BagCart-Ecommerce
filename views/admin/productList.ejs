<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Products | Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="flex">

    <%- include('../partials/sidebar') %>

    <main class="flex-1 p-8 ml-64 bg-gray-50">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">Products Detail</h2>
            <a href="/admin/products/add" 
                class="bg-emerald-800 text-white px-5 py-2 rounded hover:bg-emerald-900 transition">
                Add New Product
            </a>
        </div>

        <form action="/admin/products" method="get" class="flex items-center mb-6 max-w-xs">
            
            <input 
                type="text" 
                name="q" 
                value="<%= q || '' %>" 
                placeholder="Search product"
                class="border border-gray-300 rounded-l-md px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-emerald-700"
            />
            <button type="submit" class="bg-emerald-800 text-white px-4 py-2 rounded-r-md hover:bg-emerald-900">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.69l4.34 4.34a1 1 0 01-1.42 1.42l-4.34-4.34A6 6 0 012 8z" clip-rule="evenodd" />
                </svg>
            </button>
            <a href="/admin/products" class="bg-gray-400 text-white px-4 py-2 rounded ml-2 hover:bg-gray-500">
                Clear
            </a>
        </form>

        <div class="overflow-x-auto rounded-xl shadow-sm border border-gray-200">
            <table class="min-w-full text-left text-gray-700">
                <thead class="bg-gray-100 text-sm font-semibold">
                    <tr>
                        <th class="px-6 py-3">productName</th>
                        <th class="px-6 py-3">Brand</th>
                        <th class="px-6 py-3">Category</th>
                        <th class="px-6 py-3">Price</th>
                        <th class="px-6 py-3">Stock</th>
                        <th class="px-6 py-3">Status</th>
                        <th class="px-6 py-3 text-center">Action</th>
                    </tr>
                </thead>
                <tbody>
                    <% products.forEach(product => { %>
                        <% // Iterate over variants to list all rows %>
                                                    <tr class="border-t hover:bg-gray-50">
                                <td class="px-6 py-3"><%= product.productName %></td>
                                <td class="px-6 py-3"><%= product.brand %></td>
                                <td class="px-6 py-3"><%= product.category.name %></td>
                                <td class="px-6 py-3">
                                    <span class="font-medium <%= product.isActive ? 'text-green-600' : 'text-red-600' %>">
                                        <%= product.isActive ? 'Active' : 'Blocked' %>
                                    </span>
                                </td>
                                <td class="px-6 py-3 flex gap-2 justify-center">
                                    <a href="/admin/products/edit/<%= product._id %>"
                                        class="bg-emerald-800 text-white px-4 py-1 rounded hover:bg-emerald-900">
                                        Edit
                                    </a>
                                    <button
                                        onclick="confirmSoftDelete('<%= product._id %>')"
                                        class="bg-red-700 text-white px-4 py-1 rounded hover:bg-red-800">
                                        Remove
                                    </button>
                                     <button
                                        onclick="toggleProductStatus('<%= product._id %>', <%= product.isActive %>)"
                                        class="<%= product.isActive ? 'bg-red-500' : 'bg-green-500' %> text-white px-4 py-1 rounded hover:opacity-80">
                                        <%= product.isActive ? 'Block' : 'Unblock' %>
                                    </button>
                                </td>
                            </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>

        <div class="flex justify-center items-center gap-2 mt-6">
            </div>

    </main>

<script>
    // ------------------------------------
    // 1. TOGGLE STATUS (Block/Unblock)
    // ------------------------------------
    function toggleProductStatus(id, isActive) {
        const action = isActive ? 'block' : 'unblock';
        
        Swal.fire({
            title: `Are you sure you want to ${action} this product?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: `Yes, ${action}!`
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/admin/products/toggle-status/${id}`, { method: 'POST' })
                    .then(res => res.json())
                    .then(data => {
                        Swal.fire({
                            title: data.message,
                            icon: 'success',
                            timer: 1200,
                            showConfirmButton: false
                        }).then(() => location.reload());
                    })
                    .catch(error => {
                        Swal.fire('Error', 'Failed to toggle status.', 'error');
                    });
            }
        });
    }

    // ------------------------------------
    // 2. SOFT DELETE (Sets isDeleted: true)
    // ------------------------------------
    function confirmSoftDelete(id) {
        Swal.fire({
            title: "Are you sure?",
            text: "This product will be permanently soft-deleted (removed from active view).",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#d33",
            cancelButtonColor: "#3085d6",
            confirmButtonText: "Yes, remove it!"
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/admin/products/delete/${id}`, { method: "POST" })
                    .then(res => res.json())
                    .then(data => {
                        Swal.fire({
                            title: data.message,
                            icon: "success",
                            timer: 1500,
                            showConfirmButton: false
                        }).then(() => {
                            window.location.reload();
                        });
                    })
                    .catch(error => {
                        Swal.fire('Error', 'Failed to soft delete product.', 'error');
                    });
            }
        });
    }
</script>

</body>
</html>