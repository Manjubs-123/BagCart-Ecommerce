<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Product | Admin - BagHub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        .card-hover {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        .sidebar {
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
        }

        .sidebar::-webkit-scrollbar {
            width: 4px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 20px;
        }

        .sidebar::-webkit-scrollbar-thumb:hover {
            background-color: rgba(255, 255, 255, 0.5);
        }

        .nav-link-active {
            background: rgba(255, 255, 255, 0.15);
            border-left-color: #3b82f6;
            padding-left: 12px;
        }

        .nav-link-active .nav-icon {
            background: rgba(59, 130, 246, 0.3);
        }

        .nav-link-active span {
            color: white;
            font-weight: 600;
        }
        
        .cropper-container {
            max-height: 500px;
        }
        
        /* Professional Validation Styles */
        .input-error {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
            background-color: #fef2f2 !important;
        }
        
        .input-success {
            border-color: #10b981 !important;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1) !important;
            background-color: #f0fdf4 !important;
        }
        
        .error-message {
            color: #ef4444;
            font-size: 0.75rem;
            margin-top: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }
        
        .success-message {
            color: #10b981;
            font-size: 0.75rem;
            margin-top: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }
        
        .validation-icon {
            width: 16px;
            height: 16px;
        }
        
        .field-group {
            margin-bottom: 1.5rem;
            position: relative;
        }
        
        .required-field::after {
            content: " *";
            color: #ef4444;
        }
        
        .form-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #374151;
        }
        
        .form-helper {
            color: #6b7280;
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }
        
        .variant-counter {
            background: linear-gradient(135deg, #8b5cf6, #a855f7);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .image-preview-container {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid #e5e7eb;
            transition: all 0.3s ease;
        }
        
        .image-preview-container:hover {
            border-color: #3b82f6;
            transform: scale(1.02);
        }
        
        .progress-bar {
            height: 4px;
            background: linear-gradient(90deg, #3b82f6, #10b981);
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        
        .floating-label {
            position: absolute;
            top: -8px;
            left: 12px;
            background: white;
            padding: 0 8px;
            font-size: 0.75rem;
            font-weight: 600;
            color: #374151;
            z-index: 10;
        }
        
        .stats-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 1.5rem;
        }
        
        .existing-image-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #10b981;
            color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 0.7rem;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans flex flex-col min-h-screen">

    <!-- Main Layout Container -->
    <div class="flex flex-1">
        <!-- Include Sidebar -->
        <%- include('../partials/sidebar', { currentPage: 'products' }) %>

        <!-- Main Content -->
        <main class="flex-1 p-8 ml-64 min-h-screen">
            <!-- Page Header -->
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">Edit Product</h1>
                    <p class="text-gray-600">Update product details and manage variants</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <i class="fas fa-bell text-gray-500 text-xl hover:text-blue-600 cursor-pointer transition-colors"></i>
                        <span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-4 h-4 flex items-center justify-center">3</span>
                    </div>
                    <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-emerald-500 rounded-full flex items-center justify-center shadow-md">
                        <span class="text-white font-semibold text-sm">A</span>
                    </div>
                </div>
            </div>

            <!-- Stats Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="stats-card card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Product Status</p>
                            <p class="text-lg font-bold text-gray-800">
                                <%= product.isActive ? 'Active' : 'Inactive' %>
                            </p>
                        </div>
                        <div class="w-10 h-10 <%= product.isActive ? 'bg-green-100' : 'bg-red-100' %> rounded-xl flex items-center justify-center">
                            <i class="fas <%= product.isActive ? 'fa-check-circle text-green-600' : 'fa-times-circle text-red-600' %>"></i>
                        </div>
                    </div>
                </div>
                
                <div class="stats-card card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Total Variants</p>
                            <p class="text-lg font-bold text-gray-800"><%= product.variants.length %></p>
                        </div>
                        <div class="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center">
                            <i class="fas fa-layer-group text-blue-600"></i>
                        </div>
                    </div>
                </div>
                
                <div class="stats-card card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Total Images</p>
                            <p class="text-lg font-bold text-gray-800" id="totalImagesCount">0</p>
                        </div>
                        <div class="w-10 h-10 bg-purple-100 rounded-xl flex items-center justify-center">
                            <i class="fas fa-images text-purple-600"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Form -->
            <div class="max-w-6xl mx-auto">
                <form id="productForm" class="space-y-6">
                    
                    <!-- Basic Information Card -->
                    <div class="bg-white rounded-2xl shadow-lg p-6 card-hover border-l-4 border-blue-500">
                        <div class="flex items-center mb-6">
                            <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                                <i class="fas fa-info-circle text-blue-600 text-lg"></i>
                            </div>
                            <div class="ml-4">
                                <h2 class="text-xl font-bold text-gray-800">Basic Information</h2>
                                <p class="text-gray-600 text-sm">Update core product details</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Product Name -->
                            <div class="field-group md:col-span-2">
                                <label class="form-label required-field">
                                    <i class="fas fa-tag text-blue-500 text-sm"></i>
                                    Product Name
                                </label>
                                <input type="text" 
                                       name="name" 
                                       id="name" 
                                       required 
                                       value="<%= product.name %>"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
                                       placeholder="Enter product name"
                                       onblur="validateField('name')"
                                       oninput="validateField('name')">
                                <div id="name-error" class="error-message hidden">
                                    <i class="fas fa-exclamation-circle validation-icon"></i>
                                    <span>Product name must be 3-100 characters</span>
                                </div>
                                <div id="name-success" class="success-message hidden">
                                    <i class="fas fa-check-circle validation-icon"></i>
                                    <span>Perfect product name!</span>
                                </div>
                            </div>

                            <!-- Description -->
                            <div class="field-group md:col-span-2">
                                <label class="form-label required-field">
                                    <i class="fas fa-align-left text-blue-500 text-sm"></i>
                                    Description
                                </label>
                                <textarea name="description" 
                                          id="description" 
                                          required 
                                          rows="4"
                                          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
                                          placeholder="Enter detailed product description"
                                          onblur="validateField('description')"
                                          oninput="validateField('description')"><%= product.description %></textarea>
                                <div id="description-error" class="error-message hidden">
                                    <i class="fas fa-exclamation-circle validation-icon"></i>
                                    <span>Description must be 10-2000 characters</span>
                                </div>
                                <div id="description-success" class="success-message hidden">
                                    <i class="fas fa-check-circle validation-icon"></i>
                                    <span>Great description!</span>
                                </div>
                            </div>

                            <!-- Brand -->
                            <div class="field-group">
                                <label class="form-label required-field">
                                    <i class="fas fa-copyright text-blue-500 text-sm"></i>
                                    Brand
                                </label>
                                <input type="text" 
                                       name="brand" 
                                       id="brand" 
                                       required
                                       value="<%= product.brand %>"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
                                       placeholder="Enter brand name"
                                       onblur="validateField('brand')"
                                       oninput="validateField('brand')">
                                <div id="brand-error" class="error-message hidden">
                                    <i class="fas fa-exclamation-circle validation-icon"></i>
                                    <span>Brand name must be 2-50 characters</span>
                                </div>
                                <div id="brand-success" class="success-message hidden">
                                    <i class="fas fa-check-circle validation-icon"></i>
                                    <span>Brand name accepted!</span>
                                </div>
                            </div>

                            <!-- Category -->
                            <div class="field-group">
                                <label class="form-label required-field">
                                    <i class="fas fa-folder text-blue-500 text-sm"></i>
                                    Category
                                </label>
                                <select name="category" 
                                        id="category" 
                                        required
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 bg-white"
                                        onblur="validateField('category')"
                                        onchange="validateField('category')">
                                    <option value="">Select a category</option>
                                    <% categories.forEach(category => { %>
                                        <option value="<%= category._id %>" <%= product.category._id.toString() === category._id.toString() ? 'selected' : '' %>>
                                            <%= category.name %>
                                        </option>
                                    <% }); %>
                                </select>
                                <div id="category-error" class="error-message hidden">
                                    <i class="fas fa-exclamation-circle validation-icon"></i>
                                    <span>Please select a category</span>
                                </div>
                                <div id="category-success" class="success-message hidden">
                                    <i class="fas fa-check-circle validation-icon"></i>
                                    <span>Category selected!</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Product Variants Card -->
                    <div class="bg-white rounded-2xl shadow-lg p-6 card-hover border-l-4 border-green-500">
                        <div class="flex justify-between items-center mb-6">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-palette text-green-600 text-lg"></i>
                                </div>
                                <div class="ml-4">
                                    <h2 class="text-xl font-bold text-gray-800">Product Variants</h2>
                                    <p class="text-gray-600 text-sm">Manage colors, prices and inventory</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium" id="variantsCount">
                                    <%= product.variants.length %> Variants
                                </span>
                                <button type="button" 
                                        onclick="addVariant()" 
                                        class="bg-gradient-to-r from-green-600 to-green-700 text-white px-5 py-2.5 rounded-lg hover:from-green-700 hover:to-green-800 transition-all flex items-center gap-2 action-btn shadow-md">
                                    <i class="fas fa-plus"></i>
                                    <span>Add Variant</span>
                                </button>
                            </div>
                        </div>

                        <div id="variantsContainer" class="space-y-6"></div>
                    </div>

                    <!-- Form Actions -->
                    <div class="flex justify-between items-center pt-8 border-t border-gray-200">
                        <div class="flex items-center gap-3 text-sm text-gray-600">
                            <i class="fas fa-history text-blue-500"></i>
                            <span>Last updated: <%= new Date(product.updatedAt).toLocaleDateString() %></span>
                        </div>
                        <div class="flex gap-3">
                            <a href="/admin/products" 
                               class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-8 py-3 rounded-lg transition duration-200 shadow-md font-medium flex items-center gap-2">
                                <i class="fas fa-arrow-left"></i>
                                <span>Cancel</span>
                            </a>
                            <button type="submit" 
                                    id="submitBtn"
                                    class="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white px-8 py-3 rounded-lg transition duration-200 shadow-md font-medium flex items-center gap-2 action-btn">
                                <i class="fas fa-save"></i>
                                <span>Update Product</span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <!-- Image Crop Modal -->
    <div id="cropModal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full mx-4 overflow-hidden">
            <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-4">
                <h3 class="text-xl font-bold text-white flex items-center gap-2">
                    <i class="fas fa-crop"></i>
                    Crop Product Image
                </h3>
            </div>
            <div class="p-6">
                <div class="mb-4 bg-gray-100 rounded-lg p-4">
                    <img id="cropImage" class="max-w-full mx-auto" style="max-height: 400px;">
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-600">
                        <i class="fas fa-info-circle text-blue-500 mr-1"></i>
                        Crop image to square aspect ratio (1:1)
                    </span>
                    <div class="flex gap-3">
                        <button type="button" 
                                onclick="closeCropModal()" 
                                class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-2.5 rounded-lg font-medium transition duration-200 flex items-center gap-2">
                            <i class="fas fa-times"></i>
                            <span>Cancel</span>
                        </button>
                        <button type="button" 
                                onclick="cropImage()" 
                                class="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white px-6 py-2.5 rounded-lg font-medium transition duration-200 flex items-center gap-2 action-btn">
                            <i class="fas fa-check"></i>
                            <span>Crop & Continue</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
  let variantCount = 0;
  let cropper = null;
  let replaceTarget = { variantIndex: null, slotIndex: null };
  const variants = [];
  const colors = <%- JSON.stringify(colors) %>;
  const existingProduct = <%- JSON.stringify(product || {}) %>;
  let totalImages = 0;

  // ✅ Initialize with existing variants (force 3 slots)
//   function initializeExistingVariants() {
//     if (!existingProduct || !Array.isArray(existingProduct.variants)) {
//       console.warn("⚠️ No existing variants found!");
//       return;
//     }

//     existingProduct.variants.forEach((variant, index) => {
//       if (!variant) return;
//       variants.push({
//         color: variant.color,
//         price: variant.price,
//         stock: variant.stock,
//         images: [0, 1, 2].map(i => {
//           const img = (variant.images || [])[i];
//           return img ? { url: img.url, publicId: img.publicId, isExisting: true } : null;
//         })
//       });

//       renderVariant(index);
//       variantCount++;
//       totalImages += variant.images?.length || 0;
//     });

//     document.getElementById('totalImagesCount').textContent = totalImages;
//   }

// function initializeExistingVariants() {
//   if (!existingProduct || !Array.isArray(existingProduct.variants)) {
//     console.warn("⚠️ No existing variants found!");
//     return;
//   }

//   existingProduct.variants.forEach((variant, index) => {
//     if (!variant) return;

//     // Push variant as-is with all its images
//     variants.push({
//       color: variant.color,
//       price: variant.price,
//       stock: variant.stock,
//       // ✅ Use ALL images from DB (not just 3)
//       images: (variant.images || []).map(img => ({
//         url: img.url,
//         publicId: img.publicId,
//         isExisting: true
//       }))
//     });

//     renderVariant(index);
//     variantCount++;
//   });

//   // Show total image count dynamically
//   const totalImages = variants.reduce(
//     (acc, v) => acc + (v.images ? v.images.length : 0),
//     0
//   );
//   document.getElementById("totalImagesCount").textContent = totalImages;
// }
function initializeExistingVariants() {
  if (!existingProduct || !Array.isArray(existingProduct.variants)) {
    console.warn("⚠️ No existing variants found!");
    return;
  }
  

  existingProduct.variants.forEach((variant, index) => {
    if (!variant) return;

    // Push variant as-is with all its images
    variants.push({
      color: variant.color,
      price: variant.price,
      stock: variant.stock,
      // ✅ Use ALL images from DB (not just 3)
      images: (variant.images || []).map(img => ({
        url: img.url,
        publicId: img.publicId,
        isExisting: true
      }))
    });

    renderVariant(index);
    variantCount++;
  });

  // Show total image count dynamically
  const totalImages = variants.reduce(
    (acc, v) => acc + (v.images ? v.images.length : 0),
    0
  );
  document.getElementById("totalImagesCount").textContent = totalImages;
}


  // ✅ Field validation
  const validationRules = {
    name: { min: 3, max: 100, pattern: /^[a-zA-Z0-9\s\-&.,()]+$/, message: 'Product name must be 3-100 characters with only letters, numbers, and punctuation' },
    description: { min: 10, max: 2000, message: 'Description must be 10-2000 characters' },
    brand: { min: 2, max: 50, pattern: /^[a-zA-Z0-9\s\-&.,()]+$/, message: 'Brand must be 2-50 characters' },
    category: { required: true, message: 'Please select a category' }
  };

  function validateField(fieldName) {
    const field = document.getElementById(fieldName);
    const value = field.value.trim();
    const rules = validationRules[fieldName];
    let isValid = true;
    let message = '';

    if (fieldName === 'category') {
      isValid = value !== '';
      message = isValid ? '' : rules.message;
    } else {
      if (!value) { isValid = false; message = 'This field is required'; }
      else if (value.length < rules.min) { isValid = false; message = `Minimum ${rules.min} characters required`; }
      else if (value.length > rules.max) { isValid = false; message = `Maximum ${rules.max} characters allowed`; }
      else if (rules.pattern && !rules.pattern.test(value)) { isValid = false; message = rules.message; }
    }

    const err = document.getElementById(`${fieldName}-error`);
    const ok = document.getElementById(`${fieldName}-success`);
    if (isValid) {
      field.classList.remove('input-error'); field.classList.add('input-success');
      err?.classList.add('hidden'); ok?.classList.remove('hidden');
    } else {
      field.classList.add('input-error'); field.classList.remove('input-success');
      err?.classList.remove('hidden'); ok?.classList.add('hidden');
      err.innerHTML = `<i class="fas fa-exclamation-circle validation-icon"></i><span>${message}</span>`;
    }
    return isValid;
  }

  function validateVariantField(variantIndex, fieldType, value) {
    let valid = true, msg = '';
    if (fieldType === 'color') { valid = value !== ''; msg = 'Please select a color'; }
    if (fieldType === 'price') { const p = parseFloat(value); valid = !isNaN(p) && p > 0; msg = 'Price must be > 0'; }
    if (fieldType === 'stock') { const s = parseInt(value); valid = !isNaN(s) && s >= 0; msg = 'Stock must be >= 0'; }

    const err = document.getElementById(`${fieldType}-error-${variantIndex}`);
    const ok = document.getElementById(`${fieldType}-success-${variantIndex}`);
    if (valid) { err?.classList.add('hidden'); ok?.classList.remove('hidden'); }
    else { err?.classList.remove('hidden'); ok?.classList.add('hidden'); err.innerHTML = `<i class="fas fa-exclamation-circle validation-icon"></i><span>${msg}</span>`; }
    return valid;
  }

  // ✅ Render each variant card with 3 image slots
//   function renderVariant(index) {
//     const container = document.getElementById('variantsContainer');
//     const v = variants[index];

//     const makeSlot = (slotIdx) => {
//       const slot = v.images[slotIdx];
//       const badge = slot ? (slot.isExisting ? 'Existing' : 'New') : 'Empty';
//       const content = slot
//         ? `<img src="${slot.url}" class="w-full h-32 object-cover rounded-xl">`
//         : `<div class="w-full h-32 rounded-xl bg-gray-100 flex items-center justify-center text-gray-400">Empty</div>`;
//       return `
//         <div class="relative border-2 border-gray-200 rounded-xl p-2">
//           ${content}
//           <div class="absolute top-2 left-2 bg-blue-600 text-white text-xs px-2 py-1 rounded-full">Slot ${slotIdx + 1} • ${badge}</div>
//           <div class="flex gap-2 mt-2">
//             <label class="flex-1">
//               <input type="file" accept="image/*" class="hidden" onchange="startReplaceUpload(event, ${index}, ${slotIdx})">
//               <span class="w-full text-center block px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 cursor-pointer">Replace</span>
//             </label>
//             ${slot ? `<button type="button" class="px-3 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700" onclick="clearSlot(${index}, ${slotIdx})">Clear</button>` : ''}
//           </div>
//         </div>`;
//     };

//     const html = `
//       <div id="variant-${index}" class="variant-card border-2 border-gray-200 rounded-xl p-6 bg-white">
//         <div class="mt-4">
//           <label class="form-label required-field"><i class="fas fa-images text-blue-500 text-sm"></i> Product Images</label>
//           <div class="grid grid-cols-1 sm:grid-cols-3 gap-4" id="images-grid-${index}">
//             ${[0, 1, 2].map(makeSlot).join('')}
//           </div>
//           <p class="mt-2 text-xs text-gray-500">Exactly 3 images required. Use Replace to change.</p>
//         </div>
//       </div>`;
//     container.insertAdjacentHTML('beforeend', html);
//   }


function renderVariant(index) {
  const container = document.getElementById("variantsContainer");
  const v = variants[index];
  const colorOptions = colors
    .map(
      (c) =>
        `<option value="${c}" ${v.color === c ? "selected" : ""}>${c}</option>`
    )
    .join("");

  // ✅ Dynamic slots based on actual image count
 // ✅ Ensure at least 3 image slots for every variant
const imageCount = Math.max(3, (v.images || []).length);

const makeSlot = (slotIdx) => {
  const slot = v.images[slotIdx] || null;
    const badge = slot ? (slot.isExisting ? "Existing" : "New") : "Empty";
    const content = slot
      ? `<img src="${slot.url}" class="w-full h-32 object-cover rounded-xl">`
      : `<div class="w-full h-32 rounded-xl bg-gray-100 flex items-center justify-center text-gray-400">Empty</div>`;

    return `
      <div class="relative border-2 border-gray-200 rounded-xl p-2">
        ${content}
        <div class="absolute top-2 left-2 bg-blue-600 text-white text-xs px-2 py-1 rounded-full">
          Slot ${slotIdx + 1} • ${badge}
        </div>
        <div class="flex gap-2 mt-2">
          <label class="flex-1">
            <input type="file" accept="image/*" class="hidden" onchange="startReplaceUpload(event, ${index}, ${slotIdx})">
            <span class="w-full text-center block px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 cursor-pointer">Replace</span>
          </label>
          ${slot ? `<button type="button" class="px-3 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700" onclick="clearSlot(${index}, ${slotIdx})">Clear</button>` : ""}
        </div>
      </div>`;
  };

  // ✅ Render based on variant’s own image count
  const html = `
    <div id="variant-${index}" class="variant-card border-2 border-gray-200 rounded-xl p-6 bg-gradient-to-br from-white to-gray-50 mb-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold text-gray-800">Variant ${index + 1}</h3>
        <button type="button" onclick="removeVariant(${index})" class="bg-red-500 text-white px-3 py-2 rounded-md hover:bg-red-600 transition duration-200">
          <i class="fas fa-trash"></i> Remove
        </button>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <div class="field-group">
          <label class="form-label required-field">
            <i class="fas fa-palette text-purple-500 text-sm"></i> Color
          </label>
          <select onchange="updateVariantColor(${index}, this.value)" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
            <option value="">Select color</option>
            ${colorOptions}
          </select>
        </div>

        <div class="field-group">
          <label class="form-label required-field"><i class="fas fa-tag text-green-500 text-sm"></i> Price (₹)</label>
          <input type="number" min="1" step="0.01" value="${v.price || ""}" oninput="updateVariantPrice(${index}, this.value)" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
        </div>

        <div class="field-group">
          <label class="form-label required-field"><i class="fas fa-box text-orange-500 text-sm"></i> Stock</label>
          <input type="number" min="0" step="1" value="${v.stock || ""}" oninput="updateVariantStock(${index}, this.value)" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
        </div>
      </div>

      <div class="bg-blue-50 border-2 border-dashed border-blue-300 rounded-xl p-6">
        <label class="form-label required-field">
          <i class="fas fa-images text-blue-500 text-sm"></i> Product Images
        </label>
       <div id="images-grid-${index}" class="grid grid-cols-1 sm:grid-cols-${imageCount} gap-4">
  ${Array.from({ length: imageCount }).map((_, i) => makeSlot(i)).join("")}
</div>

        <p class="mt-2 text-xs text-gray-500">
  You can replace existing images or clear them. 
  Minimum 3 slots are always available.
</p>

      </div>
    </div>`;
  container.insertAdjacentHTML("beforeend", html);
}
// function renderVariant(index) {
//   const container = document.getElementById("variantsContainer");
//   const v = variants[index];

//   const colorOptions = colors
//     .map(
//       (c) =>
//         `<option value="${c}" ${v.color === c ? "selected" : ""}>${c}</option>`
//     )
//     .join("");

//   const makeSlot = (slotIdx) => {
//     const slot = v.images[slotIdx];
//     const badge = slot ? (slot.isExisting ? "Existing" : "New") : "Empty";
//     const content = slot
//       ? `<img src="${slot.url}" class="w-full h-32 object-cover rounded-xl">`
//       : `<div class="w-full h-32 rounded-xl bg-gray-100 flex items-center justify-center text-gray-400">Empty</div>`;
//     return `
//       <div class="relative border-2 border-gray-200 rounded-xl p-2">
//         ${content}
//         <div class="absolute top-2 left-2 bg-blue-600 text-white text-xs px-2 py-1 rounded-full">
//           Slot ${slotIdx + 1} • ${badge}
//         </div>
//         <div class="flex gap-2 mt-2">
//           <label class="flex-1">
//             <input type="file" accept="image/*" class="hidden" onchange="startReplaceUpload(event, ${index}, ${slotIdx})">
//             <span class="w-full text-center block px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 cursor-pointer">Replace</span>
//           </label>
//           ${
//             slot
//               ? `<button type="button" class="px-3 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700" onclick="clearSlot(${index}, ${slotIdx})">Clear</button>`
//               : ""
//           }
//         </div>
//       </div>`;
//   };

//   const html = `
//   <div id="variant-${index}" class="variant-card border-2 border-gray-200 rounded-xl p-6 bg-gradient-to-br from-white to-gray-50 mb-6">

//     <!-- Variant Header -->
//     <div class="flex justify-between items-center mb-4">
//       <h3 class="text-lg font-bold text-gray-800">Variant ${index + 1}</h3>
//       <button type="button"
//         onclick="removeVariant(${index})"
//         class="bg-red-500 text-white px-3 py-2 rounded-md hover:bg-red-600 transition duration-200">
//         <i class="fas fa-trash"></i> Remove
//       </button>
//     </div>

//     <!-- Variant Details -->
//     <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
//       <!-- Color -->
//       <div class="field-group">
//         <label class="form-label required-field">
//           <i class="fas fa-palette text-purple-500 text-sm"></i> Color
//         </label>
//         <select onchange="updateVariantColor(${index}, this.value)" 
//                 class="w-full px-4 py-3 border border-gray-300 rounded-lg">
//           <option value="">Select color</option>
//           ${colorOptions}
//         </select>
//         <div id="color-error-${index}" class="error-message hidden"></div>
//         <div id="color-success-${index}" class="success-message hidden">
//           <i class="fas fa-check-circle validation-icon"></i><span>Color selected!</span>
//         </div>
//       </div>

//       <!-- Price -->
//       <div class="field-group">
//         <label class="form-label required-field">
//           <i class="fas fa-tag text-green-500 text-sm"></i> Price (₹)
//         </label>
//         <input type="number" min="1" step="0.01"
//                value="${v.price || ""}"
//                oninput="updateVariantPrice(${index}, this.value)"
//                class="w-full px-4 py-3 border border-gray-300 rounded-lg">
//       </div>

//       <!-- Stock -->
//       <div class="field-group">
//         <label class="form-label required-field">
//           <i class="fas fa-box text-orange-500 text-sm"></i> Stock
//         </label>
//         <input type="number" min="0" step="1"
//                value="${v.stock || ""}"
//                oninput="updateVariantStock(${index}, this.value)"
//                class="w-full px-4 py-3 border border-gray-300 rounded-lg">
//       </div>
//     </div>

//     <!-- Variant Images -->
//     <div class="bg-blue-50 border-2 border-dashed border-blue-300 rounded-xl p-6">
//       <label class="form-label required-field">
//         <i class="fas fa-images text-blue-500 text-sm"></i> Product Images
//       </label>
//       <div id="images-grid-${index}" class="grid grid-cols-1 sm:grid-cols-3 gap-4">
//         ${[0, 1, 2].map(makeSlot).join("")}
//       </div>
//       <p class="mt-2 text-xs text-gray-500">Exactly 3 images are required. Use Replace to change.</p>
//     </div>
//   </div>`;

//   container.insertAdjacentHTML("beforeend", html);
// }


  // === SLOT-BASED IMAGE REPLACE LOGIC ===
  function startReplaceUpload(e, variantIndex, slotIndex) {
    const file = e.target.files?.[0];
    if (!file) return;
    if (file.size > 5 * 1024 * 1024) return Swal.fire({ icon: 'error', title: 'File too large', text: 'Max 5MB' });

    replaceTarget = { variantIndex, slotIndex };
    const reader = new FileReader();
    reader.onload = (ev) => {
      const img = document.getElementById('cropImage');
      img.src = ev.target.result;
      document.getElementById('cropModal').classList.remove('hidden');
      if (cropper) cropper.destroy();
      cropper = new Cropper(img, { aspectRatio: 1, viewMode: 2, autoCropArea: 1, background: false });
    };
    reader.readAsDataURL(file);
  }

  function cropImage() {
    if (!cropper) return;
    const { variantIndex, slotIndex } = replaceTarget;
    const canvas = cropper.getCroppedCanvas({ width: 800, height: 800, imageSmoothingEnabled: true, imageSmoothingQuality: 'high' });
    canvas.toBlob((blob) => {
      const fr = new FileReader();
      fr.onload = (e) => {
        const prev = variants[variantIndex].images[slotIndex];
        const oldPublicId = prev?.publicId || null;
        variants[variantIndex].images[slotIndex] = { url: e.target.result, isExisting: false, replaceOf: oldPublicId };
        renderUpdatedGrid(variantIndex);
        closeCropModal();
      };
      fr.readAsDataURL(blob);
    }, 'image/jpeg', 0.9);
  }

//   function renderUpdatedGrid(variantIndex) {
//     const grid = document.getElementById(`images-grid-${variantIndex}`);
//     grid.innerHTML = [0, 1, 2].map(i => {
//       const slot = variants[variantIndex].images[i];
//       const badge = slot ? (slot.isExisting ? 'Existing' : 'New') : 'Empty';
//       const content = slot
//         ? `<img src="${slot.url}" class="w-full h-32 object-cover rounded-xl">`
//         : `<div class="w-full h-32 rounded-xl bg-gray-100 flex items-center justify-center text-gray-400">Empty</div>`;
//       return `
//         <div class="relative border-2 border-gray-200 rounded-xl p-2">
//           ${content}
//           <div class="absolute top-2 left-2 bg-blue-600 text-white text-xs px-2 py-1 rounded-full">Slot ${i + 1} • ${badge}</div>
//           <div class="flex gap-2 mt-2">
//             <label class="flex-1">
//               <input type="file" accept="image/*" class="hidden" onchange="startReplaceUpload(event, ${variantIndex}, ${i})">
//               <span class="w-full text-center block px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 cursor-pointer">Replace</span>
//             </label>
//             ${slot ? `<button type="button" class="px-3 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700" onclick="clearSlot(${variantIndex}, ${i})">Clear</button>` : ''}
//           </div>
//         </div>`;
//     }).join('');
//   }

function renderUpdatedGrid(variantIndex) {
  const v = variants[variantIndex];
  const grid = document.getElementById(`images-grid-${variantIndex}`);

  grid.innerHTML = v.images
    .map((slot, i) => {
      const badge = slot ? (slot.isExisting ? "Existing" : "New") : "Empty";
      const content = slot
        ? `<img src="${slot.url}" class="w-full h-32 object-cover rounded-xl">`
        : `<div class="w-full h-32 rounded-xl bg-gray-100 flex items-center justify-center text-gray-400">Empty</div>`;
      return `
        <div class="relative border-2 border-gray-200 rounded-xl p-2">
          ${content}
          <div class="absolute top-2 left-2 bg-blue-600 text-white text-xs px-2 py-1 rounded-full">
            Slot ${i + 1} • ${badge}
          </div>
          <div class="flex gap-2 mt-2">
            <label class="flex-1">
              <input type="file" accept="image/*" class="hidden" onchange="startReplaceUpload(event, ${variantIndex}, ${i})">
              <span class="w-full text-center block px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 cursor-pointer">Replace</span>
            </label>
            ${slot ? `<button type="button" class="px-3 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700" onclick="clearSlot(${variantIndex}, ${i})">Clear</button>` : ""}
          </div>
        </div>`;
    })
    .join("");

  // ✅ Update grid column count dynamically
  grid.className = `grid grid-cols-1 sm:grid-cols-${Math.max(3, v.images.length)} gap-4`;
}


  function clearSlot(variantIndex, slotIndex) {
    variants[variantIndex].images[slotIndex] = null;
    renderUpdatedGrid(variantIndex);
  }

  function closeCropModal() {
    document.getElementById('cropModal').classList.add('hidden');
    if (cropper) { cropper.destroy(); cropper = null; }
    replaceTarget = { variantIndex: null, slotIndex: null };
  }

  // ✅ Form submission
  document.getElementById("productForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  // ✅ Validate all main fields
  const valid = ["name", "description", "brand", "category"].every((f) => validateField(f));
 const validVariants = variants.every((v) => 
  v && v.images.filter(Boolean).length === v.images.length
);

  if (!valid || !validVariants) {
    return Swal.fire({
      icon: "error",
      title: "Validation Failed",
      text: "Each variant must have exactly 3 images and all required fields filled.",
    });
  }

  // ✅ Create FormData to send
  const formData = new FormData();
  formData.append("name", document.getElementById("name").value.trim());
  formData.append("description", document.getElementById("description").value.trim());
  formData.append("brand", document.getElementById("brand").value.trim());
  formData.append("category", document.getElementById("category").value);

  // ✅ Send only essential variant data (color, price, stock)
  const simpleVariants = variants.map((v) => ({
    color: v.color,
    price: v.price,
    stock: v.stock,
  }));
  formData.append("variants", JSON.stringify(simpleVariants));

  // ✅ Add new or replaced images as blobs
  variants.forEach((variant, vIndex) => {
    variant.images.forEach((img, imgIdx) => {
      if (img && !img.isExisting) {
        const byteString = atob(img.url.split(",")[1]);
        const mimeString = img.url.split(",")[0].split(":")[1].split(";")[0];
        const ab = new ArrayBuffer(byteString.length);
        const ia = new Uint8Array(ab);
        for (let i = 0; i < byteString.length; i++) ia[i] = byteString.charCodeAt(i);
        const blob = new Blob([ab], { type: mimeString });
        formData.append("images", blob, `variant${vIndex}_slot${imgIdx}.jpg`);
      }
    });
  });

  // ✅ Show loading
  Swal.fire({
    title: "Updating Product...",
    allowOutsideClick: false,
    didOpen: () => Swal.showLoading(),
  });

  // ✅ Send to backend
  const res = await fetch(`/admin/products/edit/<%= product._id %>`, {
    method: "POST",
    body: formData,
  });

  const data = await res.json();

  // ✅ Show result
  if (res.ok) {
    Swal.fire({
      icon: "success",
      title: "Product updated successfully!",
      timer: 1500,
    }).then(() => (window.location.href = "/admin/products"));
  } else {
    Swal.fire({
      icon: "error",
      title: "Update Failed",
      text: data.message || "Something went wrong",
    });
  }
});

//   document.getElementById("productForm").addEventListener("submit", async (e) => {
//     e.preventDefault();
//     const valid = ['name', 'description', 'brand', 'category'].every(f => validateField(f));
//     const validVariants = variants.every(v => v && v.images.filter(Boolean).length === 3);
//     if (!valid || !validVariants) return Swal.fire({ icon: 'error', title: 'Validation Failed', text: 'Each variant must have exactly 3 images.' });

//     const formData = new FormData();
//     formData.append("name", document.getElementById("name").value.trim());
//     formData.append("description", document.getElementById("description").value.trim());
//     formData.append("brand", document.getElementById("brand").value.trim());
//     formData.append("category", document.getElementById("category").value);

//     variants.forEach((variant, vIndex) => {
//       formData.append(`variants[${vIndex}][color]`, variant.color);
//       formData.append(`variants[${vIndex}][price]`, variant.price);
//       formData.append(`variants[${vIndex}][stock]`, variant.stock);
//       variant.images.forEach((img, imgIdx) => {
//         if (img && !img.isExisting) {
//           const byteString = atob(img.url.split(",")[1]);
//           const mimeString = img.url.split(",")[0].split(":")[1].split(";")[0];
//           const ab = new ArrayBuffer(byteString.length);
//           const ia = new Uint8Array(ab);
//           for (let i = 0; i < byteString.length; i++) ia[i] = byteString.charCodeAt(i);
//           const blob = new Blob([ab], { type: mimeString });
//           formData.append("images", blob, `variant${vIndex}_slot${imgIdx}.jpg`);
//         }
//       });

//     });

//     Swal.fire({ title: "Updating Product...", allowOutsideClick: false, didOpen: () => Swal.showLoading() });
//     const res = await fetch(`/admin/products/edit/<%= product._id %>`, { method: "POST", body: formData });
//     const data = await res.json();
//     if (res.ok) Swal.fire({ icon: "success", title: "Updated!", timer: 1500 }).then(() => window.location.href = "/admin/products");
//     else Swal.fire({ icon: "error", title: "Error", text: data.message || "Something went wrong" });
//   });
  function addVariant() {
  if (variants.length >= 5) {
    Swal.fire({
      icon: "warning",
      title: "Limit reached",
      text: "You can add up to 5 variants only.",
    });
    return;
  }

  variants.push({
    color: "",
    price: "",
    stock: "",
    images: [null, null, null],
  });

  renderVariant(variantCount);
  variantCount++;
  document.getElementById("variantsCount").textContent = `${variants.length} Variants`;
}

window.addEventListener('DOMContentLoaded', initializeExistingVariants);


  window.addEventListener('DOMContentLoaded', initializeExistingVariants);
</script>

</body>
</html>