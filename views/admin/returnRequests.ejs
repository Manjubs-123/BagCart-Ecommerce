<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Return Requests Management | Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    .glass-effect {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .card-hover {
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    .card-hover:hover {
      transform: translateY(-2px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    .status-badge {
      padding: 0.5rem 1rem;
      border-radius: 9999px;
      font-size: 0.875rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .status-requested { background-color: #fef3c7; color: #92400e; }
    .status-approved { background-color: #dcfce7; color: #166534; }
    .status-rejected { background-color: #fee2e2; color: #991b1b; }
    .status-refunded { background-color: #dbeafe; color: #1e40af; }
    .status-completed { background-color: #dcfce7; color: #166534; }

    .btn-success {
      background: linear-gradient(135deg, #10b981 0%, #047857 100%);
      transition: all 0.3s ease;
    }

    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    .btn-danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      transition: all 0.3s ease;
    }

    .btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
  </style>
</head>

<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">

  <!-- Sidebar -->
  <%- include('../partials/sidebar', { currentPage: 'returns' }) %>

  <!-- Main Content -->
  <main class="ml-64 flex-1 p-8">
    <!-- Header Section -->
    <div class="mb-8">
      <div class="flex justify-between items-center mb-2">
        <div>
          <h1 class="text-3xl font-bold text-gray-900">Return Requests Management</h1>
          <p class="text-gray-600 mt-1">Review and process customer return requests</p>
        </div>
      </div>
      
      <!-- Stats Cards -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-xl p-6 card-hover border-l-4 border-blue-500">
          <div class="flex justify-between items-center">
            <div>
              <p class="text-sm text-gray-500">Total Returns</p>
              <p class="text-2xl font-bold text-gray-900">
                <% 
                  let totalReturns = 0;
                  orders.forEach(order => {
                    order.items.forEach(item => {
                      if (item.status === 'return-requested') totalReturns++;
                    });
                  });
                %>
                <%= totalReturns %>
              </p>
            </div>
            <div class="bg-blue-100 p-3 rounded-full">
              <i class="fas fa-undo text-blue-600 text-xl"></i>
            </div>
          </div>
        </div>
        
        <div class="bg-white rounded-xl p-6 card-hover border-l-4 border-yellow-500">
          <div class="flex justify-between items-center">
            <div>
              <p class="text-sm text-gray-500">Pending Review</p>
              <p class="text-2xl font-bold text-gray-900">
                <% 
                  let pendingReturns = 0;
                  orders.forEach(order => {
                    order.items.forEach(item => {
                      if (item.status === 'return-requested') pendingReturns++;
                    });
                  });
                %>
                <%= pendingReturns %>
              </p>
            </div>
            <div class="bg-yellow-100 p-3 rounded-full">
              <i class="fas fa-clock text-yellow-600 text-xl"></i>
            </div>
          </div>
        </div>
        
        <div class="bg-white rounded-xl p-6 card-hover border-l-4 border-green-500">
          <div class="flex justify-between items-center">
            <div>
              <p class="text-sm text-gray-500">Approved</p>
              <p class="text-2xl font-bold text-gray-900">
                <% 
                  let approvedReturns = 0;
                  orders.forEach(order => {
                    order.items.forEach(item => {
                      if (item.status === 'returned') approvedReturns++;
                    });
                  });
                %>
                <%= approvedReturns %>
              </p>
            </div>
            <div class="bg-green-100 p-3 rounded-full">
              <i class="fas fa-check-circle text-green-600 text-xl"></i>
            </div>
          </div>
        </div>
        
        <div class="bg-white rounded-xl p-6 card-hover border-l-4 border-red-500">
          <div class="flex justify-between items-center">
            <div>
              <p class="text-sm text-gray-500">Rejected</p>
              <p class="text-2xl font-bold text-gray-900">
                <% 
                  let rejectedReturns = 0;
                  orders.forEach(order => {
                    order.items.forEach(item => {
                      if (item.returnStatus === 'rejected') rejectedReturns++;
                    });
                  });
                %>
                <%= rejectedReturns %>
              </p>
            </div>
            <div class="bg-red-100 p-3 rounded-full">
              <i class="fas fa-times-circle text-red-600 text-xl"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Return Requests List -->
    <div class="space-y-6">
      <% if (orders.length === 0) { %>
        <div class="bg-white rounded-2xl p-12 text-center card-hover">
          <div class="flex flex-col items-center justify-center text-gray-500">
            <i class="fas fa-undo text-6xl mb-4 text-gray-300"></i>
            <h2 class="text-2xl font-bold text-gray-700 mb-2">No Return Requests</h2>
            <p class="text-gray-600 mb-6">No pending return requests found at the moment.</p>
          </div>
        </div>
      <% } else { %>

        <% orders.forEach(order => { %>
          <% order.items.forEach(item => { 
              if (item.status !== 'return-requested') return;
          %>

            <!-- Return Request Card -->
            <div class="bg-white rounded-2xl card-hover overflow-hidden">
              
              <!-- Header -->
              <button 
                onclick="toggleReturn('<%= item._id %>')" 
                class="w-full flex justify-between items-center p-6 text-left bg-gradient-to-r from-blue-50 to-indigo-50 hover:from-blue-100 hover:to-indigo-100 transition-all">
                
                <div class="flex items-center gap-4">
                  <div class="flex-shrink-0">
                    <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                      <i class="fas fa-undo text-purple-600"></i>
                    </div>
                  </div>
                  <div>
                    <h2 class="text-xl font-bold text-gray-900">
                      Return Request - Order #<%= order.orderId || order._id %>
                    </h2>
                    <div class="flex items-center gap-4 mt-2">
                      <span class="status-badge status-requested">
                        <i class="fas fa-clock"></i>
                        Pending Review
                      </span>
                      <p class="text-sm text-gray-600">
                        <i class="far fa-calendar mr-1"></i>
                        <%= new Date(item.returnRequestedDate).toLocaleString() %>
                      </p>
                    </div>
                  </div>
                </div>

                <div class="flex items-center gap-3">
                  <span class="text-lg font-bold text-green-600">
                    Refund: ₹<%= (item.price * item.quantity).toFixed(2) %>
                  </span>
                  <i id="icon-<%= item._id %>" class="fas fa-chevron-down text-gray-600 text-xl transition-transform"></i>
                </div>
              </button>

              <!-- Collapsible Details -->
              <div id="details-<%= item._id %>" class="hidden border-t border-gray-200">
                <div class="p-6 bg-gray-50">
                  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    
                    <!-- Product Information -->
                    <div class="bg-white rounded-xl p-6 card-hover">
                      <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                        <i class="fas fa-box text-blue-600"></i>
                        Product Details
                      </h3>
                      <div class="flex items-start gap-4">
                        <img src="<%= item.image || '/images/no-image.jpg' %>" 
                             alt="<%= item.product.name %>"
                             class="w-20 h-20 object-cover rounded-lg border border-gray-200">
                        <div>
                          <h4 class="font-semibold text-gray-900 mb-2"><%= item.product.name %></h4>
                          <div class="space-y-1 text-sm text-gray-600">
                            <p><strong>Color:</strong> <%= item.color %></p>
                            <p><strong>Quantity:</strong> <%= item.quantity %></p>
                            <p><strong>Unit Price:</strong> ₹<%= item.price %></p>
                            <p><strong>Item Total:</strong> ₹<%= (item.price * item.quantity).toFixed(2) %></p>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Return Reason -->
                    <div class="bg-white rounded-xl p-6 card-hover">
                      <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                        <i class="fas fa-clipboard-list text-orange-600"></i>
                        Return Reason
                      </h3>
                      <div class="space-y-3">
                        <div>
                          <p class="font-semibold text-gray-800 mb-1">Reason</p>
                          <p class="text-gray-700 bg-gray-50 p-3 rounded-lg"><%= item.returnReason %></p>
                        </div>
                        <% if (item.returnDetails) { %>
                          <div>
                            <p class="font-semibold text-gray-800 mb-1">Additional Details</p>
                            <p class="text-gray-600 text-sm bg-gray-50 p-3 rounded-lg"><%= item.returnDetails %></p>
                          </div>
                        <% } %>
                      </div>
                    </div>

                    <!-- Customer & Payment -->
                    <div class="bg-white rounded-xl p-6 card-hover">
                      <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                        <i class="fas fa-user text-green-600"></i>
                        Customer & Payment
                      </h3>
                      <div class="space-y-4">
                        <div>
                          <p class="font-semibold text-gray-800 mb-1">Customer Information</p>
                          <p class="text-gray-700"><%= order.user.name %></p>
                          <p class="text-gray-600 text-sm"><%= order.user.email %></p>
                        </div>
                        
                        <div>
                          <p class="font-semibold text-gray-800 mb-1">Shipping Address</p>
                          <p class="text-gray-600 text-sm">
                            <%= order.shippingAddress.fullName %><br>
                            <%= order.shippingAddress.addressLine1 %><br>
                            <% if (order.shippingAddress.addressLine2) { %>
                              <%= order.shippingAddress.addressLine2 %><br>
                            <% } %>
                            <%= order.shippingAddress.city %>, <%= order.shippingAddress.state %> - <%= order.shippingAddress.pincode %><br>
                            <strong>Phone:</strong> <%= order.shippingAddress.phone %>
                          </p>
                        </div>

                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                          <p class="font-bold text-green-800 text-lg text-center">
                            Refund Amount: ₹<%= (item.price * item.quantity).toFixed(2) %>
                          </p>
                          <p class="text-green-700 text-sm text-center mt-1">
                            Will be credited to user's wallet after approval
                          </p>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Action Buttons -->
                  <div class="flex gap-4 justify-center pt-4 border-t border-gray-200">
                    <button 
                      onclick="approveReturn('<%= order._id %>', '<%= item._id %>', '<%= item.product.name %>', '<%= (item.price * item.quantity).toFixed(2) %>')"
                      class="btn-success text-white px-8 py-3 rounded-xl font-semibold flex items-center gap-3">
                      <i class="fas fa-check-circle"></i>
                      Approve Return & Refund
                    </button>

                    <button 
                      onclick="rejectReturn('<%= order._id %>', '<%= item._id %>', '<%= item.product.name %>')"
                      class="btn-danger text-white px-8 py-3 rounded-xl font-semibold flex items-center gap-3">
                      <i class="fas fa-times-circle"></i>
                      Reject Return
                    </button>
                  </div>
                </div>
              </div>
            </div>

          <% }) %>
        <% }) %>
      <% } %>
    </div>
  </main>

  <script>
    // Toggle return details
    function toggleReturn(id) {
      const box = document.getElementById("details-" + id);
      const icon = document.getElementById("icon-" + id);

      box.classList.toggle("hidden");

      if (box.classList.contains("hidden")) {
        icon.classList.remove("fa-chevron-up");
        icon.classList.add("fa-chevron-down");
      } else {
        icon.classList.remove("fa-chevron-down");
        icon.classList.add("fa-chevron-up");
      }
    }

    // Approve return with SweetAlert
    function approveReturn(orderId, itemId, productName, refundAmount) {
      Swal.fire({
        title: 'Approve Return Request?',
        html: `
          <div class="text-left">
            <p class="mb-3">Are you sure you want to approve the return request for:</p>
            <p class="font-bold text-gray-800">${productName}</p>
            <p class="text-green-600 font-semibold mt-2">Refund Amount: ₹${refundAmount}</p>
            <p class="text-sm text-gray-600 mt-2">This amount will be credited to the user's wallet.</p>
          </div>
        `,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#10b981',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Yes, Approve & Refund!',
        cancelButtonText: 'Cancel',
        showLoaderOnConfirm: true,
        preConfirm: async () => {
          try {
            const response = await fetch(`/admin/orders/returns/${orderId}/item/${itemId}/approve`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              }
            });
            
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            
            return await response.json();
          } catch (error) {
            Swal.showValidationMessage(`Request failed: ${error}`);
          }
        }
      }).then((result) => {
        if (result.isConfirmed) {
          Swal.fire({
            title: 'Return Approved!',
            text: 'Return request has been approved and refund processed successfully.',
            icon: 'success',
            confirmButtonColor: '#10b981',
            timer: 2000,
            showConfirmButton: false
          }).then(() => {
            location.reload();
          });
        }
      });
    }

    // Reject return with SweetAlert
    function rejectReturn(orderId, itemId, productName) {
      Swal.fire({
        title: 'Reject Return Request?',
        html: `
          <div class="text-left">
            <p class="mb-3">Are you sure you want to reject the return request for:</p>
            <p class="font-bold text-gray-800">${productName}</p>
            <p class="text-red-600 font-semibold mt-2">This action cannot be undone.</p>
          </div>
        `,
        icon: 'warning',
        input: 'text',
        inputLabel: 'Rejection Reason',
        inputPlaceholder: 'Enter reason for rejection...',
        inputValidator: (value) => {
          if (!value) {
            return 'Please provide a rejection reason!';
          }
        },
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Yes, Reject Return!',
        cancelButtonText: 'Cancel',
        showLoaderOnConfirm: true,
        preConfirm: async (rejectionReason) => {
          try {
            const response = await fetch(`/admin/orders/returns/${orderId}/item/${itemId}/reject`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ rejectionReason })
            });
            
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            
            return await response.json();
          } catch (error) {
            Swal.showValidationMessage(`Request failed: ${error}`);
          }
        }
      }).then((result) => {
        if (result.isConfirmed) {
          Swal.fire({
            title: 'Return Rejected!',
            text: 'Return request has been rejected successfully.',
            icon: 'success',
            confirmButtonColor: '#ef4444',
            timer: 2000,
            showConfirmButton: false
          }).then(() => {
            location.reload();
          });
        }
      });
    }

    // Show success message if redirected with success parameter
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('success') === 'true') {
      Swal.fire({
        title: 'Success!',
        text: 'Return request processed successfully.',
        icon: 'success',
        timer: 3000,
        showConfirmButton: false
      });
    }
  </script>
</body>
</html>