<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Return Requests Management | Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    /* Responsive styles */
    .glass-effect { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); }
    .card-hover { transition: all .3s ease; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
    .card-hover:hover { transform: translateY(-2px); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
    .status-badge { padding: .5rem 1rem; border-radius: 9999px; font-size: .875rem; font-weight: 600; display: inline-flex; gap: .5rem; align-items:center; }
    .status-requested { background:#fef3c7; color:#92400e; }
    .btn-success { background: linear-gradient(135deg,#10b981 0%,#047857 100%); }
    .btn-danger { background: linear-gradient(135deg,#ef4444 0%,#dc2626 100%); }
    .coupon-deduction { background: linear-gradient(135deg,#fef2f2 0%,#fee2e2 100%); border-left:4px solid #ef4444; }
    
    /* Mobile overlay */
    @media (max-width: 1023px) {
      .mobile-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 40;
      }
      
      .mobile-overlay.active {
        display: block;
      }
      
      body.sidebar-open {
        overflow: hidden;
      }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">

  <!-- Mobile Overlay -->
  <div class="mobile-overlay lg:hidden" id="mobile-overlay"></div>

  <%- include('../partials/sidebar', { currentPage: 'returns' }) %>

  <main class="w-full lg:ml-64 flex-1 p-4 sm:p-6 lg:p-8 transition-all duration-300">
    <div class="mb-6 lg:mb-8">
      <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-4 lg:mb-6">
        <div class="flex-1">
          <div class="flex items-center justify-between mb-2">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">Return Requests Management</h1>
            <!-- Mobile menu button -->
            <button
              id="mobile-menu-button"
              class="lg:hidden p-2 rounded-lg bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors"
              aria-label="Toggle menu"
            >
              <i class="fas fa-bars text-lg"></i>
            </button>
          </div>
          <p class="text-gray-600 text-sm sm:text-base">Review and process customer return requests</p>
        </div>
      </div>

      <!-- Stats Cards -->
      <div class="grid grid-cols-2 xs:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 lg:gap-6 mb-6 lg:mb-8">
        <div class="bg-white rounded-xl p-4 sm:p-5 lg:p-6 card-hover border-l-4 border-blue-500">
          <div class="flex justify-between items-center">
            <div>
              <p class="text-xs sm:text-sm text-gray-500">Total Returns</p>
              <p class="text-xl sm:text-2xl font-bold text-gray-900">
                <% 
                  let totalReturns = 0;
                  orders.forEach(o => o.items.forEach(it => { if (it.status === 'return-requested') totalReturns++; }));
                %>
                <%= totalReturns %>
              </p>
            </div>
            <div class="bg-blue-100 p-2 sm:p-3 rounded-full">
              <i class="fas fa-undo text-blue-600 text-base sm:text-lg lg:text-xl"></i>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-xl p-4 sm:p-5 lg:p-6 card-hover border-l-4 border-yellow-500">
          <div class="flex justify-between items-center">
            <div>
              <p class="text-xs sm:text-sm text-gray-500">Pending Review</p>
              <p class="text-xl sm:text-2xl font-bold text-gray-900">
                <% 
                  let pendingReturns = 0;
                  orders.forEach(o => o.items.forEach(it => { if (it.status === 'return-requested') pendingReturns++; }));
                %>
                <%= pendingReturns %>
              </p>
            </div>
            <div class="bg-yellow-100 p-2 sm:p-3 rounded-full">
              <i class="fas fa-clock text-yellow-600 text-base sm:text-lg lg:text-xl"></i>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-xl p-4 sm:p-5 lg:p-6 card-hover border-l-4 border-green-500">
          <div class="flex justify-between items-center">
            <div>
              <p class="text-xs sm:text-sm text-gray-500">Approved</p>
              <p class="text-xl sm:text-2xl font-bold text-gray-900">
                <% 
                  let approvedReturns = 0;
                  orders.forEach(o => o.items.forEach(it => { if (it.status === 'returned') approvedReturns++; }));
                %>
                <%= approvedReturns %>
              </p>
            </div>
            <div class="bg-green-100 p-2 sm:p-3 rounded-full">
              <i class="fas fa-check-circle text-green-600 text-base sm:text-lg lg:text-xl"></i>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-xl p-4 sm:p-5 lg:p-6 card-hover border-l-4 border-red-500">
          <div class="flex justify-between items-center">
            <div>
              <p class="text-xs sm:text-sm text-gray-500">Rejected</p>
              <p class="text-xl sm:text-2xl font-bold text-gray-900">
                <% 
                  let rejectedReturns = 0;
                  orders.forEach(o => o.items.forEach(it => { if (it.status === 'return-rejected') rejectedReturns++; }));
                %>
                <%= rejectedReturns %>
              </p>
            </div>
            <div class="bg-red-100 p-2 sm:p-3 rounded-full">
              <i class="fas fa-times-circle text-red-600 text-base sm:text-lg lg:text-xl"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Return Requests List -->
    <div class="space-y-4 sm:space-y-6">
      <% if (!orders || orders.length === 0) { %>
        <div class="bg-white rounded-xl lg:rounded-2xl p-8 sm:p-10 lg:p-12 text-center card-hover">
          <div class="flex flex-col items-center justify-center text-gray-500">
            <i class="fas fa-undo text-4xl sm:text-5xl lg:text-6xl mb-3 sm:mb-4 text-gray-300"></i>
            <h2 class="text-lg sm:text-xl lg:text-2xl font-bold text-gray-700 mb-2">No Return Requests</h2>
            <p class="text-gray-600 text-sm sm:text-base mb-4 sm:mb-6">No pending return requests found at the moment.</p>
          </div>
        </div>
      <% } else { %>

        <% orders.forEach(order => { %>
          <% order.items.forEach(item => { 
               if (item.status !== 'return-requested') return;

               // server-side calculation (EJS) — keep in JS expression context
               const itemTotal = (item.price || 0) * (item.quantity || 0);

               // determine coupon share safely
               let couponShare = 0;
               if (order.coupon && typeof order.coupon.discountAmount === 'number' && order.coupon.discountAmount > 0) {
                 const baseSubtotal = (typeof order.coupon.subtotalBeforeCoupon === 'number' && order.coupon.subtotalBeforeCoupon > 0)
                                      ? order.coupon.subtotalBeforeCoupon
                                      : (order.subtotal || 0);
                 const itemShare = baseSubtotal > 0 ? itemTotal / baseSubtotal : 0;
                 couponShare = (order.coupon.discountAmount || 0) * itemShare;
               }

               const refundBase = Math.max(0, itemTotal - couponShare);
               const refundTax = refundBase * 0.10;
               const totalRefund = refundBase + refundTax;
          %>

            <div class="bg-white rounded-xl lg:rounded-2xl card-hover overflow-hidden">
              <button onclick="toggleReturn('<%= item._id %>')" class="w-full flex flex-col sm:flex-row justify-between items-start sm:items-center p-4 sm:p-6 text-left bg-gradient-to-r from-blue-50 to-indigo-50 hover:from-blue-100 hover:to-indigo-100 transition-all">
                <div class="flex items-start sm:items-center gap-3 sm:gap-4 w-full sm:w-auto">
                  <div class="flex-shrink-0">
                    <div class="w-10 h-10 sm:w-12 sm:h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                      <i class="fas fa-undo text-purple-600 text-sm sm:text-base"></i>
                    </div>
                  </div>
                  <div class="flex-1 min-w-0">
                    <h2 class="text-base sm:text-lg lg:text-xl font-bold text-gray-900 truncate">Return Request - Order #<%= order.orderId || order._id %></h2>
                    <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4 mt-1 sm:mt-2">
                      <span class="status-badge status-requested text-xs sm:text-sm"><i class="fas fa-clock"></i> Pending Review</span>
                      <p class="text-xs text-gray-600"><i class="far fa-calendar mr-1"></i> <%= item.returnRequestedDate ? new Date(item.returnRequestedDate).toLocaleDateString() : '—' %></p>
                    </div>
                  </div>
                </div>

                <div class="flex items-center justify-between sm:justify-end gap-3 w-full sm:w-auto mt-3 sm:mt-0">
                  <div class="text-right">
                    <p class="text-base sm:text-lg font-bold text-green-600">Refund: ₹<%= totalRefund.toFixed(2) %></p>
                    <% if (couponShare > 0) { %>
                      <p class="text-xs text-red-500 hidden sm:block">Coupon: -₹<%= couponShare.toFixed(2) %></p>
                    <% } %>
                  </div>
                  <i id="icon-<%= item._id %>" class="fas fa-chevron-down text-gray-600 text-lg sm:text-xl transition-transform"></i>
                </div>
              </button>

              <div id="details-<%= item._id %>" class="hidden border-t border-gray-200">
                <div class="p-4 sm:p-6 bg-gray-50">
                  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-5 lg:gap-6 mb-4 sm:mb-6">
                    <div class="bg-white rounded-xl p-4 sm:p-5 lg:p-6 card-hover">
                      <h3 class="text-base sm:text-lg font-bold text-gray-900 mb-3 sm:mb-4 flex items-center gap-2"><i class="fas fa-box text-blue-600"></i> Product Details</h3>
                      <div class="flex items-start gap-3 sm:gap-4">
                        <img src="<%= item.image || '/images/no-image.jpg' %>" alt="<%= item.product?.name || 'Product' %>" class="w-16 h-16 sm:w-20 sm:h-20 object-cover rounded-lg border border-gray-200">
                        <div class="flex-1 min-w-0">
                          <h4 class="font-semibold text-gray-900 text-sm sm:text-base mb-1 sm:mb-2 truncate"><%= item.product?.name || 'Product' %></h4>
                          <div class="space-y-1 text-xs sm:text-sm text-gray-600">
                            <p><strong>Color:</strong> <%= item.color || '—' %></p>
                            <p><strong>Quantity:</strong> <%= item.quantity %></p>
                            <p><strong>Unit Price:</strong> ₹<%= item.price %></p>
                            <p><strong>Item Total:</strong> ₹<%= itemTotal.toFixed(2) %></p>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="bg-white rounded-xl p-4 sm:p-5 lg:p-6 card-hover">
                      <h3 class="text-base sm:text-lg font-bold text-gray-900 mb-3 sm:mb-4 flex items-center gap-2"><i class="fas fa-clipboard-list text-orange-600"></i> Return Reason</h3>
                      <div class="space-y-3">
                        <div>
                          <p class="font-semibold text-gray-800 text-sm sm:text-base mb-1">Reason</p>
                          <p class="text-gray-700 bg-gray-50 p-3 rounded-lg text-sm"><%= item.returnReason || '—' %></p>
                        </div>
                        <% if (item.returnDetails) { %>
                          <div>
                            <p class="font-semibold text-gray-800 text-sm sm:text-base mb-1">Additional Details</p>
                            <p class="text-gray-600 text-xs sm:text-sm bg-gray-50 p-3 rounded-lg"><%= item.returnDetails %></p>
                          </div>
                        <% } %>
                      </div>
                    </div>

                    <div class="bg-white rounded-xl p-4 sm:p-5 lg:p-6 card-hover">
                      <h3 class="text-base sm:text-lg font-bold text-gray-900 mb-3 sm:mb-4 flex items-center gap-2"><i class="fas fa-user text-green-600"></i> Customer & Payment</h3>
                      <div class="space-y-3 sm:space-y-4">
                        <div>
                          <p class="font-semibold text-gray-800 text-sm sm:text-base mb-1">Customer Information</p>
                          <p class="text-gray-700 text-sm sm:text-base"><%= order.user?.name || 'User' %></p>
                          <p class="text-gray-600 text-xs sm:text-sm"><%= order.user?.email || '—' %></p>
                        </div>

                        <div>
                          <p class="font-semibold text-gray-800 text-sm sm:text-base mb-1">Shipping Address</p>
                          <p class="text-gray-600 text-xs sm:text-sm">
                            <%= order.shippingAddress?.fullName || '—' %><br>
                            <%= order.shippingAddress?.addressLine1 || '—' %><br>
                            <% if (order.shippingAddress?.addressLine2) { %><%= order.shippingAddress.addressLine2 %><br><% } %>
                            <%= order.shippingAddress?.city || '' %>, <%= order.shippingAddress?.state || '' %> - <%= order.shippingAddress?.pincode || '' %><br>
                            <strong>Phone:</strong> <%= order.shippingAddress?.phone || '—' %>
                          </p>
                        </div>

                        <div class="bg-gradient-to-br from-green-50 to-emerald-50 border border-green-200 rounded-lg p-3 sm:p-4">
                          <p class="font-bold text-green-800 text-base sm:text-lg text-center mb-2">Refund Calculation</p>
                          <div class="space-y-2 text-xs sm:text-sm">
                            <div class="flex justify-between">
                              <span class="text-gray-600">Item Value:</span>
                              <span class="font-medium">₹<%= itemTotal.toFixed(2) %></span>
                            </div>

                            <% if (couponShare > 0) { %>
                              <div class="flex justify-between">
                                <span class="text-red-600">Coupon Deduction:</span>
                                <span class="font-medium">-₹<%= couponShare.toFixed(2) %></span>
                              </div>

                              <div class="flex justify-between border-t border-green-200 pt-2">
                                <span class="text-gray-700">Refundable Amount:</span>
                                <span class="font-medium">₹<%= refundBase.toFixed(2) %></span>
                              </div>
                            <% } %>

                            <div class="flex justify-between">
                              <span class="text-gray-600">Tax (10%):</span>
                              <span class="font-medium">+₹<%= refundTax.toFixed(2) %></span>
                            </div>
<%
  // Check if this return will complete the full order
  const remainingItems = order.items.filter(i => i._id.toString() !== item._id.toString());
  const isLastReturn = remainingItems.every(i => i.status === 'returned');

  const shippingRefund = isLastReturn ? (order.shippingFee || 0) : 0;
  const totalRefundWithShipping = totalRefund + shippingRefund;
%>

<% if (isLastReturn && shippingRefund > 0) { %>
  <div class="flex justify-between">
    <span class="text-gray-600">Shipping Refund:</span>
    <span class="font-medium text-green-600">+₹<%= shippingRefund.toFixed(2) %></span>
  </div>
<% } %>

                            <div class="flex justify-between border-t border-green-300 pt-2 mt-2">
                              <span class="font-bold text-green-700">Total Refund:</span>
                              <span class="font-bold text-green-700 text-base sm:text-lg">₹<%= totalRefundWithShipping.toFixed(2) %></span>
                            </div>
                          </div>

                          <% if (order.coupon && order.coupon.code) { %>
                            <div class="mt-3 p-2 bg-yellow-50 border border-yellow-200 rounded text-center">
                              <p class="text-xs text-yellow-700">
                                <i class="fas fa-tag mr-1"></i>
                                Coupon Applied: <strong><%= order.coupon.code %></strong>
                                (<%= typeof order.coupon.discountValue === 'number' ? order.coupon.discountValue + '%' : (order.coupon.discountValue || '') %> off)
                              </p>
                            </div>
                          <% } %>

                          <p class="text-green-700 text-xs sm:text-sm text-center mt-3"><i class="fas fa-wallet mr-1"></i> Will be credited to user's wallet after approval</p>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 justify-center pt-4 border-t border-gray-200">
                    <button 
                      onclick="approveReturn(
                        '<%= order._id %>', 
                        '<%= item._id %>', 
                        '<%= (item.product?.name || "").replace(/'/g, '\\\'') %>', 
                        '<%= totalRefundWithShipping.toFixed(2) %>', 
                        '<%= refundBase.toFixed(2) %>',
                        '<%= refundTax.toFixed(2) %>',
                        '<%= couponShare.toFixed(2) %>',
                        '<%= shippingRefund.toFixed(2) %>'
                      )"
                      class="btn-success text-white px-4 sm:px-6 lg:px-8 py-2.5 sm:py-3 rounded-xl font-semibold flex items-center justify-center gap-2 sm:gap-3 text-sm sm:text-base order-2 sm:order-1">
                      <i class="fas fa-check-circle"></i> Approve Return & Refund
                    </button>

                    <button 
                      onclick="rejectReturn(
                        '<%= order._id %>', 
                        '<%= item._id %>', 
                        '<%= (item.product?.name || "").replace(/'/g, '\\\'') %>'
                      )" 
                      class="btn-danger text-white px-4 sm:px-6 lg:px-8 py-2.5 sm:py-3 rounded-xl font-semibold flex items-center justify-center gap-2 sm:gap-3 text-sm sm:text-base order-1 sm:order-2">
                      <i class="fas fa-times-circle"></i> Reject Return
                    </button>
                  </div>
                </div>
              </div>
            </div>

          <% }) %>
        <% }) %>
      <% } %>
    </div>
  </main>

  <!-- Sidebar Toggle Script -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const mobileMenuButton = document.getElementById('mobile-menu-button');
      const sidebar = document.getElementById('admin-sidebar');
      const overlay = document.getElementById('mobile-overlay');
      const body = document.body;

      function toggleSidebar() {
        sidebar.classList.toggle('-translate-x-full');
        overlay.classList.toggle('active');
        body.classList.toggle('sidebar-open');
      }

      function closeSidebar() {
        sidebar.classList.add('-translate-x-full');
        overlay.classList.remove('active');
        body.classList.remove('sidebar-open');
      }

      if (mobileMenuButton && sidebar && overlay) {
        mobileMenuButton.addEventListener('click', toggleSidebar);
        overlay.addEventListener('click', closeSidebar);
      }

      // Close sidebar when clicking on any link
      document.querySelectorAll('#admin-sidebar a').forEach(link => {
        link.addEventListener('click', () => {
          if (window.innerWidth < 1024) {
            closeSidebar();
          }
        });
      });

      // Close sidebar on escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && window.innerWidth < 1024) {
          closeSidebar();
        }
      });
    });
  </script>

  <script>
    function toggleReturn(id) {
      const box = document.getElementById("details-" + id);
      const icon = document.getElementById("icon-" + id);
      box.classList.toggle("hidden");
      if (box.classList.contains("hidden")) { icon.classList.remove("fa-chevron-up"); icon.classList.add("fa-chevron-down"); }
      else { icon.classList.remove("fa-chevron-down"); icon.classList.add("fa-chevron-up"); }
    }

    // Approve return with SweetAlert
    function approveReturn(orderId, itemId, productName, refundAmount, refundBase, refundTax, couponDeduction, shippingRefund)
    {
      const couponDeductionValue = parseFloat(couponDeduction) || 0;
      
      Swal.fire({
        title: 'Approve Return Request?',
        html: `
          <div class="text-left">
            <p class="mb-3 text-sm sm:text-base">Are you sure you want to approve the return request for:</p>
            <p class="font-bold text-gray-800 mb-4">${productName}</p>
            
            <div class="bg-gray-50 p-3 rounded-lg mb-4">
              <div class="grid grid-cols-2 gap-2 text-xs sm:text-sm">
                <div class="text-right text-gray-600">Refundable Amount:</div>
                <div class="text-left font-medium">₹${parseFloat(refundBase).toFixed(2)}</div>
                
                ${couponDeductionValue > 0 ? `
                  <div class="text-right text-red-600">Coupon Deduction:</div>
                  <div class="text-left font-medium">-₹${couponDeductionValue.toFixed(2)}</div>
                ` : ''}
                
                <div class="text-right text-gray-600">Tax (10%):</div>
                <div class="text-left font-medium">+₹${parseFloat(refundTax).toFixed(2)}</div>
                
                <div class="col-span-2 border-t border-gray-300 mt-2 pt-2">
                  <div class="flex justify-between font-bold text-green-700">
                    <span>Total Refund:</span>
                    <span>₹${parseFloat(refundAmount).toFixed(2)}</span>
                  </div>
                </div>
              </div>
            </div>
            
            <p class="text-xs sm:text-sm text-gray-600">This amount will be credited to the user's wallet.</p>
          </div>
        `,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#10b981',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Yes, Approve & Refund!',
        cancelButtonText: 'Cancel',
        showLoaderOnConfirm: true,
        preConfirm: async () => {
          try {
            const response = await fetch(`/admin/orders/returns/${orderId}/item/${itemId}/approve`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                refundAmount: parseFloat(refundAmount),
                refundBase: parseFloat(refundBase),
                refundTax: parseFloat(refundTax),
                couponDeduction: couponDeductionValue,
                shippingRefund: parseFloat(shippingRefund)
              })
            });
            
            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.message || 'Network response was not ok');
            }
            
            return await response.json();
          } catch (error) {
            Swal.showValidationMessage(`Request failed: ${error.message}`);
          }
        }
      }).then((result) => {
        if (result.isConfirmed) {
          Swal.fire({
            title: 'Return Approved!',
            html: `
              <div class="text-center">
                <p class="mb-3 text-sm sm:text-base">Return request has been approved successfully.</p>
                <div class="bg-green-50 p-3 rounded-lg inline-block">
                  <p class="text-green-700 font-semibold">Refund Amount: ₹${parseFloat(refundAmount).toFixed(2)}</p>
                  ${couponDeductionValue > 0 ? 
                    `<p class="text-xs sm:text-sm text-red-600">Coupon Deduction: ₹${couponDeductionValue.toFixed(2)}</p>` : ''}
                  <p class="text-xs sm:text-sm text-green-600">Credited to user's wallet</p>
                </div>
              </div>
            `,
            icon: 'success',
            confirmButtonColor: '#10b981',
            timer: 3000,
            showConfirmButton: false
          }).then(() => {
            location.reload();
          });
        }
      });
    }

    // Reject return with SweetAlert
    function rejectReturn(orderId, itemId, productName) {
      Swal.fire({
        title: 'Reject Return Request?',
        html: `
          <div class="text-left">
            <p class="mb-3 text-sm sm:text-base">Are you sure you want to reject the return request for:</p>
            <p class="font-bold text-gray-800">${productName}</p>
            <p class="text-red-600 font-semibold mt-2 text-sm sm:text-base">This action cannot be undone.</p>
          </div>
        `,
        icon: 'warning',
        input: 'text',
        inputLabel: 'Rejection Reason',
        inputPlaceholder: 'Enter reason for rejection...',
        inputValidator: (value) => {
          if (!value) return 'Please provide a rejection reason!';
        },
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Yes, Reject Return!',
        cancelButtonText: 'Cancel',
        showLoaderOnConfirm: true,
        preConfirm: async (rejectionReason) => {
          try {
            const response = await fetch(`/admin/orders/returns/${orderId}/item/${itemId}/reject`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json"
              },
              body: JSON.stringify({ rejectionReason })
            });

            if (!response.ok) {
              const err = await response.json().catch(() => ({}));
              throw new Error(err.message || "Failed to reject return");
            }

            return await response.json();
          } catch (error) {
            Swal.showValidationMessage(`Request failed: ${error.message}`);
          }
        }
      }).then((result) => {
        if (result.isConfirmed) {
          Swal.fire({
            title: 'Return Rejected!',
            text: 'Return request has been rejected successfully.',
            icon: 'success',
            timer: 2000,
            showConfirmButton: false
          }).then(() => {
            location.reload();
          });
        }
      });
    }

    // Show success message if redirected with success parameter
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('success') === 'true') {
      Swal.fire({
        title: 'Success!',
        text: 'Return request processed successfully.',
        icon: 'success',
        timer: 3000,
        showConfirmButton: false
      });
    }
  </script>
</body>
</html>