<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard | BagHub</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- FontAwesome -->
  <link rel="stylesheet" 
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    /* Base responsive styles */
    body {
      overflow-x: hidden;
    }
    
    .gradient-bg {
      background: linear-gradient(135deg, #1a56db 0%, #047857 100%);
    }
    
    .card-hover {
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    
    .card-hover:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    
    .stat-card {
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      border: 1px solid #e2e8f0;
    }
    
    .progress-gradient {
      background: linear-gradient(90deg, #3b82f6, #1d4ed8);
    }
    
    .status-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .table-row-hover:hover {
      background: linear-gradient(90deg, #f8fafc, #f1f5f9);
      transition: all 0.2s ease;
    }
    
    /* Sidebar responsive scrollbar */
    .sidebar {
      scrollbar-width: thin;
      scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
    }

    .sidebar::-webkit-scrollbar {
      width: 4px;
    }

    .sidebar::-webkit-scrollbar-track {
      background: transparent;
    }

    .sidebar::-webkit-scrollbar-thumb {
      background-color: rgba(255, 255, 255, 0.3);
      border-radius: 20px;
    }

    .sidebar::-webkit-scrollbar-thumb:hover {
      background-color: rgba(255, 255, 255, 0.5);
    }

    /* Mobile overlay */
    @media (max-width: 1023px) {
      .sidebar-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 30;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }
      
      .sidebar-overlay.active {
        opacity: 1;
        visibility: visible;
      }
      
      /* Prevent body scroll when sidebar is open */
      body.sidebar-open {
        overflow: hidden;
      }
    }
  </style>
</head>
<body class="bg-gray-50 flex font-sans min-h-screen">

<!-- Mobile Overlay -->
<div id="sidebar-overlay" class="sidebar-overlay lg:hidden" onclick="closeSidebar()"></div>

<%- include('../partials/sidebar', { currentPage: 'dashboard' }) %>

  <!-- Main Content -->
  <main class="flex-1 w-full p-4 lg:p-6 xl:p-8 lg:ml-64 min-h-screen transition-all duration-300">
    <!-- Dashboard Header -->
    <div class="flex flex-col gap-4 lg:flex-row lg:justify-between lg:items-center mb-6 lg:mb-8">
      <div class="flex-1">
        <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-1 lg:mb-2">Dashboard Overview</h1>
        <p class="text-sm sm:text-base text-gray-600">Welcome back, Admin! Here's what's happening with your store today.</p>
      </div>
      
      <div class="flex items-center justify-between lg:justify-end gap-3">
        <!-- Mobile menu button -->
        <button
          id="mobile-menu-button"
          class="lg:hidden p-2 rounded-lg bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors"
          aria-label="Toggle menu"
          onclick="toggleSidebar()"
        >
          <i class="fas fa-bars text-lg"></i>
        </button>

        <div class="w-10 h-10 sm:w-11 sm:h-11 bg-gradient-to-r from-blue-500 to-emerald-500 rounded-full flex items-center justify-center shadow-md">
          <span class="text-white font-semibold text-sm">A</span>
        </div>
      </div>
    </div>

    <!-- Stats Grid - Responsive -->
    <div class="grid grid-cols-1 xs:grid-cols-2 lg:grid-cols-2 xl:grid-cols-4 gap-4 sm:gap-5 lg:gap-6 mb-6 lg:mb-8">
      <!-- Total Revenue Card -->
      <div class="stat-card rounded-xl lg:rounded-2xl p-4 sm:p-5 lg:p-6 card-hover border-l-4 border-blue-500">
        <div class="flex items-center justify-between mb-3 lg:mb-4">
          <div class="w-10 h-10 sm:w-12 sm:h-12 bg-blue-100 rounded-lg lg:rounded-xl flex items-center justify-center">
            <i class="fas fa-rupee-sign text-blue-600 text-base sm:text-lg"></i>
          </div>
          <div>
            <% if (revenueGrowth && typeof revenueGrowth.percent !== 'undefined') { %>
              <span class="inline-flex items-center text-xs sm:text-sm font-semibold rounded-full px-2 py-1 sm:px-3 sm:py-1 <%= revenueGrowth.isUp ? 'text-green-600 bg-green-50' : 'text-red-600 bg-red-50' %>">
                <i class="fas <%= revenueGrowth.isUp ? 'fa-arrow-up' : 'fa-arrow-down' %> mr-1"></i>
                <%= Math.abs(revenueGrowth.percent) %>%
              </span>
            <% } %>
          </div>
        </div>

        <h3 class="text-xl sm:text-2xl font-bold text-gray-800 mb-1">₹<%= totalRevenue %></h3>
        <p class="text-gray-600 text-sm">Total Revenue</p>
        <p class="text-gray-400 text-xs sm:text-sm mt-1 lg:mt-2">
          <% if (ordersThisMonth) { %>
            +₹<%= totalRevenue %> this month
          <% } else { %>
            No sales this month
          <% } %>
        </p>
      </div>

      <!-- Customers Card -->
      <div class="stat-card rounded-xl lg:rounded-2xl p-4 sm:p-5 lg:p-6 card-hover border-l-4 border-green-500">
        <div class="flex items-center justify-between mb-3 lg:mb-4">
          <div class="w-10 h-10 sm:w-12 sm:h-12 bg-green-100 rounded-lg lg:rounded-xl flex items-center justify-center">
            <i class="fas fa-users text-green-600 text-base sm:text-lg"></i>
          </div>
          <% if (customersGrowth && typeof customersGrowth.percent !== 'undefined') { %>
            <span class="inline-flex items-center text-xs sm:text-sm font-semibold rounded-full px-2 py-1 sm:px-3 sm:py-1 <%= customersGrowth.isUp ? 'text-green-600 bg-green-50' : 'text-red-600 bg-red-50' %>">
              <i class="fas <%= customersGrowth.isUp ? 'fa-arrow-up' : 'fa-arrow-down' %> mr-1"></i>
              <%= Math.abs(customersGrowth.percent) %>%
            </span>
          <% } %>
        </div>

        <h3 class="text-xl sm:text-2xl font-bold text-gray-800 mb-1"><%= totalCustomers %></h3>
        <p class="text-gray-600 text-sm">Total Customers</p>
        <p class="text-gray-400 text-xs sm:text-sm mt-1 lg:mt-2">
          +<%= customersThisMonth %> this month
        </p>
      </div>

      <!-- Orders Card -->
      <div class="stat-card rounded-xl lg:rounded-2xl p-4 sm:p-5 lg:p-6 card-hover border-l-4 border-purple-500">
        <div class="flex items-center justify-between mb-3 lg:mb-4">
          <div class="w-10 h-10 sm:w-12 sm:h-12 bg-purple-100 rounded-lg lg:rounded-xl flex items-center justify-center">
            <i class="fas fa-shopping-cart text-purple-600 text-base sm:text-lg"></i>
          </div>
          <% if (ordersGrowth && typeof ordersGrowth.percent !== 'undefined') { %>
            <span class="inline-flex items-center text-xs sm:text-sm font-semibold rounded-full px-2 py-1 sm:px-3 sm:py-1 <%= ordersGrowth.isUp ? 'text-green-600 bg-green-50' : 'text-red-600 bg-red-50' %>">
              <i class="fas <%= ordersGrowth.isUp ? 'fa-arrow-up' : 'fa-arrow-down' %> mr-1"></i>
              <%= Math.abs(ordersGrowth.percent) %>%
            </span>
          <% } %>
        </div>

        <h3 class="text-xl sm:text-2xl font-bold text-gray-800 mb-1"><%= totalOrders %></h3>
        <p class="text-gray-600 text-sm">Total Orders</p>
        <p class="text-gray-400 text-xs sm:text-sm mt-1 lg:mt-2">+<%= ordersThisWeek %> this week</p>
      </div>

      <!-- Progress Card -->
      <div class="stat-card rounded-xl lg:rounded-2xl p-4 sm:p-5 lg:p-6 card-hover border-l-4 border-orange-500">
        <div class="flex items-center justify-between mb-3 lg:mb-4">
          <div class="w-10 h-10 sm:w-12 sm:h-12 bg-orange-100 rounded-lg lg:rounded-xl flex items-center justify-center">
            <i class="fas fa-target text-orange-600 text-base sm:text-lg"></i>
          </div>
          <span class="text-blue-500 text-xs sm:text-sm font-semibold"><%= monthlyProgress %>%</span>
        </div>

        <h3 class="text-xl sm:text-2xl font-bold text-gray-800 mb-1">Monthly Goal</h3>
        <p class="text-gray-600 text-sm">1,000 Orders</p>

        <div class="w-full bg-gray-200 rounded-full h-2 mt-2 lg:mt-3 overflow-hidden">
          <div class="progress-gradient h-2" style="width: <%= monthlyProgress %>%"></div>
        </div>

        <p class="text-gray-400 text-xs sm:text-sm mt-1 lg:mt-2"><%= ordersLeft %> orders to reach target</p>
      </div>
    </div>

    <!-- Charts and Best Sellers Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-5 sm:gap-6 lg:gap-8 mb-6 lg:mb-8">
      <!-- Revenue Analytics -->
      <div class="bg-white rounded-xl lg:rounded-2xl shadow-lg p-4 sm:p-5 lg:p-6 card-hover">
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 lg:mb-6 gap-3">
          <h3 class="text-lg sm:text-xl font-semibold text-gray-800">Revenue Analytics</h3>

          <select id="chartFilter" 
            class="text-sm border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full sm:w-auto">
            <option value="daily">Daily</option>
            <option value="weekly">Weekly</option>
            <option value="monthly">Monthly</option>
            <option value="yearly">Yearly</option>
          </select>
        </div>

        <div id="revenueBars" class="bg-gradient-to-b from-blue-50 to-white rounded-xl p-4 h-48 sm:h-56 lg:h-64 flex items-end justify-between gap-1 sm:gap-2">
          <!-- Dynamic bars will be injected here -->
        </div>

        <div id="revenueLabels" class="flex justify-between text-xs text-gray-500 mt-3 sm:mt-4 px-1">
          <!-- Day/Month labels will be injected here -->
        </div>
      </div>

      <!-- Best Selling Products -->
      <div class="bg-white rounded-xl lg:rounded-2xl shadow-lg p-4 sm:p-5 lg:p-6 card-hover">
        <div class="flex justify-between items-center mb-4 lg:mb-6">
          <h3 class="text-lg sm:text-xl font-semibold text-gray-800">Top 10 Best Selling Products</h3>
        </div>

        <% if (bestProducts && bestProducts.length > 0) { %>
          <div class="space-y-3 sm:space-y-4 max-h-72 sm:max-h-80 lg:max-h-96 overflow-y-auto pr-2">
            <% bestProducts.forEach((item, index) => { %>
              <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 p-3 sm:p-4 bg-gradient-to-r from-gray-50 to-white rounded-lg lg:rounded-xl hover:shadow-md transition-all">
                <div class="flex items-center gap-3 sm:gap-4">
                  <div class="w-10 h-10 sm:w-12 sm:h-12 bg-blue-100 rounded-lg flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-bag-shopping text-blue-600 text-sm sm:text-base"></i>
                  </div>
                  <div class="min-w-0 flex-1">
                    <h4 class="font-semibold text-gray-800 text-sm sm:text-base truncate"><%= item.productName %></h4>
                    <p class="text-xs sm:text-sm text-gray-600 truncate"><%= item.categoryName %></p>
                  </div>
                </div>
                <div class="text-right mt-2 sm:mt-0">
                  <p class="font-bold text-gray-800 text-sm sm:text-base">₹<%= item.totalRevenue %></p>
                  <p class="text-xs sm:text-sm text-green-600"><%= item.unitsSold %> units sold</p>
                </div>
              </div>
            <% }) %>
          </div>
        <% } else { %>
          <p class="text-gray-500 text-center py-8">No data available</p>
        <% } %>
      </div>
    </div>

    <!-- Top Categories Section -->
    <div class="bg-white rounded-xl lg:rounded-2xl shadow-lg p-4 sm:p-5 lg:p-6 card-hover mb-6 lg:mb-8">
      <h3 class="text-lg sm:text-xl font-semibold text-gray-800 mb-4 lg:mb-6">Top 10 Categories</h3>

      <% if (bestCategories && bestCategories.length > 0) { %>
        <div class="space-y-2 sm:space-y-3">
          <% bestCategories.forEach(c => { %>
            <div class="p-3 rounded-lg bg-gray-50 flex justify-between items-center hover:bg-gray-100 transition-colors">
              <span class="font-medium text-gray-800 text-sm sm:text-base truncate pr-2"><%= c.category %></span>
              <span class="text-green-600 font-semibold text-sm sm:text-base whitespace-nowrap bg-green-50 px-3 py-1 rounded-full">
                <%= c.totalSold %> sold
              </span>
            </div>
          <% }) %>
        </div>
      <% } else { %>
        <p class="text-gray-500 text-center py-8">No data available</p>
      <% } %>
    </div>

    <!-- Recent Orders Section -->
    <div class="bg-white rounded-xl lg:rounded-2xl shadow-lg p-4 sm:p-5 lg:p-6 card-hover">
      <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 lg:mb-6 gap-3">
        <h3 class="text-lg sm:text-xl font-semibold text-gray-800">Recent Orders</h3>
        <a href="/admin/orders"
          class="inline-flex items-center justify-center gap-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white px-4 py-2.5 rounded-lg 
                font-semibold hover:from-blue-600 hover:to-blue-700 transition-all text-sm sm:text-base w-full sm:w-auto">
          <i class="fas fa-eye"></i>
          <span>View All Orders</span>
        </a>
      </div>

      <!-- DESKTOP TABLE (lg and above) -->
      <div class="hidden lg:block overflow-x-auto rounded-lg border border-gray-200">
        <table class="w-full text-sm">
          <thead class="bg-gray-50">
            <tr class="text-xs uppercase text-gray-600">
              <th class="p-4 text-left">Product</th>
              <th class="p-4 text-left">Order ID</th>
              <th class="p-4 text-left">Date</th>
              <th class="p-4 text-left">Customer</th>
              <th class="p-4 text-left">Amount</th>
              <th class="p-4 text-left">Status</th>
            </tr>
          </thead>

          <tbody class="divide-y divide-gray-200">
            <% recentOrders.forEach(order => { %>
              <% const item = order.items[0]; %>
              <tr class="table-row-hover hover:bg-gray-50">
                <td class="p-4"><%= item.product?.name || "Unknown" %></td>
                <td class="p-4 font-mono text-xs"><%= order.orderId %></td>
                <td class="p-4"><%= order.createdAt.toDateString() %></td>
                <td class="p-4"><%= order.user?.name || "Guest" %></td>
                <td class="p-4 font-semibold">₹<%= order.totalAmount.toFixed(2) %></td>
                <td class="p-4">
                  <span class="status-badge <%= getStatusClass(order.orderStatus) %>">
                    <%= order.orderStatus %>
                  </span>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>

      <!-- MOBILE & TABLET VIEW (below lg) -->
      <div class="lg:hidden space-y-3 sm:space-y-4">
        <% recentOrders.forEach(order => { %>
          <% const item = order.items[0]; %>

          <div class="border border-gray-200 rounded-xl p-4 bg-gray-50 hover:bg-gray-100 transition-colors">
            <div class="flex justify-between items-start mb-3">
              <div class="flex-1 min-w-0">
                <h4 class="font-semibold text-gray-800 text-sm sm:text-base truncate">
                  <%= item.product?.name || "Unknown Product" %>
                </h4>
                <p class="text-xs text-gray-600 mt-1">Order ID: <span class="font-mono"><%= order.orderId %></span></p>
              </div>
              <span class="status-badge text-xs <%= getStatusClass(order.orderStatus) %> whitespace-nowrap ml-2">
                <%= order.orderStatus %>
              </span>
            </div>

            <div class="grid grid-cols-2 gap-3 text-sm">
              <div>
                <p class="text-xs text-gray-500">Date</p>
                <p class="text-gray-700 font-medium"><%= order.createdAt.toDateString() %></p>
              </div>
              <div>
                <p class="text-xs text-gray-500">Customer</p>
                <p class="text-gray-700 font-medium truncate"><%= order.user?.name || "Guest" %></p>
              </div>
              <div class="col-span-2">
                <p class="text-xs text-gray-500">Amount</p>
                <p class="text-gray-800 font-bold text-lg">₹<%= order.totalAmount.toFixed(2) %></p>
              </div>
            </div>
          </div>
        <% }) %>
      </div>
    </div>
  </main>

  <script>
    // Sidebar functions
    function toggleSidebar() {
      const sidebar = document.getElementById('admin-sidebar');
      const overlay = document.getElementById('sidebar-overlay');
      const body = document.body;
      
      sidebar.classList.toggle('-translate-x-full');
      overlay.classList.toggle('active');
      body.classList.toggle('sidebar-open');
    }
    
    function closeSidebar() {
      const sidebar = document.getElementById('admin-sidebar');
      const overlay = document.getElementById('sidebar-overlay');
      const body = document.body;
      
      sidebar.classList.add('-translate-x-full');
      overlay.classList.remove('active');
      body.classList.remove('sidebar-open');
    }
    
    // Close sidebar when clicking on any link inside
    document.addEventListener('DOMContentLoaded', function() {
      const sidebarLinks = document.querySelectorAll('#admin-sidebar a');
      sidebarLinks.forEach(link => {
        link.addEventListener('click', () => {
          if (window.innerWidth < 1024) {
            closeSidebar();
          }
        });
      });
      
      // Close sidebar on escape key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          closeSidebar();
        }
      });
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const barColors = [
        "from-blue-500 to-blue-300",
        "from-green-500 to-green-300",
        "from-purple-500 to-purple-300",
        "from-orange-500 to-orange-300",
        "from-red-500 to-red-300",
        "from-indigo-500 to-indigo-300",
        "from-pink-500 to-pink-300"
      ];

      async function loadRevenue(filter = "daily") {
        try {
          const res = await fetch(`/admin/revenue-data?filter=${filter}`);
          let data = await res.json();

          const revenueBars = document.getElementById("revenueBars");
          const revenueLabels = document.getElementById("revenueLabels");

          revenueBars.innerHTML = "";
          revenueLabels.innerHTML = "";

          // Always show 7 bars for consistent layout
          while (data.values.length < 7) {
            data.values.push(0);
            data.labels.push("");
          }

          const maxValue = Math.max(...data.values);

          data.values.forEach((value, i) => {
            const heightPercent = maxValue === 0 ? 10 : (value / maxValue) * 100;
            const barWidth = window.innerWidth < 640 ? 'w-6 sm:w-8' : 'w-8 lg:w-10';

            const bar = `
              <div class="${barWidth} bg-gradient-to-t ${barColors[i % 7]} rounded-t-lg transition-all duration-500"
                   style="height: ${heightPercent}%"></div>
            `;
            const label = `<span class="text-xs truncate transform rotate-45 origin-top-left sm:rotate-0">${data.labels[i] || ""}</span>`;

            revenueBars.innerHTML += bar;
            revenueLabels.innerHTML += label;
          });
        } catch (error) {
          console.error('Error loading revenue data:', error);
        }
      }

      // Default load
      loadRevenue("daily");

      document.getElementById("chartFilter").addEventListener("change", (e) => {
        loadRevenue(e.target.value);
      });
      
      // Reload chart on window resize
      let resizeTimer;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
          const currentFilter = document.getElementById("chartFilter").value;
          loadRevenue(currentFilter);
        }, 250);
      });
    });

    // Handle page reload on back/forward
    window.onpageshow = function (event) {
      if (event.persisted) {
        window.location.reload();
      }
    };
  </script>

  <script>
function toggleSidebar() {
  const sidebar = document.getElementById("admin-sidebar");
  const overlay = document.getElementById("sidebar-overlay");

  sidebar.classList.toggle("-translate-x-full");
  overlay.classList.toggle("hidden");
}

function closeSidebar() {
  const sidebar = document.getElementById("admin-sidebar");
  const overlay = document.getElementById("sidebar-overlay");

  sidebar.classList.add("-translate-x-full");
  overlay.classList.add("hidden");
}

// Auto close on link click (mobile)
document.querySelectorAll("#admin-sidebar a").forEach(link => {
  link.addEventListener("click", () => {
    if (window.innerWidth < 768) closeSidebar();
  });
});
</script>


  <%
    function getStatusClass(status) {
      const map = {
        "pending": "bg-yellow-100 text-yellow-800",
        "processing": "bg-blue-100 text-blue-800",
        "shipped": "bg-purple-100 text-purple-800",
        "out_for_delivery": "bg-pink-100 text-pink-800",
        "delivered": "bg-green-100 text-green-800",
        "cancelled": "bg-red-100 text-red-800",
      };
      return map[status] || "bg-gray-100 text-gray-600";
    }
  %>
</body>
</html>