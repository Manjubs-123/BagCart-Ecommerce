<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Edit Offer | Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <style>
    /* Responsive styles */
    .type-card {
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .type-card:hover {
      border-color: #3b82f6;
      background-color: #f8fafc;
    }
    
    .type-card.selected {
      border-color: #3b82f6;
      background-color: #eff6ff;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .dropdown-container {
      position: relative;
    }
    
    .dropdown-options {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 300px;
      overflow-y: auto;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      z-index: 50;
      margin-top: 4px;
    }
    
    .dropdown-option {
      padding: 12px 16px;
      cursor: pointer;
      transition: background-color 0.2s;
      border-bottom: 1px solid #f3f4f6;
    }
    
    .dropdown-option:last-child {
      border-bottom: none;
    }
    
    .dropdown-option:hover {
      background-color: #f3f4f6;
    }
    
    .dropdown-option.selected {
      background-color: #eff6ff;
    }
    
    .selected-items {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      max-height: 200px;
      overflow-y: auto;
      padding: 8px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      background-color: #f9fafb;
    }
    
    .selected-item {
      display: inline-flex;
      align-items: center;
      padding: 6px 12px;
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 20px;
      font-size: 14px;
      gap: 6px;
      max-width: 100%;
    }
    
    .selected-item span {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 200px;
    }
    
    /* Mobile overlay */
    @media (max-width: 1023px) {
      .mobile-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 40;
      }
      
      .mobile-overlay.active {
        display: block;
      }
      
      body.sidebar-open {
        overflow: hidden;
      }
    }
    
    /* Validation styles */
    .input-error {
      border-color: #ef4444 !important;
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
    }
    
    .input-success {
      border-color: #10b981 !important;
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1) !important;
    }
    
    /* Toggle switch */
    .toggle-checkbox:checked + .toggle-label .toggle-dot {
      transform: translateX(100%);
      background-color: #3b82f6;
    }
    
    .toggle-checkbox:checked + .toggle-label {
      background-color: #3b82f6;
    }
    
    /* Responsive adjustments */
    @media (max-width: 640px) {
      .selected-item span {
        max-width: 120px;
      }
      
      .dropdown-options {
        max-height: 250px;
      }
    }
    
    @media (max-width: 768px) {
      .type-card {
        padding: 0.75rem;
      }
      
      .selected-items {
        max-height: 150px;
      }
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">

<!-- Mobile Overlay -->
<div class="mobile-overlay lg:hidden" id="mobile-overlay"></div>

<%- include('../partials/sidebar', { currentPage: 'offers' }) %>

  <main class="ml-0 lg:ml-64 flex-1 p-4 sm:p-6 transition-all duration-300">
    <div class="mb-6 lg:mb-8">
      <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 sm:gap-4 mb-2">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-xl sm:text-2xl lg:text-3xl font-bold">Edit Offer</h1>
            <p class="text-gray-600 text-sm sm:text-base">Update offer details</p>
          </div>
          <!-- Mobile menu button -->
          <button
            id="mobile-menu-button"
            class="lg:hidden p-2 rounded-lg bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors ml-2"
            aria-label="Toggle menu"
          >
            <i class="fas fa-bars text-lg"></i>
          </button>
        </div>
        <a href="/admin/offers" class="px-3 sm:px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 inline-flex items-center justify-center sm:justify-start text-sm sm:text-base mt-2 sm:mt-0">
          <i class="fas fa-arrow-left mr-2"></i> Back to Offers
        </a>
      </div>
    </div>

    <div class="max-w-2xl mx-auto">
      <form id="offerForm">
        <div class="bg-white rounded-xl p-4 sm:p-6 mb-6 shadow-sm">
          <h2 class="text-lg font-semibold mb-4">Select Offer Type</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
            <div class="type-card" id="productType" onclick="selectType('product')">
              <div class="flex items-center">
                <div class="w-8 h-8 sm:w-10 sm:h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-2 sm:mr-3 flex-shrink-0">
                  <i class="fas fa-box text-blue-600 text-sm sm:text-base"></i>
                </div>
                <div class="min-w-0">
                  <h3 class="font-medium text-sm sm:text-base">Product Offer</h3>
                  <p class="text-xs text-gray-500 truncate">Apply to specific products</p>
                </div>
              </div>
            </div>
            <div class="type-card" id="categoryType" onclick="selectType('category')">
              <div class="flex items-center">
                <div class="w-8 h-8 sm:w-10 sm:h-10 bg-green-100 rounded-lg flex items-center justify-center mr-2 sm:mr-3 flex-shrink-0">
                  <i class="fas fa-layer-group text-green-600 text-sm sm:text-base"></i>
                </div>
                <div class="min-w-0">
                  <h3 class="font-medium text-sm sm:text-base">Category Offer</h3>
                  <p class="text-xs text-gray-500 truncate">Apply to categories</p>
                </div>
              </div>
            </div>
          </div>
          <input type="hidden" id="offerType" name="type" value="<%= offer.type %>">
        </div>

        <div class="bg-white rounded-xl p-4 sm:p-6 shadow-sm">
          <!-- Offer Name -->
          <div class="mb-4">
            <label class="text-sm font-medium">Offer Name *</label>
            <input id="nameInput" name="name" type="text" required
                   class="w-full px-3 sm:px-4 py-2.5 sm:py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm sm:text-base" 
                   value="<%= offer.name %>">
            <div id="nameErrorMessage" class="text-red-500 text-xs mt-1 hidden"></div>
          </div>

          <!-- Discount -->
          <div class="mb-4">
            <label class="text-sm font-medium">Discount Percentage *</label>
            <div class="relative">
              <input id="discountInput" name="discountValue" type="number" min="5" max="90" required
                     class="w-full px-3 sm:px-4 py-2.5 sm:py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent pl-10 sm:pl-12 text-sm sm:text-base"
                     value="<%= offer.discountValue %>">
              <span class="absolute left-3 sm:left-4 top-2.5 sm:top-3 text-gray-500">%</span>
            </div>
            <div id="discountErrorMessage" class="text-red-500 text-xs mt-1 hidden"></div>
          </div>

          <!-- Dates -->
          <div class="mb-4 grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
            <div>
              <label class="text-xs text-gray-600">Start Date & Time</label>
              <input id="fromInput" name="validFrom" type="datetime-local" 
                     class="w-full px-3 sm:px-4 py-2.5 sm:py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm sm:text-base"
                     value="<%= new Date(offer.validFrom).toISOString().slice(0,16) %>">
            </div>
            <div>
              <label class="text-xs text-gray-600">End Date & Time</label>
              <input id="toInput" name="validTo" type="datetime-local" 
                     class="w-full px-3 sm:px-4 py-2.5 sm:py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm sm:text-base"
                     value="<%= new Date(offer.validTo).toISOString().slice(0,16) %>">
            </div>
          </div>
          <div id="dateErrorMessage" class="text-red-500 text-xs mb-4 hidden"></div>

          <!-- Product selection -->
          <div id="productSelection" class="mb-4">
            <label class="text-sm font-medium">Select Products *</label>
            <div class="dropdown-container mb-3">
              <div class="relative">
                <input id="productSearch" type="text" placeholder="Search products..." 
                       class="w-full px-3 sm:px-4 py-2.5 sm:py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm sm:text-base" 
                       onfocus="showProductDropdown()" oninput="searchProducts()">
                <i class="fas fa-chevron-down absolute right-3 sm:right-4 top-2.5 sm:top-3.5 text-gray-400 text-sm"></i>
                <div id="productDropdown" class="dropdown-options">
                  <div id="productLoading" class="p-3 sm:p-4 text-center text-sm"><i class="fas fa-spinner fa-spin mr-2"></i>Loading...</div>
                  <div id="productList"></div>
                </div>
              </div>
            </div>

            <div class="flex justify-between items-center mb-2">
              <span class="text-sm text-gray-600">Selected Products (<span id="productCount">0</span>)</span>
              <button type="button" id="clearProductsBtn" onclick="clearAllProducts()" 
                      class="text-xs text-red-600 hover:text-red-800 disabled:opacity-50 disabled:cursor-not-allowed" disabled>Clear All</button>
            </div>
            <div id="selectedProducts" class="selected-items"></div>
            <input type="hidden" id="productsInput" name="products" value="<%= (offer.products || []).map(p => p._id).join(',') %>">
            <div id="productErrorMessage" class="text-red-500 text-xs mt-1 hidden">Please select at least one product</div>
          </div>

          <!-- Category selection -->
          <div id="categorySelection" class="mb-4 hidden">
            <label class="text-sm font-medium">Select Categories *</label>
            <div class="dropdown-container mb-3">
              <div class="relative">
                <input id="categorySearch" type="text" placeholder="Search categories..." 
                       class="w-full px-3 sm:px-4 py-2.5 sm:py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm sm:text-base" 
                       onfocus="showCategoryDropdown()" oninput="searchCategories()">
                <i class="fas fa-chevron-down absolute right-3 sm:right-4 top-2.5 sm:top-3.5 text-gray-400 text-sm"></i>
                <div id="categoryDropdown" class="dropdown-options">
                  <div id="categoryLoading" class="p-3 sm:p-4 text-center text-sm"><i class="fas fa-spinner fa-spin mr-2"></i>Loading...</div>
                  <div id="categoryList"></div>
                </div>
              </div>
            </div>

            <div class="flex justify-between items-center mb-2">
              <span class="text-sm text-gray-600">Selected Categories (<span id="categoryCount">0</span>)</span>
              <button type="button" id="clearCategoriesBtn" onclick="clearAllCategories()" 
                      class="text-xs text-red-600 hover:text-red-800 disabled:opacity-50 disabled:cursor-not-allowed" disabled>Clear All</button>
            </div>
            <div id="selectedCategories" class="selected-items"></div>
            <input type="hidden" id="categoriesInput" name="categories" value="<%= (offer.categories || []).map(c => c._id).join(',') %>">
            <div id="categoryErrorMessage" class="text-red-500 text-xs mt-1 hidden">Please select at least one category</div>
          </div>

          <!-- Active toggle -->
          <div class="mt-6">
            <label class="flex items-center cursor-pointer">
              <input id="activeCheckbox" name="isActive" type="checkbox" class="sr-only toggle-checkbox" <%= offer.isActive ? 'checked' : '' %>>
              <div class="toggle-label relative inline-flex items-center h-6 rounded-full w-11 bg-gray-300 transition-colors duration-300">
                <div class="toggle-dot inline-block w-4 h-4 transform bg-white rounded-full transition-transform duration-300 absolute left-1"></div>
              </div>
              <span class="ml-3 text-sm font-medium">Activate offer</span>
            </label>
          </div>

          <div class="mt-6">
            <button id="submitBtn" type="button" 
                    class="w-full sm:w-auto px-6 sm:px-8 py-2.5 sm:py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center text-sm sm:text-base">
              <i class="fas fa-save mr-2"></i> Update Offer
            </button>
          </div>
        </div>
      </form>
    </div>
  </main>

<!-- Sidebar Toggle Script -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const sidebar = document.getElementById('admin-sidebar');
        const overlay = document.getElementById('mobile-overlay');
        const body = document.body;

        function toggleSidebar() {
            sidebar.classList.toggle('-translate-x-full');
            overlay.classList.toggle('active');
            body.classList.toggle('sidebar-open');
        }

        function closeSidebar() {
            sidebar.classList.add('-translate-x-full');
            overlay.classList.remove('active');
            body.classList.remove('sidebar-open');
        }

        if (mobileMenuButton && sidebar && overlay) {
            mobileMenuButton.addEventListener('click', toggleSidebar);
            overlay.addEventListener('click', closeSidebar);
        }

        // Close sidebar when clicking on any link
        document.querySelectorAll('#admin-sidebar a').forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth < 1024) {
                    closeSidebar();
                }
            });
        });

        // Close sidebar on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && window.innerWidth < 1024) {
                closeSidebar();
            }
        });
    });
</script>

<script>
/* =========================================
   GLOBAL VARIABLES AND INITIALIZATION
   ========================================= */

// Get server data
const serverProducts = <%- JSON.stringify(offer.products || []) %>;
const serverCategories = <%- JSON.stringify(offer.categories || []) %>;

// Initialize sets from server data
let selectedProducts = new Set();
let selectedCategories = new Set();
let currentOfferType = "<%= offer.type %>";
let productsLoaded = false;
let categoriesLoaded = false;

// Initialize selections from server data
serverProducts.forEach(p => {
    if (p && p._id) {
        selectedProducts.add(p._id.toString());
    }
});

serverCategories.forEach(c => {
    if (c && c._id) {
        selectedCategories.add(c._id.toString());
    }
});

document.addEventListener("DOMContentLoaded", function () {
    /* ---------------------------
       Force UI to select type
       --------------------------- */
    selectType(currentOfferType);

    /* ---------------------------
        Initialize hidden inputs with server data
       --------------------------- */
    document.getElementById("productsInput").value = [...selectedProducts].join(",");
    document.getElementById("categoriesInput").value = [...selectedCategories].join(",");

    /* ---------------------------
        Display selected PRODUCTS
       --------------------------- */
    const pContainer = document.getElementById("selectedProducts");
    const pCount = document.getElementById("productCount");
    const pClear = document.getElementById("clearProductsBtn");

    pContainer.innerHTML = "";
    
    selectedProducts.forEach(id => {
        const product = serverProducts.find(p => p._id.toString() === id.toString());
        const name = product ? product.name : id;

        const div = document.createElement("div");
        div.className = "selected-item";
        div.dataset.id = id;
        div.innerHTML = `
            <span>${name}</span>
            <button type="button" onclick="removeProduct('${id}')" class="text-red-500 hover:text-red-700 ml-2">
                <i class="fas fa-times"></i>
            </button>
        `;
        pContainer.appendChild(div);
    });

    pCount.textContent = selectedProducts.size;
    pClear.disabled = selectedProducts.size === 0;

    /* ---------------------------
       Display selected CATEGORIES
       --------------------------- */
    const cContainer = document.getElementById("selectedCategories");
    const cCount = document.getElementById("categoryCount");
    const cClear = document.getElementById("clearCategoriesBtn");

    cContainer.innerHTML = "";
    
    selectedCategories.forEach(id => {
        const category = serverCategories.find(c => c._id.toString() === id.toString());
        const name = category ? category.name : id;

        const div = document.createElement("div");
        div.className = "selected-item";
        div.dataset.id = id;
        div.innerHTML = `
            <span>${name}</span>
            <button type="button" onclick="removeCategory('${id}')" class="text-red-500 hover:text-red-700 ml-2">
                <i class="fas fa-times"></i>
            </button>
        `;
        cContainer.appendChild(div);
    });

    cCount.textContent = selectedCategories.size;
    cClear.disabled = selectedCategories.size === 0;

    /* ---------------------------
        Initialize toggle switch
       --------------------------- */
    const checkbox = document.getElementById('activeCheckbox');
    const toggleLabel = checkbox.nextElementSibling;
    const toggleDot = toggleLabel.querySelector('.toggle-dot');
    
    // Set initial state based on server data
    if (checkbox.checked) {
        toggleLabel.style.backgroundColor = '#3b82f6';
        toggleDot.style.transform = 'translateX(125%)';
    }
    
    checkbox.addEventListener('change', function() {
        if (this.checked) {
            toggleLabel.style.backgroundColor = '#3b82f6';
            toggleDot.style.transform = 'translateX(125%)';
        } else {
            toggleLabel.style.backgroundColor = '#d1d5db';
            toggleDot.style.transform = 'translateX(0)';
        }
    });

    /* ---------------------------
        Set minimum dates and validation
       --------------------------- */
    const now = new Date();
    const today = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
    document.querySelector('input[name="validFrom"]').min = today;
    document.querySelector('input[name="validTo"]').min = today;

    // Initial validation - IMPORTANT: Call this LAST
    setTimeout(() => {
        validateForm();
    }, 100);
    
    /* ---------------------------
     Setup submit button - FIXED
       --------------------------- */
    const submitBtn = document.getElementById('submitBtn');
    // Remove any existing listeners first
    submitBtn.removeEventListener('click', submitForm);
    submitBtn.addEventListener('click', submitForm);
    
    // Ensure button is always visible and has basic styling
    submitBtn.style.display = 'flex';
    submitBtn.style.visibility = 'visible';
    submitBtn.style.opacity = '1';
    
    /* ---------------------------
        Setup real-time validation
       --------------------------- */
    const nameInput = document.querySelector('input[name="name"]');
    const discountInput = document.querySelector('input[name="discountValue"]');
    const fromInput = document.querySelector('input[name="validFrom"]');
    const toInput = document.querySelector('input[name="validTo"]');
    
    if (nameInput) {
        nameInput.addEventListener('input', function() {
            validateName(this);
            validateForm();
        });
    }
    
    if (discountInput) {
        discountInput.addEventListener('input', function() {
            validateDiscount(this);
            validateForm();
        });
    }
    
    if (fromInput) {
        fromInput.addEventListener('change', function() {
            validateDates();
            validateForm();
        });
    }
    
    if (toInput) {
        toInput.addEventListener('change', function() {
            validateDates();
            validateForm();
        });
    }
    
    // Also add validation when typing in dates
    if (fromInput) {
        fromInput.addEventListener('input', function() {
            validateDates();
            validateForm();
        });
    }
    
    if (toInput) {
        toInput.addEventListener('input', function() {
            validateDates();
            validateForm();
        });
    }
});

// ===========================================
// UTILITY FUNCTIONS
// ===========================================
function showError(elementId, message) {
    const element = document.getElementById(elementId);
    if (element) {
        element.textContent = message;
        element.style.display = 'block';
    }
}

function hideError(elementId) {
    const element = document.getElementById(elementId);
    if (element) {
        element.style.display = 'none';
    }
}

function showValidation(input, isValid, successIcon, errorIcon) {
    // Skip if elements don't exist
    if (!input) return;
    
    const success = document.getElementById(successIcon);
    const error = document.getElementById(errorIcon);
    
    if (isValid) {
        input.classList.remove('border-red-500', 'input-error');
        input.classList.add('border-green-500', 'input-success');
        if (success) success.style.display = 'block';
        if (error) error.style.display = 'none';
    } else {
        input.classList.remove('border-green-500', 'input-success');
        input.classList.add('border-red-500', 'input-error');
        if (success) success.style.display = 'none';
        if (error) error.style.display = 'block';
    }
}

function validateForm() {
    const nameInput = document.querySelector('input[name="name"]');
    const discountInput = document.querySelector('input[name="discountValue"]');
    
    const nameValid = validateName(nameInput);
    const discountValid = validateDiscount(discountInput);
    const dateValid = validateDates();

    const selectionValid = currentOfferType === 'product'
        ? selectedProducts.size > 0
        : selectedCategories.size > 0;

    const submitBtn = document.getElementById('submitBtn');
    if (!submitBtn) {
        console.error("Submit button not found!");
        return false;
    }
    
    const allValid = nameValid && discountValid && dateValid && selectionValid;
    
    // Update button state
    submitBtn.disabled = !allValid;
    
    // Update button styling
    if (allValid) {
        submitBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
        submitBtn.classList.add('bg-blue-600', 'hover:bg-blue-700', 'cursor-pointer');
    } else {
        submitBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'cursor-pointer');
        submitBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
    }

    return allValid;
}

// ===========================================
// OFFER TYPE SWITCH
// ===========================================
function selectType(type) {
    currentOfferType = type;
    const offerTypeInput = document.getElementById("offerType");
    if (offerTypeInput) {
        offerTypeInput.value = type;
    }

    // Update UI for selected type
    const productTypeCard = document.getElementById("productType");
    const categoryTypeCard = document.getElementById("categoryType");
    const productSelection = document.getElementById("productSelection");
    const categorySelection = document.getElementById("categorySelection");
    
    if (productTypeCard) productTypeCard.classList.remove("selected");
    if (categoryTypeCard) categoryTypeCard.classList.remove("selected");

    if (type === "product") {
        if (productSelection) productSelection.classList.remove("hidden");
        if (categorySelection) categorySelection.classList.add("hidden");
        if (productTypeCard) productTypeCard.classList.add("selected");
        
        // Validate product selection
        if (selectedProducts.size === 0) {
            showError('productErrorMessage', 'Please select at least one product');
        } else {
            hideError('productErrorMessage');
        }
        hideError('categoryErrorMessage');
    } else {
        if (categorySelection) categorySelection.classList.remove("hidden");
        if (productSelection) productSelection.classList.add("hidden");
        if (categoryTypeCard) categoryTypeCard.classList.add("selected");
        
        // Validate category selection
        if (selectedCategories.size === 0) {
            showError('categoryErrorMessage', 'Please select at least one category');
        } else {
            hideError('categoryErrorMessage');
        }
        hideError('productErrorMessage');
    }
    
    validateForm();
}

// ===========================================
// FIELD VALIDATIONS
// ===========================================
function validateName(input) {
    if (!input) return false;
    
    const value = input.value.trim();
    const isValid = value.length >= 3 && value.length <= 100;

    showValidation(input, isValid, 'nameSuccess', 'nameError');

    if (!isValid && value.length > 0) {
        showError('nameErrorMessage',
            value.length < 3 ? 'Offer name must be at least 3 characters' :
            'Offer name cannot exceed 100 characters'
        );
    } else {
        hideError('nameErrorMessage');
    }

    return isValid;
}

function validateDiscount(input) {
    if (!input) return false;
    
    const value = parseInt(input.value) || 0;
    const isValid = value >= 5 && value <= 90;

    showValidation(input, isValid, 'discountSuccess', 'discountError');

    if (!isValid && input.value) {
        showError('discountErrorMessage',
            value < 5 ? 'Discount must be at least 5%' : 'Discount cannot exceed 90%'
        );
    } else {
        hideError('discountErrorMessage');
    }

    return isValid;
}

function validateDates() {
    const fromInput = document.querySelector('input[name="validFrom"]');
    const toInput = document.querySelector('input[name="validTo"]');
    
    if (!fromInput || !toInput) return false;
    
    const from = new Date(fromInput.value);
    const to = new Date(toInput.value);
    const now = new Date();

    let fromValid = fromInput.value !== '' && from > now;
    let toValid = toInput.value !== '' && to > from;

    showValidation(fromInput, fromValid, 'fromSuccess', 'fromError');
    showValidation(toInput, toValid, 'toSuccess', 'toError');

    if (!fromValid && fromInput.value) {
        showError('dateErrorMessage', 'Start date must be in the future');
    } else if (!toValid && toInput.value) {
        showError('dateErrorMessage', 'End date must be after start date');
    } else {
        hideError('dateErrorMessage');
    }

    return fromValid && toValid;
}

// ===========================================
// PRODUCT SELECTION FUNCTIONS (same as before)
// ===========================================
function showProductDropdown() {
    const dropdown = document.getElementById("productDropdown");
    if (!dropdown) return;
    
    dropdown.style.display = "block";
    
    if (!productsLoaded) {
        loadProducts();
        productsLoaded = true;
    }
    
    document.addEventListener('click', closeProductDropdownOnOutsideClick);
}

function closeProductDropdownOnOutsideClick(event) {
    const dropdown = document.getElementById("productDropdown");
    const searchInput = document.getElementById("productSearch");
    
    if (!dropdown || !searchInput) return;
    
    if (!dropdown.contains(event.target) && !searchInput.contains(event.target)) {
        dropdown.style.display = "none";
        document.removeEventListener('click', closeProductDropdownOnOutsideClick);
    }
}

function loadProducts(search = "") {
    const loading = document.getElementById("productLoading");
    const list = document.getElementById("productList");
    
    if (!loading || !list) return;
    
    loading.style.display = "block";
    list.innerHTML = "";
    
    axios.get(`/admin/offers/products?search=${encodeURIComponent(search)}`)
        .then(res => {
            loading.style.display = "none";
            
            if (res.data.products && res.data.products.length > 0) {
                res.data.products.forEach(p => {
                    const isSelected = selectedProducts.has(p._id.toString());
                    
                    const div = document.createElement("div");
                    div.className = `dropdown-option ${isSelected ? "selected" : ""}`;
                    div.dataset.id = p._id;
                    div.innerHTML = `
                        <div class="flex items-center justify-between w-full">
                            <div class="flex items-center gap-2 sm:gap-3">
                                ${p.image ? `<img src="${p.image}" alt="${p.name}" class="w-6 h-6 sm:w-8 sm:h-8 object-cover rounded flex-shrink-0">` : ''}
                                <div class="min-w-0">
                                    <div class="font-medium text-gray-900 text-sm sm:text-base truncate">${p.name}</div>
                                    <div class="text-xs text-gray-500">â‚¹${p.price}</div>
                                </div>
                            </div>
                            ${isSelected ? '<i class="fas fa-check text-blue-500 text-sm sm:text-base"></i>' : ''}
                        </div>
                    `;
                    
                    div.onclick = (e) => {
                        e.stopPropagation();
                        toggleProduct(p._id, p.name);
                    };
                    
                    list.appendChild(div);
                });
            } else {
                list.innerHTML = `<div class="p-4 text-center text-gray-500">No products found</div>`;
            }
        })
        .catch(err => {
            console.error("Error loading products:", err);
            if (loading) loading.style.display = "none";
            list.innerHTML = `<div class="p-4 text-center text-red-500">Error loading products</div>`;
        });
}

function searchProducts() {
    const search = document.getElementById("productSearch").value;
    loadProducts(search);
}

function toggleProduct(id, name) {
    const idStr = id.toString();
    
    if (selectedProducts.has(idStr)) {
        selectedProducts.delete(idStr);
        removeProduct(idStr);
    } else {
        selectedProducts.add(idStr);
        addProduct(idStr, name);
    }
    
    updateProductUI(idStr);
    updateProductsInput();
    validateForm();
}

function addProduct(id, name) {
    const container = document.getElementById("selectedProducts");
    if (!container) return;
    
    // Check if already added
    if (document.querySelector(`#selectedProducts [data-id="${id}"]`)) {
        return;
    }
    
    const div = document.createElement("div");
    div.className = "selected-item";
    div.dataset.id = id;
    div.innerHTML = `
        <span class="truncate">${name}</span>
        <button type="button" onclick="removeProduct('${id}')" 
                class="text-red-500 hover:text-red-700 ml-2 flex-shrink-0">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    container.appendChild(div);
    updateProductSelectionState();
}

function removeProduct(id) {
    selectedProducts.delete(id);
    
    const item = document.querySelector(`#selectedProducts [data-id="${id}"]`);
    if (item) item.remove();
    
    updateProductUI(id);
    updateProductsInput();
    validateForm();
}

function updateProductUI(id) {
    const option = document.querySelector(`#productList .dropdown-option[data-id="${id}"]`);
    if (option) {
        const isSelected = selectedProducts.has(id);
        option.classList.toggle("selected", isSelected);
        
        const checkIcon = option.querySelector('.fa-check');
        if (isSelected && !checkIcon) {
            option.querySelector('.flex').innerHTML += '<i class="fas fa-check text-blue-500"></i>';
        } else if (!isSelected && checkIcon) {
            checkIcon.remove();
        }
    }
    
    updateProductSelectionState();
}

function updateProductSelectionState() {
    const count = selectedProducts.size;
    const countElement = document.getElementById("productCount");
    const clearBtn = document.getElementById("clearProductsBtn");
    
    if (countElement) countElement.textContent = count;
    if (clearBtn) clearBtn.disabled = count === 0;
    
    if (currentOfferType === 'product') {
        if (count === 0) {
            showError('productErrorMessage', 'Please select at least one product');
        } else {
            hideError('productErrorMessage');
        }
    }
}

function clearAllProducts() {
    if (selectedProducts.size === 0) return;
    
    Swal.fire({
        title: 'Clear all selected products?',
        text: 'This will remove all selected products',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc2626',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Yes, clear all',
        cancelButtonText: 'Cancel'
    }).then((result) => {
        if (result.isConfirmed) {
            selectedProducts.clear();
            const container = document.getElementById("selectedProducts");
            if (container) container.innerHTML = "";
            
            document.querySelectorAll('#productList .dropdown-option').forEach(option => {
                option.classList.remove("selected");
                const checkIcon = option.querySelector('.fa-check');
                if (checkIcon) checkIcon.remove();
            });
            
            updateProductSelectionState();
            updateProductsInput();
            validateForm();
        }
    });
}

function updateProductsInput() {
    const input = document.getElementById("productsInput");
    if (input) {
        input.value = [...selectedProducts].join(",");
    }
}

// ===========================================
// CATEGORY SELECTION FUNCTIONS (same as before)
// ===========================================
function showCategoryDropdown() {
    const dropdown = document.getElementById("categoryDropdown");
    if (!dropdown) return;
    
    dropdown.style.display = "block";
    
    if (!categoriesLoaded) {
        loadCategories();
        categoriesLoaded = true;
    }
    
    document.addEventListener('click', closeCategoryDropdownOnOutsideClick);
}

function closeCategoryDropdownOnOutsideClick(event) {
    const dropdown = document.getElementById("categoryDropdown");
    const searchInput = document.getElementById("categorySearch");
    
    if (!dropdown || !searchInput) return;
    
    if (!dropdown.contains(event.target) && !searchInput.contains(event.target)) {
        dropdown.style.display = "none";
        document.removeEventListener('click', closeCategoryDropdownOnOutsideClick);
    }
}

function loadCategories(search = "") {
    const loading = document.getElementById("categoryLoading");
    const list = document.getElementById("categoryList");
    
    if (!loading || !list) return;
    
    loading.style.display = "block";
    list.innerHTML = "";
    
    axios.get(`/admin/offers/categories?search=${encodeURIComponent(search)}`)
        .then(res => {
            loading.style.display = "none";
            
            if (res.data.categories && res.data.categories.length > 0) {
                res.data.categories.forEach(c => {
                    const isSelected = selectedCategories.has(c._id.toString());
                    
                    const div = document.createElement("div");
                    div.className = `dropdown-option ${isSelected ? "selected" : ""}`;
                    div.dataset.id = c._id;
                    div.innerHTML = `
                        <div class="flex items-center justify-between w-full">
                            <div class="font-medium text-gray-900 text-sm sm:text-base truncate">${c.name}</div>
                            ${isSelected ? '<i class="fas fa-check text-blue-500 text-sm sm:text-base"></i>' : ''}
                        </div>
                    `;
                    
                    div.onclick = (e) => {
                        e.stopPropagation();
                        toggleCategory(c._id, c.name);
                    };
                    
                    list.appendChild(div);
                });
            } else {
                list.innerHTML = `<div class="p-4 text-center text-gray-500">No categories found</div>`;
            }
        })
        .catch(err => {
            console.error("Error loading categories:", err);
            if (loading) loading.style.display = "none";
            list.innerHTML = `<div class="p-4 text-center text-red-500">Error loading categories</div>`;
        });
}

function searchCategories() {
    const search = document.getElementById("categorySearch").value;
    loadCategories(search);
}

function toggleCategory(id, name) {
    const idStr = id.toString();
    
    if (selectedCategories.has(idStr)) {
        selectedCategories.delete(idStr);
        removeCategory(idStr);
    } else {
        selectedCategories.add(idStr);
        addCategory(idStr, name);
    }
    
    updateCategoryUI(idStr);
    updateCategoriesInput();
    validateForm();
}

function addCategory(id, name) {
    const container = document.getElementById("selectedCategories");
    if (!container) return;
    
    // Check if already added
    if (document.querySelector(`#selectedCategories [data-id="${id}"]`)) {
        return;
    }
    
    const div = document.createElement("div");
    div.className = "selected-item";
    div.dataset.id = id;
    div.innerHTML = `
        <span class="truncate">${name}</span>
        <button type="button" onclick="removeCategory('${id}')" 
                class="text-red-500 hover:text-red-700 ml-2 flex-shrink-0">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    container.appendChild(div);
    updateCategorySelectionState();
}

function removeCategory(id) {
    selectedCategories.delete(id);
    
    const item = document.querySelector(`#selectedCategories [data-id="${id}"]`);
    if (item) item.remove();
    
    updateCategoryUI(id);
    updateCategoriesInput();
    validateForm();
}

function updateCategoryUI(id) {
    const option = document.querySelector(`#categoryList .dropdown-option[data-id="${id}"]`);
    if (option) {
        const isSelected = selectedCategories.has(id);
        option.classList.toggle("selected", isSelected);
        
        const checkIcon = option.querySelector('.fa-check');
        if (isSelected && !checkIcon) {
            option.querySelector('.flex').innerHTML += '<i class="fas fa-check text-blue-500"></i>';
        } else if (!isSelected && checkIcon) {
            checkIcon.remove();
        }
    }
    
    updateCategorySelectionState();
}

function updateCategorySelectionState() {
    const count = selectedCategories.size;
    const countElement = document.getElementById("categoryCount");
    const clearBtn = document.getElementById("clearCategoriesBtn");
    
    if (countElement) countElement.textContent = count;
    if (clearBtn) clearBtn.disabled = count === 0;
    
    if (currentOfferType === 'category') {
        if (count === 0) {
            showError('categoryErrorMessage', 'Please select at least one category');
        } else {
            hideError('categoryErrorMessage');
        }
    }
}

function clearAllCategories() {
    if (selectedCategories.size === 0) return;
    
    Swal.fire({
        title: 'Clear all selected categories?',
        text: 'This will remove all selected categories',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc2626',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Yes, clear all',
        cancelButtonText: 'Cancel'
    }).then((result) => {
        if (result.isConfirmed) {
            selectedCategories.clear();
            const container = document.getElementById("selectedCategories");
            if (container) container.innerHTML = "";
            
            document.querySelectorAll('#categoryList .dropdown-option').forEach(option => {
                option.classList.remove("selected");
                const checkIcon = option.querySelector('.fa-check');
                if (checkIcon) checkIcon.remove();
            });
            
            updateCategorySelectionState();
            updateCategoriesInput();
            validateForm();
        }
    });
}

function updateCategoriesInput() {
    const input = document.getElementById("categoriesInput");
    if (input) {
        input.value = [...selectedCategories].join(",");
    }
}

// ===========================================
// FORM SUBMISSION - PATCH REQUEST
// ===========================================
function submitForm(e) {
    if (e) e.preventDefault();
    
    // Get the submit button
    const submitBtn = document.getElementById('submitBtn');
    if (submitBtn && submitBtn.disabled) {
        Swal.fire("Error", "Please fix all validation errors before submitting", "error");
        return;
    }
    
    // Final validation
    const nameInput = document.querySelector('input[name="name"]');
    const discountInput = document.querySelector('input[name="discountValue"]');
    
    const nameValid = validateName(nameInput);
    const discountValid = validateDiscount(discountInput);
    const dateValid = validateDates();
    
    if (!nameValid || !discountValid || !dateValid) {
        Swal.fire("Error", "Please fix all validation errors before submitting", "error");
        return;
    }
    
    if (currentOfferType === "product" && selectedProducts.size === 0) {
        Swal.fire("Error", "Please select at least one product", "error");
        return;
    }
    
    if (currentOfferType === "category" && selectedCategories.size === 0) {
        Swal.fire("Error", "Please select at least one category", "error");
        return;
    }
    
    // Show loading
    Swal.fire({
        title: "Updating Offer...",
        text: "Please wait while we update your offer",
        allowOutsideClick: false,
        showConfirmButton: false,
        willOpen: () => {
            Swal.showLoading();
        }
    });
    
    // Get the offer ID from the server
    const offerId = '<%= offer._id %>';
    
    // Prepare the data for PATCH request
    const updateData = {
        name: nameInput.value.trim(),
        type: currentOfferType,
        discountValue: parseInt(discountInput.value),
        validFrom: document.querySelector('input[name="validFrom"]').value,
        validTo: document.querySelector('input[name="validTo"]').value,
        isActive: document.getElementById('activeCheckbox').checked
    };
    
    // Add products or categories based on type
    if (currentOfferType === 'product') {
        updateData.products = [...selectedProducts];
        updateData.categories = [];
    } else {
        updateData.categories = [...selectedCategories];
        updateData.products = [];
    }
    
    console.log("Sending PATCH request to:", `/admin/offers/${offerId}`);
    console.log("Data:", updateData);
    
    // Send PATCH request
    axios.patch(`/admin/offers/${offerId}`, updateData)
        .then(response => {
            Swal.fire({
                title: "Success!",
                text: "Offer updated successfully",
                icon: "success",
                confirmButtonColor: "#10b981",
                confirmButtonText: "View Offers"
            }).then(() => {
                window.location.href = "/admin/offers";
            });
        })
        .catch(err => {
            console.error("Update error:", err);
            let errorMessage = "Failed to update offer. Please try again.";
            
            if (err.response) {
                console.error("Response error:", err.response.data);
                errorMessage = err.response.data.message || errorMessage;
            }
            
            Swal.fire({
                title: "Error!",
                text: errorMessage,
                icon: "error",
                confirmButtonColor: "#dc2626"
            });
        });
}
</script>
</body>
</html>